<!doctype html>
<html lang="en" translate="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>ID Photo / Passport | ConvertFiles24</title>
  <meta name="description" content="Create ID and passport photos online. Adjust, crop and download instantly. 100% local processing (no server upload)." />
  <meta name="robots" content="index,follow" />
  <meta name="theme-color" content="#0b0f17" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Noto+Sans+KR:wght@400;500;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --radius:16px;
      --pad:16px;
      --border:1px solid rgba(255,255,255,.12);
      --blue: 47,109,246;
      --ease: cubic-bezier(.2,.8,.2,1);

      /* soft blue */
      --softBlueBg: rgba(120, 200, 255, .06);
      --softBlueBd: rgba(120, 200, 255, .22);
      --softBlueTx: #cfe6ff;
      --softBlueHi: rgba(120, 200, 255, .12);
    }
    *{ box-sizing:border-box; }

    html, body{ width:100%; max-width:100%; overflow-x:hidden; }

    body{
      margin:0;
      font-family: Inter, "Noto Sans KR", system-ui, -apple-system, "Segoe UI", Roboto, "Apple SD Gothic Neo", sans-serif;
      background:#0b0f17;
      color:#e9eef7;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: geometricPrecision;
    }

    /* entrance */
    body:not(.loaded) .card,
    body:not(.loaded) .top{
      opacity:0;
      transform: translateY(8px);
    }
    body.loaded .top{ animation: cfFadeUp .35s var(--ease) both; }
    body.loaded .card{ animation: cfFadeUp .38s var(--ease) both; }
    body.loaded .card:nth-of-type(1){ animation-delay: .02s; }
    body.loaded .card:nth-of-type(2){ animation-delay: .04s; }
    body.loaded .card:nth-of-type(3){ animation-delay: .06s; }
    body.loaded .card:nth-of-type(4){ animation-delay: .08s; }
    @keyframes cfFadeUp{
      from{ opacity:0; transform: translateY(8px); }
      to{ opacity:1; transform: translateY(0); }
    }
    @media (prefers-reduced-motion: reduce){
      *{ animation:none !important; transition:none !important; scroll-behavior:auto !important; }
      body:not(.loaded) .card,
      body:not(.loaded) .top{ opacity:1; transform:none; }
    }

    .wrap{
      max-width:980px;
      width:100%;
      margin:0 auto;
      padding:22px 14px 44px;
      overflow-x: clip;
    }

    .top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
      margin-bottom:14px;
      min-width:0;
    }

    .title{
      margin:0;
      font-weight:900;
      letter-spacing:-0.35px;
      line-height:1.15;
      color:#ffffff;
      font-size:22px;
    }
    .sub{
      margin:8px 0 0;
      color:#a7b3c7;
      font-size:13px;
      line-height:1.45;
    }

    .homeBtn{
      width:100%;
      display:flex; align-items:center; justify-content:center; gap:10px;
      padding:12px 14px;
      border-radius:999px;
      border:1px solid rgba(47,109,246,.55);
      background:rgba(47,109,246,.18);
      color:#e9eef7;
      font-weight:900;
      cursor:pointer;
      text-decoration:none;
      user-select:none;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
      max-width:380px;
      transition: transform .08s var(--ease), background .12s var(--ease), box-shadow .12s var(--ease);
    }
    .homeBtn:hover{ background:rgba(47,109,246,.24); }
    .homeBtn:active{ transform: scale(.99); }
    .homeBtn:focus-visible{
      outline:none;
      box-shadow: 0 0 0 3px rgba(var(--blue),.35), 0 10px 24px rgba(0,0,0,.25);
    }

    .langRow{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:8px;
      min-width:220px;
      max-width:100%;
      margin-left:auto;
    }
    .langLabel{
      font-size:12px;
      font-weight:900;
      color:#9fb0ca;
      letter-spacing:-0.2px;
      display:flex;
      align-items:center;
      gap:8px;
      opacity:.95;
    }
    .langSelect{
      width:220px;
      max-width:100%;
      padding:12px 12px;
      border-radius:999px;
      border:var(--border);
      background:rgba(255,255,255,.06);
      color:#e9eef7;
      outline:none;
      font-weight:900;
      transition: box-shadow .12s var(--ease), border-color .12s var(--ease), transform .08s var(--ease);
    }
    .langSelect:focus-visible{
      outline:none;
      border-color: rgba(var(--blue), .55);
      box-shadow: 0 0 0 3px rgba(var(--blue),.25);
    }
    option{ background:#0b0f17; color:#e9eef7; }
    @media (max-width: 420px){
      .langRow{ min-width:180px; }
      .langSelect{ width:180px; }
    }

    /* pill */
    .pill{
      width:100%;
      border:1px solid rgba(120, 200, 255, .22);
      background:rgba(120, 200, 255, .06);
      border-radius:999px;
      padding:10px 14px;
      color:#cfe6ff;
      font-size:13px;
      font-weight:900;
      display:flex; align-items:center; justify-content:center; gap:10px;
      min-width:0;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
    }
    /* make ğŸ›¡ pop */
    .pill .shield{
      font-size:16px;
      line-height:1;
      filter: drop-shadow(0 10px 16px rgba(0,0,0,.32)) drop-shadow(0 0 10px rgba(120,200,255,.20));
      transform: translateY(-.5px);
    }

    .card{
      border:var(--border);
      background:rgba(255,255,255,.03);
      border-radius:var(--radius);
      padding:var(--pad);
      margin-top:12px;
      min-width:0;
      max-width:100%;
      overflow-x: clip;
      will-change: transform, opacity;
    }
    .card h2{ margin:0 0 10px; font-size:15px; color:#dbe7ff; letter-spacing:-0.2px; }

    /* Controls header row */
    .cardHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin:0 0 10px;
    }
    .cardHead h2{ margin:0; }
    .headActions{
      display:flex;
      align-items:center;
      gap:12px; /* spaced more so not mis-tapped */
      margin-left:auto;
    }

    /* icon circle buttons */
    .iconCircle{
      width:40px;
      height:40px;
      border-radius:999px;
      border:none;
      background: rgba(255,255,255,.06);
      color:#cfe6ff;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.05), 0 10px 18px rgba(0,0,0,.22);
      transition: transform .08s var(--ease), background .12s var(--ease), box-shadow .12s var(--ease), opacity .12s var(--ease);
      padding:0;
    }
    .iconCircle:hover{ background: rgba(255,255,255,.08); }
    .iconCircle:active{ transform: scale(.96); }
    .iconCircle:disabled{ opacity:.35; cursor:not-allowed; transform:none; box-shadow:none; }
    .iconCircle:focus-visible{
      outline:none;
      box-shadow: 0 0 0 3px rgba(var(--blue),.28), inset 0 0 0 1px rgba(255,255,255,.05), 0 10px 18px rgba(0,0,0,.22);
    }
    .iconCircle svg{ width:20px; height:20px; display:block; }
    #undoBtn svg{ width:21px; height:21px; }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      min-width:0;
    }
    .row > *{
      flex:1;
      min-width:160px;
      max-width:100%;
      min-width:0;
    }

    .btn{
      appearance:none; border:none; cursor:pointer;
      background:#2f6df6; color:white; font-weight:900;
      padding:12px 14px; border-radius:14px; width:100%;
      font-size:14px;
      letter-spacing: -0.2px;
      user-select:none;
      transition: transform .08s var(--ease), filter .12s var(--ease), box-shadow .12s var(--ease), background .12s var(--ease);
    }

    .btn.secondary{
      background: var(--softBlueBg);
      border: 1px solid var(--softBlueBd);
      color: var(--softBlueTx);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
    }
    .btn.secondary:hover{ background: var(--softBlueHi); }

    .btn:hover{ filter: brightness(1.03); }
    .btn:active{ transform: scale(.99); }
    .btn:focus-visible{
      outline:none;
      box-shadow: 0 0 0 3px rgba(var(--blue),.25);
    }

    /* disabled text NOT blurry */
    .btn:disabled{
      opacity:1;
      cursor:not-allowed;
      transform:none;
      box-shadow:none;
      filter: saturate(.7);
      background: linear-gradient(180deg, rgba(47,109,246,.40), rgba(47,109,246,.30));
      color:#ffffff;
    }
    .btn.secondary:disabled{
      filter: none;
      background: rgba(120, 200, 255, .05);
      border: 1px solid rgba(120, 200, 255, .16);
      color: rgba(207, 230, 255, .70);
      box-shadow:none;
    }

    .drop{
      border:1px dashed rgba(255,255,255,.18);
      border-radius:14px; padding:18px;
      background:rgba(255,255,255,.02);
      text-align:center;
      cursor:pointer;
      user-select:none;
      transition: background .15s var(--ease), border-color .15s var(--ease), box-shadow .15s var(--ease), transform .05s var(--ease);
      position: relative;
      min-height: 180px;
      display:flex; align-items:center; justify-content:center;
      max-width:100%;
      overflow:hidden;
    }
    .drop.drag{ background:rgba(106,169,255,.12); border-color:rgba(106,169,255,.45); box-shadow: 0 0 0 3px rgba(106,169,255,.10) inset; }
    .drop:active{ transform: scale(0.998); }
    .drop:focus-visible{
      outline:none;
      box-shadow: 0 0 0 3px rgba(var(--blue),.25);
    }
    .dropEmoji{
      font-size:42px;
      line-height:1;
      margin:10px 0 8px;
      filter: drop-shadow(0 10px 22px rgba(0,0,0,.28));
    }
    .hint{ margin-top:10px; color:#9fb0ca; font-size:12px; line-height:1.5; }
    .small{ color:#a7b3c7; font-size:12px; line-height:1.5; }

    /* segmented */
    .seg{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      min-width:0;
      max-width:100%;
    }
    .segBtn{
      border:var(--border);
      background:rgba(255,255,255,.04);
      color:#b8c6dc;
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:900;
      font-size:12px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      white-space:nowrap;
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
      transition: background .12s var(--ease), border-color .12s var(--ease), box-shadow .12s var(--ease), transform .05s var(--ease);
    }
    .segBtn:hover{ background:rgba(255,255,255,.06); }
    .segBtn:active{ transform: scale(.99); }
    .segBtn:focus-visible{
      outline:none;
      box-shadow: 0 0 0 3px rgba(var(--blue),.22);
    }
    .segBtn.active{
      color:#eef5ff;
      background:rgba(var(--blue), .18);
      border-color:rgba(var(--blue), .55);
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.06),
        0 8px 18px rgba(0,0,0,.22),
        0 0 0 2px rgba(var(--blue), .10);
    }

    /* toggles tighter */
    #togglesSeg{ gap:6px !important; }
    #togglesSeg .segBtn{ padding:9px 11px; }

    /* print segs */
    #printSeg{ gap:8px; }
    #sheetSeg{ gap:8px; }
    #sheetWrap{ display:none; }
    #sheetWrap.show{ display:block; }

    /* stage */
    .stageWrap{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:12px;
      min-width:0;
      max-width:100%;
    }
    @media (max-width: 860px){ .stageWrap{ grid-template-columns: 1fr; } }

    .stage{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.25);
      border-radius:16px;
      overflow:hidden;
      position:relative;
      aspect-ratio: 4 / 3;
      min-height: 320px;
      touch-action: none;
      width:100%;
      max-width:100%;
    }
    @media (max-width: 480px){ .stage{ min-height: 280px; } }

    canvas{ display:block; width:100%; height:100%; max-width:100%; max-height:100%; }

    .overlay{
      position:absolute; inset:0;
      pointer-events:none;
      max-width:100%;
      overflow:hidden;
    }
    .cropBox{
      position:absolute;
      left:50%; top:50%;
      transform:translate(-50%,-50%);
      border:2px solid rgba(106,169,255,.85);
      box-shadow: 0 0 0 9999px rgba(0,0,0,.35);
      border-radius:8px;
    }
    .gridLines{
      position:absolute; inset:0;
      border-radius:8px;
      overflow:hidden;
    }
    .gridLines::before, .gridLines::after{
      content:"";
      position:absolute; left:0; top:0; right:0; bottom:0;
      background:
        linear-gradient(to right, rgba(255,255,255,.35) 0 0) 33.33% 0/1px 100% no-repeat,
        linear-gradient(to right, rgba(255,255,255,.35) 0 0) 66.66% 0/1px 100% no-repeat,
        linear-gradient(to bottom, rgba(255,255,255,.35) 0 0) 0 33.33%/100% 1px no-repeat,
        linear-gradient(to bottom, rgba(255,255,255,.35) 0 0) 0 66.66%/100% 1px no-repeat;
      opacity:.35;
    }

    .faceGuide{
      position:absolute;
      left:50%; top:50%;
      transform:translate(-50%,-52%);
      width:46%;
      aspect-ratio: 3/4;
      border:2px dashed rgba(255,255,255,.45);
      border-radius:999px;
      opacity:.75;
      display:none;
    }
    .faceGuide.show{ display:block; }

    .meta{
      color:#b7c3d9;
      font-size:13px;
      line-height:1.5;
      word-break:break-word;
      min-width:0;
    }
    .meta b{ color:#e9eef7; }

    .msg{ margin-top:10px; font-size:13px; color:#cfe0ff; }
    .msg.err{ color:#ffb4b4; }
    .msg.ok{ color:#b8ffcc; }

    .footer{
      margin-top:16px;
      color:#94a6c2;
      font-size:12px;
      text-align:center;
    }
    .footer a{ color:#9fb0ca; text-decoration:none; border-bottom:1px dashed rgba(159,176,202,.35); }
    .footer a:hover{ color:#cfe0ff; border-bottom-color:rgba(207,224,255,.6); }

    input[type="file"]{ display:none; }
    label{ display:block; font-size:12px; color:#a7b3c7; margin-bottom:6px; }
    select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      background:rgba(255,255,255,.06);
      color:#e9eef7;
      border:var(--border);
      outline:none;
      font-weight:900;
      max-width:100%;
      transition: box-shadow .12s var(--ease), border-color .12s var(--ease);
    }
    select:focus-visible{
      border-color: rgba(var(--blue), .55);
      box-shadow: 0 0 0 3px rgba(var(--blue),.22);
    }

    /* equal width country/doc */
    #countrySeg{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:8px;
      width:100%;
    }
    @media (min-width: 700px){
      #countrySeg{ grid-template-columns: repeat(4, minmax(0, 1fr)); }
    }
    #countrySeg .segBtn{ width:100%; justify-content:center; text-align:center; }

    #docSeg{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:8px;
      width:100%;
    }
    #docSeg .segBtn{ width:100%; justify-content:center; text-align:center; }

    .small{ min-height: 36px; display:block; }
    @media (max-width: 380px){
      .small{ min-height: 44px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div style="flex:1; min-width:240px;">
        <h1 class="title" id="page_title">ID Photo / Passport</h1>
        <p class="sub" id="page_sub">Upload â†’ adjust position/zoom â†’ download.</p>

        <div style="margin-top:10px;">
          <a class="homeBtn" href="/" id="home_btn">ğŸ  Home</a>
        </div>

        <div style="margin-top:10px;">
          <div class="pill"><span class="shield">ğŸ›¡</span> <span id="local_processing">Processed locally â€” no server upload</span></div>
        </div>

        <div style="margin-top:10px;">
          <div class="pill" id="presetPill">Preset: KR Â· Passport (3.5Ã—4.5)</div>
        </div>
      </div>

      <div class="langRow">
        <div class="langLabel">ğŸŒ <span id="lang_label">Language</span></div>
        <select class="langSelect" id="langSelect" aria-label="Language">
          <option value="en">Global (English)</option>
          <option value="ko">í•œêµ­ì–´</option>
          <option value="es">EspaÃ±ol</option>
          <option value="ja">æ—¥æœ¬èª</option>
        </select>
      </div>
    </div>

    <!-- Country & Doc type -->
    <div class="card">
      <h2 id="h_step0">Select</h2>

      <div class="row">
        <div>
          <label id="lbl_country">Country</label>
          <div class="seg" id="countrySeg">
            <div class="segBtn active" data-country="KR"><span class="flag">ğŸ‡°ğŸ‡·</span> <span class="txt" id="cty_KR">Korea</span></div>
            <div class="segBtn" data-country="US"><span class="flag">ğŸ‡ºğŸ‡¸</span> <span class="txt" id="cty_US">USA</span></div>
            <div class="segBtn" data-country="EU"><span class="flag">ğŸ‡ªğŸ‡º</span> <span class="txt" id="cty_EU">EU</span></div>
            <div class="segBtn" data-country="JP"><span class="flag">ğŸ‡¯ğŸ‡µ</span> <span class="txt" id="cty_JP">Japan</span></div>
          </div>
        </div>

        <div>
          <label id="lbl_doc">Document type</label>
          <div class="seg" id="docSeg">
            <div class="segBtn" data-doc="ID"><span class="flag">ğŸªª</span> <span class="txt" id="doc_ID">ID Photo</span></div>
            <div class="segBtn active" data-doc="PASS"><span class="flag">ğŸ›‚</span> <span class="txt" id="doc_PASS">Passport</span></div>
          </div>
        </div>
      </div>

      <div class="hint" id="hint_2step">
        Tip: Choose country first, then choose document type.
      </div>
    </div>

    <div class="stageWrap">
      <!-- Left -->
      <div class="card">
        <h2 id="h_step1">Upload photo</h2>

        <div class="row">
          <button class="btn secondary" id="pickBtn" type="button">ğŸ“ Choose photo</button>
          <button class="btn" id="camBtn" type="button">ğŸ“· Open camera</button>
        </div>

        <div style="height:10px;"></div>

        <div class="drop" id="drop" role="button" tabindex="0" aria-label="Upload photo">
          <div style="width:100%;">
            <div style="font-weight:900; margin-bottom:6px;" id="drop_title">Drop photo here<br/>or tap to upload</div>
            <div class="dropEmoji" aria-hidden="true">ğŸªª</div>
            <div class="hint" id="drop_hint">Supports: JPG, PNG, WebP (HEIC may not work on some devices)</div>
          </div>
        </div>

        <div style="height:12px;"></div>

        <h2 id="h_step2">Preview / Crop</h2>

        <div class="stage" id="stage">
          <canvas id="cv"></canvas>

          <div class="overlay" id="overlay">
            <div class="cropBox" id="cropBox"><div class="gridLines"></div></div>
            <div class="faceGuide" id="faceGuide"></div>
          </div>
        </div>

        <div class="msg" id="msg"></div>
      </div>

      <!-- Right -->
      <div class="card">
        <div class="cardHead">
          <h2 id="h_controls">Controls</h2>
          <div class="headActions" aria-label="Quick actions">
            <button class="iconCircle" id="imgIconBtn" type="button" title="Load another image" aria-label="Load another image">
              <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M4.5 6.8c0-1.1.9-2 2-2h11c1.1 0 2 .9 2 2v10.4c0 1.1-.9 2-2 2h-11c-1.1 0-2-.9-2-2V6.8Z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
                <path d="M8 13.4l2.2-2.2a1.1 1.1 0 0 1 1.6 0l2.6 2.6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M13.6 12.8l1-1a1.1 1.1 0 0 1 1.6 0l2.2 2.2" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M9.1 9.2h.01" stroke="currentColor" stroke-width="3.2" stroke-linecap="round"/>
              </svg>
            </button>

            <button class="iconCircle" id="undoBtn" type="button" title="Undo" aria-label="Undo" disabled>
              <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M9.2 7.2H6.3V4.3" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M6.4 7.2c1.8-2 4.4-3.2 7.3-3.2 5 0 9 3.9 9 8.8s-4 8.8-9 8.8c-3.5 0-6.6-1.9-8.2-4.8" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
        </div>

        <div class="row">
          <button class="btn secondary" id="fitBtn" type="button">â†” Fit</button>
          <button class="btn secondary" id="centerBtn" type="button">ğŸ¯ Center</button>
        </div>

        <div style="height:10px;"></div>

        <div class="row">
          <button class="btn secondary" id="zoomOutBtn" type="button">â– Zoom out</button>
          <button class="btn secondary" id="zoomInBtn" type="button">â• Zoom in</button>
        </div>

        <div style="height:12px;"></div>

        <div class="row">
          <div class="seg" id="togglesSeg" style="gap:8px;">
            <div class="segBtn active" id="toggleAuto"><span id="auto_icon">âœ…</span> <span id="auto_txt">Auto center (recommended)</span></div>
            <div class="segBtn active" id="toggleGuide"><span id="guide_icon">âœ…</span> <span id="guide_txt">Show face guide</span></div>
          </div>
        </div>

        <div style="height:12px;"></div>

        <div class="row">
          <div>
            <label id="lbl_dpi">DPI</label>
            <select id="dpi">
              <option value="300" selected>300</option>
              <option value="600">600</option>
            </select>
            <div class="small" id="dpi_hint">300 dpi is sufficient for most printing.</div>
          </div>
          <div>
            <label id="lbl_format">Output</label>
            <select id="outFormat">
              <option value="image/jpeg" selected>JPG</option>
              <option value="image/png">PNG</option>
            </select>
            <div class="small" id="fmt_hint">JPG recommended.</div>
          </div>
        </div>

        <div style="height:12px;"></div>

        <!-- Print/Download mode ABOVE Download -->
        <h2 id="h_print">Print</h2>
        <div class="seg" id="printSeg">
          <div class="segBtn active" data-print="SINGLE" id="print_single">1 photo</div>
          <div class="segBtn" data-print="A4" id="print_a4">A4 print</div>
        </div>

        <div style="height:10px;"></div>

        <div id="sheetWrap">
          <label id="lbl_sheet">A4 layout</label>
          <div class="seg" id="sheetSeg">
            <div class="segBtn active" data-sheet="4" id="sheet_4">4</div>
            <div class="segBtn" data-sheet="6" id="sheet_6">6</div>
            <div class="segBtn" data-sheet="8" id="sheet_8">8</div>
            <div class="segBtn" data-sheet="12" id="sheet_12">12</div>
          </div>
          <div class="small" id="sheet_hint">Choose how many photos to place on A4.</div>
          <div style="height:12px;"></div>
        </div>

        <!-- A4 Print button (safe cross-browser) -->
        <button class="btn secondary" id="printBtn" type="button" disabled>ğŸ–¨ Print / Save PDF (A4)</button>
        <div style="height:12px;"></div>

        <h2 id="h_step3">Download</h2>
        <button class="btn" id="downloadBtn" type="button" disabled>â¬‡ï¸ Download</button>
        <div style="height:10px;"></div>
        <button class="btn secondary" id="resetBtn" type="button" disabled>Reset</button>

        <div style="height:12px;"></div>
        <div class="meta" id="meta">
          <b>Preview</b><br/>Upload a photo to start cropping.
        </div>
      </div>
    </div>

    <div class="footer">
      Â© <span id="year"></span> ConvertFiles24 Â·
      <a href="/privacy.html">Privacy</a> Â·
      <a href="/terms.html">Terms</a>
    </div>
  </div>

  <!-- hidden inputs -->
  <input id="pickInput" type="file" accept="image/*">
  <input id="camInput" type="file" accept="image/*" capture="environment">

<script>
(() => {
  "use strict";
  const $ = (id)=>document.getElementById(id);
  $("year").textContent = new Date().getFullYear();
  requestAnimationFrame(()=> document.body.classList.add("loaded"));

  // ========= i18n =========
  const STR = {
    en: {
      page_title: "ID Photo / Passport",
      page_sub: "Upload â†’ adjust position/zoom â†’ download.",
      home: "ğŸ  Home",
      local: "Processed locally â€” no server upload",
      lang_label: "Language",
      step0: "Select",
      country: "Country",
      doc: "Document type",
      tip2: "Tip: Choose country first, then choose document type.",
      step1: "Upload photo",
      choose: "ğŸ“ Choose photo",
      camera: "ğŸ“· Open camera",
      drop_title: "Drop photo here<br/>or tap to upload",
      drop_hint: "Supports: JPG, PNG, WebP (HEIC may not work on some devices)",
      step2: "Preview / Crop",
      controls: "Controls",
      fit: "â†” Fit",
      center: "ğŸ¯ Center",
      zoomOut: "â– Zoom out",
      zoomIn: "â• Zoom in",
      auto: "Auto center (recommended)",
      guide: "Show face guide",
      dpi: "DPI",
      dpi_hint: "300 dpi is sufficient for most printing.",
      out: "Output",
      out_hint: "JPG recommended.",
      print: "Print",
      print_single: "1 photo",
      print_a4: "A4 print",
      a4_layout: "A4 layout",
      a4_hint: "Choose how many photos to place on A4.",
      print_btn: "ğŸ–¨ Print / Save PDF (A4)",
      step3: "Download",
      download: "â¬‡ï¸ Download",
      reset: "Reset",
      msg_need: "Please upload a photo first.",
      msg_ready: "Ready. Drag to move. Pinch or use buttons to zoom.",
      msg_heic: "HEIC/HEIF may not work on some browsers. If preview fails, save as JPG/PNG and try again.",
      msg_fail: "Failed to load image.",
      msg_popup: "Popup blocked. Allow popups for printing.",
      meta_idle: "<b>Preview</b><br/>Upload a photo to start cropping.",
      meta_info_single: (w,h,mmW,mmH,pxW,pxH,dpi)=>`<b>Preset</b><br/>Size: ${mmW}Ã—${mmH} mm<br/>Output: ${pxW}Ã—${pxH}px @ ${dpi}dpi<br/><b>Image</b><br/>${w}Ã—${h}px`,
      meta_info_a4: (w,h,mmW,mmH,pxW,pxH,dpi,cnt,cols,rows,a4Wpx,a4Hpx)=>`<b>Preset</b><br/>Size: ${mmW}Ã—${mmH} mm<br/>Photo: ${pxW}Ã—${pxH}px @ ${dpi}dpi<br/><b>A4</b><br/>${cnt} photos (${cols}Ã—${rows}) Â· A4: ${a4Wpx}Ã—${a4Hpx}px<br/><b>Image</b><br/>${w}Ã—${h}px`,
      cty: { KR:"Korea", US:"USA", EU:"EU", JP:"Japan" },
      docTxt: { ID:"ID Photo", PASS:"Passport" }
    },
    ko: {
      page_title: "ID Photo / Passport",
      page_sub: "ì—…ë¡œë“œ â†’ ìœ„ì¹˜/í™•ëŒ€ ì¡°ì ˆ â†’ ë‹¤ìš´ë¡œë“œ.",
      home: "ğŸ  í™ˆìœ¼ë¡œ",
      local: "ë¡œì»¬ ì²˜ë¦¬ â€” ì„œë²„ ì—…ë¡œë“œ ì—†ìŒ",
      lang_label: "ì–¸ì–´",
      step0: "ì„ íƒ",
      country: "êµ­ê°€",
      doc: "ë¬¸ì„œ íƒ€ì…",
      tip2: "íŒ: êµ­ê°€ë¥¼ ë¨¼ì € ê³ ë¥¸ ë’¤, ë¬¸ì„œ íƒ€ì…(ID/ì—¬ê¶Œ)ì„ ì„ íƒí•˜ì„¸ìš”.",
      step1: "ì‚¬ì§„ ì—…ë¡œë“œ",
      choose: "ğŸ“ íŒŒì¼ ì„ íƒ",
      camera: "ğŸ“· ì¹´ë©”ë¼ ì—´ê¸°",
      drop_title: "ì—¬ê¸°ì— ì‚¬ì§„ì„ ëŒì–´ë‹¤ ë†“ê±°ë‚˜<br/>íƒ­í•´ì„œ ì‚¬ì§„ ì„ íƒ",
      drop_hint: "ì§€ì›: JPG, PNG, WebP (HEICëŠ” ê¸°ê¸°/ë¸Œë¼ìš°ì €ì— ë”°ë¼ ì•ˆ ë  ìˆ˜ ìˆì–´ìš”)",
      step2: "ë¯¸ë¦¬ë³´ê¸° / í¬ë¡­",
      controls: "ì¡°ì‘",
      fit: "â†” ë§ì¶”ê¸°",
      center: "ğŸ¯ ì¤‘ì•™",
      zoomOut: "â– ì¶•ì†Œ",
      zoomIn: "â• í™•ëŒ€",
      auto: "ìë™ ì¤‘ì•™(ê¶Œì¥)",
      guide: "ì–¼êµ´ ê°€ì´ë“œ í‘œì‹œ",
      dpi: "DPI",
      dpi_hint: "ì¼ë°˜ ì¶œë ¥ì€ 300dpië©´ ì¶©ë¶„í•´ìš”.",
      out: "ì¶œë ¥",
      out_hint: "JPG ê¶Œì¥",
      print: "ì¶œë ¥ìš©",
      print_single: "1ì¥(íŒŒì¼ ì œì¶œìš©)",
      print_a4: "A4 ì¸ì‡„ìš©",
      a4_layout: "A4 ë°°ì¹˜",
      a4_hint: "A4ì— ë„£ì„ ì¥ìˆ˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.",
      print_btn: "ğŸ–¨ ì¸ì‡„ / PDFë¡œ ì €ì¥ (A4)",
      step3: "ë‹¤ìš´ë¡œë“œ",
      download: "â¬‡ï¸ ë‹¤ìš´ë¡œë“œ",
      reset: "ì´ˆê¸°í™”",
      msg_need: "ë¨¼ì € ì‚¬ì§„ì„ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.",
      msg_ready: "ì¤€ë¹„ ì™„ë£Œ! ë“œë˜ê·¸ë¡œ ì´ë™, í•€ì¹˜/ë²„íŠ¼ìœ¼ë¡œ í™•ëŒ€í•˜ì„¸ìš”.",
      msg_heic: "HEIC/HEIFëŠ” ì¼ë¶€ ë¸Œë¼ìš°ì €ì—ì„œ ì•ˆ ë  ìˆ˜ ìˆì–´ìš”. ë¯¸ë¦¬ë³´ê¸°ê°€ ì‹¤íŒ¨í•˜ë©´ JPG/PNGë¡œ ì €ì¥ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.",
      msg_fail: "ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨",
      msg_popup: "íŒì—…ì´ ì°¨ë‹¨ëì–´ìš”. ì¸ì‡„ë¥¼ ìœ„í•´ íŒì—… í—ˆìš© í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.",
      meta_idle: "<b>ë¯¸ë¦¬ë³´ê¸°</b><br/>ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ë©´ í¬ë¡­ì„ ì‹œì‘í•  ìˆ˜ ìˆì–´ìš”.",
      meta_info_single: (w,h,mmW,mmH,pxW,pxH,dpi)=>`<b>í”„ë¦¬ì…‹</b><br/>í¬ê¸°: ${mmW}Ã—${mmH} mm<br/>ì¶œë ¥: ${pxW}Ã—${pxH}px @ ${dpi}dpi<br/><b>ì›ë³¸</b><br/>${w}Ã—${h}px`,
      meta_info_a4: (w,h,mmW,mmH,pxW,pxH,dpi,cnt,cols,rows,a4Wpx,a4Hpx)=>`<b>í”„ë¦¬ì…‹</b><br/>í¬ê¸°: ${mmW}Ã—${mmH} mm<br/>ì‚¬ì§„: ${pxW}Ã—${pxH}px @ ${dpi}dpi<br/><b>A4 ì¸ì‡„</b><br/>${cnt}ì¥ (${cols}Ã—${rows}) Â· A4: ${a4Wpx}Ã—${a4Hpx}px<br/><b>ì›ë³¸</b><br/>${w}Ã—${h}px`,
      cty: { KR:"í•œêµ­", US:"ë¯¸êµ­", EU:"EU", JP:"ì¼ë³¸" },
      docTxt: { ID:"ì¦ëª…ì‚¬ì§„", PASS:"ì—¬ê¶Œì‚¬ì§„" }
    },
    es: {
      page_title: "ID Photo / Passport",
      page_sub: "Sube â†’ ajusta posiciÃ³n/zoom â†’ descarga.",
      home: "ğŸ  Inicio",
      local: "Procesado local â€” sin servidor",
      lang_label: "Idioma",
      step0: "Seleccionar",
      country: "PaÃ­s",
      doc: "Tipo de documento",
      tip2: "Consejo: Elige primero el paÃ­s y luego el tipo (ID/Pasaporte).",
      step1: "Subir foto",
      choose: "ğŸ“ Elegir foto",
      camera: "ğŸ“· Abrir cÃ¡mara",
      drop_title: "Suelta la foto aquÃ­<br/>o toca para subir",
      drop_hint: "Soporta: JPG, PNG, WebP (HEIC puede fallar en algunos dispositivos)",
      step2: "Vista previa / Recorte",
      controls: "Controles",
      fit: "â†” Ajustar",
      center: "ğŸ¯ Centrar",
      zoomOut: "â– Alejar",
      zoomIn: "â• Acercar",
      auto: "Centrado automÃ¡tico (recomendado)",
      guide: "Mostrar guÃ­a de rostro",
      dpi: "DPI",
      dpi_hint: "300dpi suele ser suficiente.",
      out: "Salida",
      out_hint: "JPG recomendado.",
      print: "Imprimir",
      print_single: "1 foto",
      print_a4: "Imprimir A4",
      a4_layout: "DiseÃ±o A4",
      a4_hint: "Elige cuÃ¡ntas fotos colocar en A4.",
      print_btn: "ğŸ–¨ Imprimir / Guardar PDF (A4)",
      step3: "Descargar",
      download: "â¬‡ï¸ Descargar",
      reset: "Reiniciar",
      msg_need: "Primero sube una foto.",
      msg_ready: "Listo. Arrastra para mover y usa pellizco/botones para zoom.",
      msg_heic: "HEIC/HEIF puede no funcionar en algunos navegadores. Guarda como JPG/PNG y reintenta.",
      msg_fail: "No se pudo cargar la imagen.",
      msg_popup: "Ventana emergente bloqueada. Permite popups para imprimir.",
      meta_idle: "<b>Vista previa</b><br/>Sube una foto para empezar.",
      meta_info_single: (w,h,mmW,mmH,pxW,pxH,dpi)=>`<b>Preset</b><br/>TamaÃ±o: ${mmW}Ã—${mmH} mm<br/>Salida: ${pxW}Ã—${pxH}px @ ${dpi}dpi<br/><b>Imagen</b><br/>${w}Ã—${h}px`,
      meta_info_a4: (w,h,mmW,mmH,pxW,pxH,dpi,cnt,cols,rows,a4Wpx,a4Hpx)=>`<b>Preset</b><br/>TamaÃ±o: ${mmW}Ã—${mmH} mm<br/>Foto: ${pxW}Ã—${pxH}px @ ${dpi}dpi<br/><b>A4</b><br/>${cnt} fotos (${cols}Ã—${rows}) Â· A4: ${a4Wpx}Ã—${a4Hpx}px<br/><b>Imagen</b><br/>${w}Ã—${h}px`,
      cty: { KR:"Corea", US:"EE.UU.", EU:"UE", JP:"JapÃ³n" },
      docTxt: { ID:"Foto ID", PASS:"Pasaporte" }
    },
    ja: {
      page_title: "ID Photo / Passport",
      page_sub: "ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ â†’ ä½ç½®/ã‚ºãƒ¼ãƒ èª¿æ•´ â†’ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€‚",
      home: "ğŸ  ãƒ›ãƒ¼ãƒ ",
      local: "ãƒ­ãƒ¼ã‚«ãƒ«å‡¦ç† â€” ã‚µãƒ¼ãƒãƒ¼ãªã—",
      lang_label: "è¨€èª",
      step0: "é¸æŠ",
      country: "å›½",
      doc: "æ›¸é¡ã‚¿ã‚¤ãƒ—",
      tip2: "ãƒ’ãƒ³ãƒˆ: å›½ã‚’é¸ã‚“ã§ã‹ã‚‰ã€ID/ãƒ‘ã‚¹ãƒãƒ¼ãƒˆã‚’é¸æŠã—ã¾ã™ã€‚",
      step1: "ì‚¬ì§„ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰",
      choose: "ğŸ“ å†™çœŸã‚’é¸æŠ",
      camera: "ğŸ“· ã‚«ãƒ¡ãƒ©ã‚’é–‹ã",
      drop_title: "ã“ã“ã«å†™çœŸã‚’ãƒ‰ãƒ­ãƒƒãƒ—<br/>ã¾ãŸã¯ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠ",
      drop_hint: "å¯¾å¿œ: JPG, PNG, WebPï¼ˆHEICã¯ä¸€éƒ¨éå¯¾å¿œï¼‰",
      step2: "ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ / åˆ‡ã‚ŠæŠœã",
      controls: "æ“ä½œ",
      fit: "â†” ãƒ•ã‚£ãƒƒãƒˆ",
      center: "ğŸ¯ ä¸­å¤®",
      zoomOut: "â– ç¸®å°",
      zoomIn: "â• æ‹¡å¤§",
      auto: "è‡ªå‹•ä¸­å¤®ï¼ˆæ¨å¥¨ï¼‰",
      guide: "é¡”ã‚¬ã‚¤ãƒ‰è¡¨ç¤º",
      dpi: "DPI",
      dpi_hint: "é€šå¸¸ã¯300dpiã§ååˆ†ã§ã™ã€‚",
      out: "å‡ºåŠ›",
      out_hint: "JPGæ¨å¥¨",
      print: "å°åˆ·",
      print_single: "1æš",
      print_a4: "A4å°åˆ·",
      a4_layout: "A4ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ",
      a4_hint: "A4ã«é…ç½®ã™ã‚‹æšæ•°ã‚’é¸æŠã€‚",
      print_btn: "ğŸ–¨ å°åˆ· / PDFä¿å­˜ (A4)",
      step3: "ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
      download: "â¬‡ï¸ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
      reset: "ãƒªã‚»ãƒƒãƒˆ",
      msg_need: "å…ˆã«å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚",
      msg_ready: "æº–å‚™OKã€‚ãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹•ã€ãƒ”ãƒ³ãƒ/ãƒœã‚¿ãƒ³ã§ã‚ºãƒ¼ãƒ ã€‚",
      msg_heic: "HEIC/HEIFã¯ä¸€éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶ã§éå¯¾å¿œã§ã™ã€‚JPG/PNGã§ãŠè©¦ã—ãã ã•ã„ã€‚",
      msg_fail: "ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
      msg_popup: "ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚å°åˆ·ã®ãŸã‚ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚",
      meta_idle: "<b>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</b><br/>å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚",
      meta_info_single: (w,h,mmW,mmH,pxW,pxH,dpi)=>`<b>ãƒ—ãƒªã‚»ãƒƒãƒˆ</b><br/>ã‚µã‚¤ã‚º: ${mmW}Ã—${mmH} mm<br/>å‡ºåŠ›: ${pxW}Ã—${pxH}px @ ${dpi}dpi<br/><b>å…ƒç”»åƒ</b><br/>${w}Ã—${h}px`,
      meta_info_a4: (w,h,mmW,mmH,pxW,pxH,dpi,cnt,cols,rows,a4Wpx,a4Hpx)=>`<b>ãƒ—ãƒªã‚»ãƒƒãƒˆ</b><br/>ã‚µã‚¤ã‚º: ${mmW}Ã—${mmH} mm<br/>å†™çœŸ: ${pxW}Ã—${pxH}px @ ${dpi}dpi<br/><b>A4</b><br/>${cnt}æš (${cols}Ã—${rows}) Â· A4: ${a4Wpx}Ã—${a4Hpx}px<br/><b>å…ƒç”»åƒ</b><br/>${w}Ã—${h}px`,
      cty: { KR:"éŸ“å›½", US:"ç±³å›½", EU:"EU", JP:"æ—¥æœ¬" },
      docTxt: { ID:"IDå†™çœŸ", PASS:"ãƒ‘ã‚¹ãƒãƒ¼ãƒˆ" }
    }
  };

  function getQueryLang(){
    try{
      const u = new URL(location.href);
      const q = (u.searchParams.get("lang")||"").toLowerCase();
      if(q && STR[q]) return q;
    }catch(e){}
    return null;
  }
  function detectLang(){
    const q = getQueryLang();
    if(q) return q;
    const saved = localStorage.getItem("cf24_lang");
    if(saved && STR[saved]) return saved;
    const nav = (navigator.language || "").toLowerCase();
    if(nav.startsWith("ko")) return "ko";
    if(nav.startsWith("ja")) return "ja";
    if(nav.startsWith("es")) return "es";
    return "en";
  }
  let LANG = detectLang();
  function t(){ return STR[LANG] || STR.en; }

  function updateChoiceLabels(){
    const s = t();
    $("cty_KR").textContent = s.cty.KR;
    $("cty_US").textContent = s.cty.US;
    $("cty_EU").textContent = s.cty.EU;
    $("cty_JP").textContent = s.cty.JP;
    $("doc_ID").textContent = s.docTxt.ID;
    $("doc_PASS").textContent = s.docTxt.PASS;
  }

  function setLang(lang){
    if(!STR[lang]) lang = "en";
    LANG = lang;
    localStorage.setItem("cf24_lang", lang);
    $("langSelect").value = lang;
    document.documentElement.lang = lang;

    $("page_title").textContent = t().page_title;
    $("page_sub").textContent = t().page_sub;
    $("home_btn").textContent = t().home;
    $("local_processing").textContent = t().local;
    $("lang_label").textContent = t().lang_label;

    $("h_step0").textContent = t().step0;
    $("lbl_country").textContent = t().country;
    $("lbl_doc").textContent = t().doc;
    $("hint_2step").textContent = t().tip2;

    $("h_step1").textContent = t().step1;
    $("pickBtn").textContent = t().choose;
    $("camBtn").textContent = t().camera;
    $("drop_title").innerHTML = t().drop_title;
    $("drop_hint").textContent = t().drop_hint;

    $("h_step2").textContent = t().step2;

    $("h_controls").textContent = t().controls;
    $("fitBtn").textContent = t().fit;
    $("centerBtn").textContent = t().center;
    $("zoomOutBtn").textContent = t().zoomOut;
    $("zoomInBtn").textContent = t().zoomIn;
    $("auto_txt").textContent = t().auto;
    $("guide_txt").textContent = t().guide;

    $("lbl_dpi").textContent = t().dpi;
    $("dpi_hint").textContent = t().dpi_hint;
    $("lbl_format").textContent = t().out;
    $("fmt_hint").textContent = t().out_hint;

    $("h_print").textContent = t().print;
    $("print_single").textContent = t().print_single;
    $("print_a4").textContent = t().print_a4;
    $("lbl_sheet").textContent = t().a4_layout;
    $("sheet_hint").textContent = t().a4_hint;
    $("printBtn").textContent = t().print_btn;

    $("h_step3").textContent = t().step3;
    $("downloadBtn").textContent = t().download;
    $("resetBtn").textContent = t().reset;

    updateChoiceLabels();
    if(!imgEl) $("meta").innerHTML = t().meta_idle;
    refreshPresetPill();
    setTimeout(()=>resizeCanvas(), 0);
  }
  $("langSelect").addEventListener("change", (e)=> setLang(e.target.value));

  // ========= Presets =========
  const PRESETS = {
    KR: { ID:{ name:"KR Â· ID (3Ã—4)", mmW:30, mmH:40 }, PASS:{ name:"KR Â· Passport (3.5Ã—4.5)", mmW:35, mmH:45 } },
    US: { ID:{ name:"US Â· ID (2Ã—2)", mmW:51, mmH:51 }, PASS:{ name:"US Â· Passport (2Ã—2)", mmW:51, mmH:51 } },
    EU: { ID:{ name:"EU Â· ID (35Ã—45)", mmW:35, mmH:45 }, PASS:{ name:"EU Â· Passport (35Ã—45)", mmW:35, mmH:45 } },
    JP: { ID:{ name:"JP Â· ID (30Ã—40)", mmW:30, mmH:40 }, PASS:{ name:"JP Â· Passport (35Ã—45)", mmW:35, mmH:45 } }
  };

  let COUNTRY = "KR";
  let DOC = "PASS";
  function currentPreset(){ return PRESETS[COUNTRY][DOC]; }

  function setSegActive(containerId, key, value){
    document.querySelectorAll(`#${containerId} .segBtn`).forEach(b=>{
      b.classList.toggle("active", b.dataset[key] === value);
    });
  }

  document.querySelectorAll("#countrySeg .segBtn").forEach(b=>{
    b.addEventListener("click", ()=>{
      COUNTRY = b.dataset.country;
      setSegActive("countrySeg", "country", COUNTRY);
      refreshPresetPill();
      updateCropBox();
      if(autoCenter) smartCenter(true);
      redraw();
      resizeCanvas();
    });
  });

  document.querySelectorAll("#docSeg .segBtn").forEach(b=>{
    b.addEventListener("click", ()=>{
      DOC = b.dataset.doc;
      setSegActive("docSeg", "doc", DOC);
      refreshPresetPill();
      updateCropBox();
      if(autoCenter) smartCenter(true);
      redraw();
      resizeCanvas();
    });
  });

  function refreshPresetPill(){
    const p = currentPreset();
    $("presetPill").textContent = `Preset: ${p.name}`;
    updateMeta();
  }

  // ========= Print mode =========
  let PRINT_MODE = "SINGLE";   // SINGLE | A4
  let A4_COUNT = 4;           // 4,6,8,12

  function setPrintMode(mode){
    PRINT_MODE = mode;
    document.querySelectorAll("#printSeg .segBtn").forEach(b=>{
      b.classList.toggle("active", b.dataset.print === mode);
    });
    const wrap = $("sheetWrap");
    if(mode === "A4") wrap.classList.add("show");
    else wrap.classList.remove("show");
    updateMeta();
  }
  function setA4Count(cnt){
    A4_COUNT = cnt;
    document.querySelectorAll("#sheetSeg .segBtn").forEach(b=>{
      b.classList.toggle("active", parseInt(b.dataset.sheet,10) === cnt);
    });
    updateMeta();
  }
  document.querySelectorAll("#printSeg .segBtn").forEach(b=>{
    b.addEventListener("click", ()=> setPrintMode(b.dataset.print));
  });
  document.querySelectorAll("#sheetSeg .segBtn").forEach(b=>{
    b.addEventListener("click", ()=> setA4Count(parseInt(b.dataset.sheet,10)));
  });

  // ========= Upload / Image =========
  const pickInput = $("pickInput");
  const camInput  = $("camInput");
  const pickBtn   = $("pickBtn");
  const camBtn    = $("camBtn");
  const drop      = $("drop");

  pickBtn.addEventListener("click", ()=>{ pickInput.value = ""; pickInput.click(); });
  camBtn.addEventListener("click", ()=>{ camInput.value = ""; camInput.click(); });

  function isHeic(name){
    const ext = (name||"").toLowerCase().split(".").pop();
    return ext === "heic" || ext === "heif";
  }

  pickInput.addEventListener("change", (e)=> { const f = e.target.files && e.target.files[0]; if(f) loadFile(f); });
  camInput.addEventListener("change", (e)=> { const f = e.target.files && e.target.files[0]; if(f) loadFile(f); });

  function openDropPicker(){ pickInput.value = ""; pickInput.click(); }

  drop.addEventListener("click", openDropPicker);
  drop.addEventListener("keydown", (e)=>{
    if(e.key === "Enter" || e.key === " "){
      e.preventDefault();
      openDropPicker();
    }
  });

  ["dragenter","dragover"].forEach(evt=>{
    drop.addEventListener(evt, (e)=>{ e.preventDefault(); e.stopPropagation(); drop.classList.add("drag"); });
  });
  ["dragleave","drop"].forEach(evt=>{
    drop.addEventListener(evt, (e)=>{ e.preventDefault(); e.stopPropagation(); drop.classList.remove("drag"); });
  });
  drop.addEventListener("drop", (e)=>{
    const f = e.dataTransfer.files && e.dataTransfer.files[0];
    if(f) loadFile(f);
  });

  // ========= Crop engine =========
  const stage = $("stage");
  const cv = $("cv");
  const ctx = cv.getContext("2d", { alpha:true });

  const cropBoxEl = $("cropBox");
  const faceGuideEl = $("faceGuide");

  let imgEl = null;
  let imgW = 0, imgH = 0;

  let scale = 1;
  let offsetX = 0;
  let offsetY = 0;

  let autoCenter = true;
  let showGuide = true;

  // ===== Undo stack =====
  const undoBtn = $("undoBtn");
  const imgIconBtn = $("imgIconBtn");
  const history = [];

  function snap(){ return { scale, offsetX, offsetY }; }
  function sameState(a,b){
    if(!a || !b) return false;
    return Math.abs(a.scale-b.scale) < 1e-6 &&
           Math.abs(a.offsetX-b.offsetX) < 0.01 &&
           Math.abs(a.offsetY-b.offsetY) < 0.01;
  }
  function pushUndoState(prev){
    if(!imgEl || !prev) return;
    const last = history[history.length-1];
    if(last && sameState(last, prev)) return;
    history.push(prev);
    if(history.length > 80) history.shift();
    undoBtn.disabled = history.length === 0;
  }
  function clearUndo(){
    history.length = 0;
    undoBtn.disabled = true;
  }
  function applyState(st){
    if(!st) return;
    scale = st.scale;
    offsetX = st.offsetX;
    offsetY = st.offsetY;
  }

  undoBtn.addEventListener("click", ()=>{
    if(!imgEl || history.length === 0) return;
    const prev = history.pop();
    applyState(prev);
    redraw();
    undoBtn.disabled = history.length === 0;
  });

  imgIconBtn.addEventListener("click", ()=> openDropPicker());

  function syncToggleUI(){
    $("toggleAuto").classList.toggle("active", autoCenter);
    $("toggleGuide").classList.toggle("active", showGuide);
    $("auto_icon").textContent = autoCenter ? "âœ…" : "â˜";
    $("guide_icon").textContent = showGuide ? "âœ…" : "â˜";
    faceGuideEl.classList.toggle("show", showGuide);
  }

  $("toggleAuto").addEventListener("click", ()=>{
    autoCenter = !autoCenter;
    if(autoCenter && imgEl) smartCenter(true);
    syncToggleUI();
    redraw();
  });

  $("toggleGuide").addEventListener("click", ()=>{
    showGuide = !showGuide;
    syncToggleUI();
  });

  $("fitBtn").addEventListener("click", ()=>{
    if(!imgEl) return setMsg(t().msg_need, "err");
    pushUndoState(snap());
    fitToCrop();
  });

  $("centerBtn").addEventListener("click", ()=>{
    if(!imgEl) return setMsg(t().msg_need, "err");
    pushUndoState(snap());
    smartCenter(false);
    redraw();
  });

  $("zoomInBtn").addEventListener("click", ()=> zoomBy(1.08));
  $("zoomOutBtn").addEventListener("click", ()=> zoomBy(1/1.08));

  function zoomBy(factor){
    if(!imgEl) return setMsg(t().msg_need, "err");
    pushUndoState(snap());

    const rect = stage.getBoundingClientRect();
    const cx = rect.width/2;
    const cy = rect.height/2;

    const beforeX = (cx - offsetX) / scale;
    const beforeY = (cy - offsetY) / scale;

    scale = clamp(scale * factor, 0.1, 12);

    offsetX = cx - beforeX * scale;
    offsetY = cy - beforeY * scale;

    redraw();
  }

  function setMsg(text, cls){
    const m = $("msg");
    m.textContent = text || "";
    m.className = "msg " + (cls || "");
  }

  function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

  function resizeCanvas(){
    const rect = stage.getBoundingClientRect();
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    cv.width = Math.round(rect.width * dpr);
    cv.height = Math.round(rect.height * dpr);
    cv.style.width = rect.width + "px";
    cv.style.height = rect.height + "px";
    ctx.setTransform(dpr,0,0,dpr,0,0);
    updateCropBox();
    redraw();
  }
  window.addEventListener("resize", resizeCanvas);

  function cropRectInStage(){
    const rect = stage.getBoundingClientRect();
    const p = currentPreset();
    const ratio = p.mmW / p.mmH;

    const margin = 18;
    const maxW = rect.width - margin*2;
    const maxH = rect.height - margin*2;

    let w = maxW;
    let h = w / ratio;
    if(h > maxH){
      h = maxH;
      w = h * ratio;
    }

    const x = (rect.width - w)/2;
    const y = (rect.height - h)/2;
    return { x, y, w, h };
  }

  function updateCropBox(){
    const r = cropRectInStage();
    cropBoxEl.style.width = r.w + "px";
    cropBoxEl.style.height = r.h + "px";
  }

  function fitToCrop(){
    const cr = cropRectInStage();
    const sx = cr.w / imgW;
    const sy = cr.h / imgH;
    scale = Math.max(sx, sy);

    const cropCenterX = cr.x + cr.w/2;
    const cropCenterY = cr.y + cr.h/2;
    offsetX = cropCenterX - (imgW/2)*scale;
    offsetY = cropCenterY - (imgH/2)*scale;

    redraw();
  }

  function smartCenter(pushUndo){
    if(pushUndo) pushUndoState(snap());
    fitToCrop();
  }

  function redraw(){
    const rect = stage.getBoundingClientRect();
    ctx.clearRect(0,0,rect.width,rect.height);
    if(!imgEl) return;

    ctx.save();
    ctx.translate(offsetX, offsetY);
    ctx.scale(scale, scale);
    ctx.drawImage(imgEl, 0, 0, imgW, imgH);
    ctx.restore();

    updateMeta();
  }

  // A4 layout mapping
  function a4Grid(count){
    if(count === 4) return { cols:2, rows:2 };
    if(count === 6) return { cols:2, rows:3 };
    if(count === 8) return { cols:2, rows:4 };
    return { cols:3, rows:4 }; // 12
  }

  function updateMeta(){
    const p = currentPreset();
    const dpi = parseInt($("dpi").value, 10) || 300;

    const pxW = Math.round((p.mmW / 25.4) * dpi);
    const pxH = Math.round((p.mmH / 25.4) * dpi);

    if(!imgEl){
      $("meta").innerHTML = t().meta_idle;
      $("downloadBtn").disabled = true;
      $("resetBtn").disabled = true;
      clearUndo();

      $("printBtn").disabled = true;
      $("printBtn").style.display = "none";
      return;
    }

    if(PRINT_MODE === "A4"){
      const a4Wpx = Math.round((210/25.4) * dpi);
      const a4Hpx = Math.round((297/25.4) * dpi);
      const g = a4Grid(A4_COUNT);
      $("meta").innerHTML = t().meta_info_a4(imgW, imgH, p.mmW, p.mmH, pxW, pxH, dpi, A4_COUNT, g.cols, g.rows, a4Wpx, a4Hpx);

      $("printBtn").disabled = false;
      $("printBtn").style.display = "block";
    } else {
      $("meta").innerHTML = t().meta_info_single(imgW, imgH, p.mmW, p.mmH, pxW, pxH, dpi);

      $("printBtn").disabled = true;
      $("printBtn").style.display = "none";
    }

    $("downloadBtn").disabled = false;
    $("resetBtn").disabled = false;
    undoBtn.disabled = history.length === 0;
  }

  async function loadFile(file){
    if(!file) return;

    if(isHeic(file.name)) setMsg(t().msg_heic, "");
    else setMsg("", "");

    const url = URL.createObjectURL(file);
    const img = new Image();
    img.onload = ()=>{
      URL.revokeObjectURL(url);
      imgEl = img;
      imgW = img.naturalWidth || 0;
      imgH = img.naturalHeight || 0;

      clearUndo();
      smartCenter(false);
      redraw();
      setMsg(t().msg_ready, "ok");
      updateMeta();
      resizeCanvas();
    };
    img.onerror = ()=>{
      URL.revokeObjectURL(url);
      imgEl = null;
      imgW = imgH = 0;
      clearUndo();
      redraw();
      setMsg(t().msg_fail, "err");
      updateMeta();
      resizeCanvas();
    };
    img.src = url;
  }

  // pointer events
  const pointers = new Map();
  let lastPan = null;
  let lastPinch = null;
  let gestureStart = null;

  stage.addEventListener("pointerdown", (e)=>{
    stage.setPointerCapture(e.pointerId);
    pointers.set(e.pointerId, { x:e.clientX, y:e.clientY });

    if(imgEl && pointers.size === 1){
      gestureStart = snap();
      lastPan = { x:e.clientX, y:e.clientY, ox:offsetX, oy:offsetY };
      lastPinch = null;
    } else if(imgEl && pointers.size === 2){
      gestureStart = snap();
      const pts = Array.from(pointers.values());
      lastPinch = pinchState(pts[0], pts[1]);
      lastPan = null;
    }
  });

  stage.addEventListener("pointermove", (e)=>{
    if(!imgEl) return;
    if(!pointers.has(e.pointerId)) return;

    pointers.set(e.pointerId, { x:e.clientX, y:e.clientY });

    if(pointers.size === 1 && lastPan){
      const dx = e.clientX - lastPan.x;
      const dy = e.clientY - lastPan.y;
      offsetX = lastPan.ox + dx;
      offsetY = lastPan.oy + dy;
      redraw();
      return;
    }

    if(pointers.size === 2 && lastPinch){
      const pts = Array.from(pointers.values());
      const now = pinchState(pts[0], pts[1]);

      const factor = now.dist / (lastPinch.dist || now.dist);
      const rect = stage.getBoundingClientRect();
      const cx = now.midX - rect.left;
      const cy = now.midY - rect.top;

      const beforeX = (cx - offsetX) / scale;
      const beforeY = (cy - offsetY) / scale;

      scale = clamp(scale * factor, 0.1, 12);

      offsetX = cx - beforeX * scale;
      offsetY = cy - beforeY * scale;

      lastPinch = now;
      redraw();
    }
  });

  stage.addEventListener("pointerup", (e)=>{
    pointers.delete(e.pointerId);

    if(pointers.size === 0 && imgEl){
      if(gestureStart && !sameState(gestureStart, snap())){
        pushUndoState(gestureStart);
      }
      gestureStart = null;
    }

    if(pointers.size === 1){
      const pts = Array.from(pointers.values());
      lastPan = { x:pts[0].x, y:pts[0].y, ox:offsetX, oy:offsetY };
      lastPinch = null;
    } else {
      lastPan = null;
      lastPinch = null;
    }
  });

  stage.addEventListener("pointercancel", ()=>{
    pointers.clear();
    lastPan = null;
    lastPinch = null;
    gestureStart = null;
  });

  function pinchState(a,b){
    const dx = a.x - b.x;
    const dy = a.y - b.y;
    const dist = Math.sqrt(dx*dx + dy*dy);
    return { dist, midX:(a.x+b.x)/2, midY:(a.y+b.y)/2 };
  }

  // ========= Download helpers =========
  function downloadBlob(blob, filename){
    const a = document.createElement("a");
    const url = URL.createObjectURL(blob);
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1500);
  }

  function buildName(){
    const stamp = new Date().toISOString().replace(/[:.]/g,"-");
    const ext = $("outFormat").value === "image/png" ? "png" : "jpg";
    const doc = (DOC === "PASS") ? "passport" : "id";
    const mode = (PRINT_MODE === "A4") ? `a4_${A4_COUNT}` : "single";
    return `cf24_${COUNTRY}_${doc}_${mode}_${stamp}.${ext}`;
  }

  function computeCropSourceRect(){
    const cr = cropRectInStage();
    const ix0 = (cr.x - offsetX) / scale;
    const iy0 = (cr.y - offsetY) / scale;
    const ix1 = (cr.x + cr.w - offsetX) / scale;
    const iy1 = (cr.y + cr.h - offsetY) / scale;
    return { ix0, iy0, srcW:(ix1-ix0), srcH:(iy1-iy0) };
  }

  function makeSingleOutputCanvas(){
    if(!imgEl) throw new Error(t().msg_need);
    const p = currentPreset();
    const dpi = parseInt($("dpi").value, 10) || 300;

    const outW = Math.round((p.mmW / 25.4) * dpi);
    const outH = Math.round((p.mmH / 25.4) * dpi);

    const { ix0, iy0, srcW, srcH } = computeCropSourceRect();

    const out = document.createElement("canvas");
    out.width = Math.max(1, outW);
    out.height = Math.max(1, outH);
    const octx = out.getContext("2d", { alpha:true });
    octx.imageSmoothingEnabled = true;
    octx.imageSmoothingQuality = "high";
    octx.drawImage(imgEl, ix0, iy0, srcW, srcH, 0, 0, out.width, out.height);
    return out;
  }

  // Cut lines for A4 (very light grey)
  function drawCutMarks(ctx, x, y, w, h, len, inset){
    // len: mark length, inset: distance from photo edge
    const x0 = x - inset, y0 = y - inset;
    const x1 = x + w + inset, y1 = y + h + inset;

    // top-left
    ctx.beginPath();
    ctx.moveTo(x0, y);
    ctx.lineTo(x0 + len, y);
    ctx.moveTo(x, y0);
    ctx.lineTo(x, y0 + len);

    // top-right
    ctx.moveTo(x1 - len, y);
    ctx.lineTo(x1, y);
    ctx.moveTo(x + w, y0);
    ctx.lineTo(x + w, y0 + len);

    // bottom-left
    ctx.moveTo(x0, y + h);
    ctx.lineTo(x0 + len, y + h);
    ctx.moveTo(x, y1 - len);
    ctx.lineTo(x, y1);

    // bottom-right
    ctx.moveTo(x1 - len, y + h);
    ctx.lineTo(x1, y + h);
    ctx.moveTo(x + w, y1 - len);
    ctx.lineTo(x + w, y1);
    ctx.stroke();
  }

  function makeA4Canvas(){
    if(!imgEl) throw new Error(t().msg_need);
    const p = currentPreset();
    const dpi = parseInt($("dpi").value, 10) || 300;

    const a4W = Math.round((210/25.4) * dpi);
    const a4H = Math.round((297/25.4) * dpi);

    const photoW = Math.round((p.mmW / 25.4) * dpi);
    const photoH = Math.round((p.mmH / 25.4) * dpi);

    const g = a4Grid(A4_COUNT);

    // margins & spacing (in mm)
    const margin = Math.round((10/25.4) * dpi); // ~10mm
    const gap = Math.round((6/25.4) * dpi);     // ~6mm

    const usableW = a4W - margin*2;
    const usableH = a4H - margin*2;

    let cellW = Math.floor((usableW - gap*(g.cols-1)) / g.cols);
    let cellH = Math.floor((usableH - gap*(g.rows-1)) / g.rows);

    // scale down if needed (sheet only)
    const s = Math.min(1, cellW / photoW, cellH / photoH);
    const drawW = Math.floor(photoW * s);
    const drawH = Math.floor(photoH * s);

    const sheet = document.createElement("canvas");
    sheet.width = a4W;
    sheet.height = a4H;

    const sctx = sheet.getContext("2d", { alpha:false });
    sctx.imageSmoothingEnabled = true;
    sctx.imageSmoothingQuality = "high";

    // white page
    sctx.fillStyle = "#ffffff";
    sctx.fillRect(0,0,a4W,a4H);

    // prepare cropped photo once
    const single = makeSingleOutputCanvas();

    const startX = margin + Math.floor((usableW - (cellW*g.cols + gap*(g.cols-1))) / 2);
    const startY = margin + Math.floor((usableH - (cellH*g.rows + gap*(g.rows-1))) / 2);

    let placed = 0;
    const marksLen = Math.round((3/25.4) * dpi);   // 3mm
    const marksInset = Math.round((1/25.4) * dpi); // 1mm
    sctx.strokeStyle = "rgba(0,0,0,.22)";
    sctx.lineWidth = Math.max(1, Math.round(dpi/300));

    for(let r=0; r<g.rows; r++){
      for(let c=0; c<g.cols; c++){
        if(placed >= A4_COUNT) break;
        const cellX = startX + c*(cellW + gap);
        const cellY = startY + r*(cellH + gap);

        const x = cellX + Math.floor((cellW - drawW)/2);
        const y = cellY + Math.floor((cellH - drawH)/2);

        sctx.drawImage(single, 0,0,single.width,single.height, x,y, drawW,drawH);

        // cut marks around each photo
        drawCutMarks(sctx, x, y, drawW, drawH, marksLen, marksInset);

        placed++;
      }
    }
    return sheet;
  }

  function canvasToBlob(canvas){
    const outMime = $("outFormat").value;
    return new Promise((resolve, reject)=>{
      if(outMime === "image/png"){
        canvas.toBlob((b)=> b ? resolve(b) : reject(new Error("toBlob failed")), "image/png");
      }else{
        canvas.toBlob((b)=> b ? resolve(b) : reject(new Error("toBlob failed")), "image/jpeg", 0.92);
      }
    });
  }

  $("downloadBtn").addEventListener("click", async ()=>{
    try{
      const canvas = (PRINT_MODE === "A4") ? makeA4Canvas() : makeSingleOutputCanvas();
      const blob = await canvasToBlob(canvas);
      downloadBlob(blob, buildName());
      setMsg("âœ… " + t().download, "ok");
    }catch(e){
      setMsg((e && e.message) ? e.message : "Download failed", "err");
    }
  });

  // âœ… A4 Print/Safe PDF (open print dialog; user can save as PDF)
  $("printBtn").addEventListener("click", ()=>{
    try{
      if(!imgEl) throw new Error(t().msg_need);
      if(PRINT_MODE !== "A4") throw new Error("Switch to A4 print mode first.");

      const sheet = makeA4Canvas();
      const dataUrl = sheet.toDataURL("image/png");

      const w = window.open("", "_blank");
      if(!w) throw new Error(t().msg_popup);

      w.document.open();
      w.document.write(`
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Print A4</title>
  <style>
    @page { size: A4; margin: 0; }
    html, body { margin:0; padding:0; background:#fff; }
    .page { width: 210mm; height: 297mm; margin:0 auto; }
    img { width: 210mm; height: 297mm; display:block; }
    @media print { .noPrint { display:none !important; } }
    .noPrint{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      padding:10px;
      color:#111;
    }
  </style>
</head>
<body>
  <div class="noPrint">ì¸ì‡„ í™”ë©´ì…ë‹ˆë‹¤. í”„ë¦°í„°ì—ì„œ â€œPDFë¡œ ì €ì¥â€ì„ ì„ íƒí•˜ë©´ PDFë¡œ ì €ì¥ë©ë‹ˆë‹¤.</div>
  <div class="page"><img src="${dataUrl}" alt="A4 sheet"></div>
  <script>
    setTimeout(()=>{ window.focus(); window.print(); }, 300);
  </script>
</body>
</html>
      `);
      w.document.close();
    }catch(e){
      setMsg((e && e.message) ? e.message : "Print failed", "err");
    }
  });

  $("resetBtn").addEventListener("click", ()=>{
    imgEl = null;
    imgW = imgH = 0;
    scale = 1; offsetX = 0; offsetY = 0;
    setMsg("", "");
    clearUndo();
    redraw();
    updateMeta();
    resizeCanvas();
  });

  $("dpi").addEventListener("change", updateMeta);
  $("outFormat").addEventListener("change", updateMeta);

  // init
  setLang(LANG);
  syncToggleUI();
  resizeCanvas();
  refreshPresetPill();
  setPrintMode("SINGLE");
  setA4Count(4);
  $("printBtn").style.display = "none";
})();
</script>
</body>
</html>