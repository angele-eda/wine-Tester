<!doctype html>
<html lang="ko" translate="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>ConvertFiles24 Â· ID Photo / Passport Photo (Local)</title>
  <meta name="description" content="Make ID/Passport photos in your browser. No server upload â€” everything is processed locally." />
  <meta name="robots" content="index,follow" />
  <meta name="theme-color" content="#0b0f17" />
  <link rel="canonical" href="https://convertfiles24.com/id-photo/" />

  <!-- Optional hreflang (lang param style) -->
  <link rel="alternate" hreflang="ko" href="https://convertfiles24.com/id-photo/?lang=ko" />
  <link rel="alternate" hreflang="en" href="https://convertfiles24.com/id-photo/?lang=en" />
  <link rel="alternate" hreflang="es" href="https://convertfiles24.com/id-photo/?lang=es" />
  <link rel="alternate" hreflang="ja" href="https://convertfiles24.com/id-photo/?lang=ja" />
  <link rel="alternate" hreflang="x-default" href="https://convertfiles24.com/id-photo/" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Noto+Sans+KR:wght@400;500;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f17;
      --card:rgba(255,255,255,.03);
      --border:1px solid rgba(255,255,255,.12);
      --radius:16px;
      --pad:16px;
      --text:#e9eef7;
      --muted:#a7b3c7;
      --blue:#2f6df6;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Inter, "Noto Sans KR", system-ui, -apple-system, "Segoe UI", Roboto, "Apple SD Gothic Neo", sans-serif;
      background:var(--bg);
      color:var(--text);
      overflow-x:hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: geometricPrecision;
      font-kerning: normal;
      font-optical-sizing: auto;
    }
    button, input, select, textarea{
      font-family: inherit;
      -webkit-font-smoothing: antialiased;
      text-rendering: geometricPrecision;
    }
    a{ color:#9fb0ca; text-decoration:none; border-bottom:1px dashed rgba(159,176,202,.35); }
    a:hover{ color:#cfe0ff; border-bottom-color:rgba(207,224,255,.6); }

    .wrap{ max-width:980px; margin:0 auto; padding:22px 14px 44px; }
    .top{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      flex-wrap:wrap; margin-bottom:14px;
    }
    .site-title{
      margin:0;
      font-weight:800;
      letter-spacing:-0.35px;
      line-height:1.15;
      color:#ffffff;
      font-size:24px;
    }
    @media (min-width:1024px){ .site-title{ font-size:32px; } }
    @media (max-width:768px){ .site-title{ font-size:20px; letter-spacing:-0.25px; } }

    .sub{ margin:6px 0 0; color:var(--muted); font-size:13px; line-height:1.45; }
    .nav{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end;
    }

    .pill{
      font-size:12px; color:#b8c6dc; border:var(--border);
      padding:8px 10px; border-radius:999px;
      background:rgba(255,255,255,.04);
      white-space:nowrap;
    }

    .homeBtn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:9px 12px;
      border-radius:999px;
      background:rgba(47,109,246,.18);
      border:1px solid rgba(47,109,246,.45);
      color:#e9eef7;
      font-size:12px;
      font-weight:800;
      text-decoration:none;
      box-shadow: 0 10px 26px rgba(0,0,0,.28);
    }
    .homeBtn:hover{
      background:rgba(47,109,246,.25);
      border-color:rgba(47,109,246,.6);
      color:#ffffff;
    }
    .homeIcon{
      width:16px; height:16px; display:inline-block;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.35));
    }

    .langSelect{
      padding:9px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.05);
      color:#e9eef7;
      font-weight:800;
      font-size:12px;
      outline:none;
      cursor:pointer;
    }
    .langSelect option{ background:#0b0f17; color:#e9eef7; }

    .grid{ display:grid; grid-template-columns: 1.05fr .95fr; gap:12px; }
    @media (max-width:860px){ .grid{ grid-template-columns:1fr; } }

    .card{
      border:var(--border);
      background:var(--card);
      border-radius:var(--radius);
      padding:var(--pad);
      min-width:0;
    }
    .card h2{ margin:0 0 10px; font-size:15px; color:#dbe7ff; }

    .drop{
      border:1px dashed rgba(255,255,255,.18);
      border-radius:14px; padding:18px;
      display:flex; align-items:center; justify-content:center; text-align:center;
      background:rgba(255,255,255,.02);
      min-height:210px;
      cursor:pointer; user-select:none;
      transition: background .15s, border-color .15s, box-shadow .15s, transform .05s;
      position: relative;
      overflow:hidden;
    }
    .drop:active{ transform: scale(0.998); }
    .drop.drag{ background:rgba(106,169,255,.12); border-color:rgba(106,169,255,.45); }
    .drop.active{
      border-color: rgba(47,109,246,.55);
      background: rgba(47,109,246,.08);
      box-shadow: 0 0 0 1px rgba(47,109,246,.18), 0 18px 40px rgba(0,0,0,.35);
    }
    .dropEmoji{
      font-size:42px; line-height:1; margin:12px 0 8px;
      filter: drop-shadow(0 10px 22px rgba(0,0,0,.28));
    }
    input[type="file"]{ display:none; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row > *{ flex:1; min-width:160px; }
    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }

    select, input[type="number"]{
      width:100%; padding:12px 12px; border-radius:14px;
      background:rgba(255,255,255,.06);
      color:var(--text); border:var(--border);
      outline:none;
    }
    select{ background-color: #0b0f17; color:#e9eef7; border:1px solid rgba(255,255,255,.2); }
    option{ background-color: #0b0f17; color:#e9eef7; }

    .btn{
      appearance:none; border:none; cursor:pointer;
      background:var(--blue); color:white; font-weight:800;
      padding:12px 14px; border-radius:14px; width:100%;
      font-size:15px;
      letter-spacing:-0.2px;
    }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }
    .btn.secondary{ background:rgba(255,255,255,.10); color:#e9eef7; border:var(--border); }
    .btn.inline{ width:auto; display:inline-flex; align-items:center; gap:8px; justify-content:center; }

    .seg{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-top:8px;
    }
    .seg button{
      border:var(--border);
      background:rgba(255,255,255,.04);
      color:#cfe0ff;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
      font-size:12px;
      white-space:nowrap;
    }
    .seg button.active{
      background:rgba(47,109,246,.22);
      border-color:rgba(47,109,246,.55);
      color:#e9eef7;
    }

    .hint{ margin-top:10px; color:#9fb0ca; font-size:12px; line-height:1.5; }
    .msg{ margin-top:10px; font-size:13px; color:#cfe0ff; }
    .err{ color:#ffb4b4; }
    .ok{ color:#b8ffcc; }

    .editorWrap{
      border:var(--border);
      border-radius:14px;
      overflow:hidden;
      background:rgba(255,255,255,.02);
      position:relative;
      min-height:280px;
    }
    canvas{ display:block; width:100%; height:auto; background:#0a0e16; }

    .controls{
      margin-top:10px;
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }

    .sliderRow{
      display:flex; gap:10px; align-items:center;
      border:var(--border);
      background:rgba(255,255,255,.04);
      padding:10px 12px;
      border-radius:14px;
      flex-wrap:wrap;
    }
    .sliderRow b{ font-size:12px; color:#dbe7ff; width:74px; flex:0 0 auto; }
    input[type="range"]{ width:100%; }

    /* Camera panel */
    .camPanel{
      display:none;
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:10px;
      background:rgba(255,255,255,.02);
      margin-top:10px;
    }
    .camPanel.active{ display:block; }
    .camBar{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin-bottom:10px;
    }
    .camBtns{ display:flex; gap:8px; flex-wrap:wrap; }
    video{
      width:100%;
      border-radius:12px;
      background:#0a0e16;
      border:1px solid rgba(255,255,255,.10);
    }

    .footer{
      margin-top:14px; color:#94a6c2; font-size:12px; text-align:center;
    }

    @media (max-width:420px){
      .nav{ justify-content:flex-start; }
      .homeBtn{ width:100%; justify-content:center; }
      .langSelect{ width:100%; }
      .pill{ width:100%; text-align:center; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1 class="site-title" id="t_title">ConvertFiles24 Â· ì¦ëª…ì‚¬ì§„ / ì—¬ê¶Œì‚¬ì§„</h1>
        <p class="sub" id="t_sub">
          ì—…ë¡œë“œ/ì¹´ë©”ë¼ â†’ ìœ„ì¹˜/í™•ëŒ€ ì¡°ì ˆ â†’ ë‹¤ìš´ë¡œë“œ. <b>ì„œë²„ ì—…ë¡œë“œ ì—†ì´</b> ë¸Œë¼ìš°ì €ì—ì„œ ë¡œì»¬ ì²˜ë¦¬ë©ë‹ˆë‹¤.
        </p>
      </div>

      <div class="nav">
        <a class="homeBtn" href="/" aria-label="Home">
          <svg class="homeIcon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M3 10.5L12 3l9 7.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M5 9.8V21h14V9.8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M9 21v-7h6v7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span id="t_homeBtn">í™ˆìœ¼ë¡œ</span>
        </a>

        <select class="langSelect" id="lang" aria-label="Language">
          <option value="ko">ğŸ‡°ğŸ‡· í•œêµ­ì–´</option>
          <option value="en">ğŸ‡ºğŸ‡¸ English</option>
          <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
          <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
        </select>

        <span class="pill" id="t_localPill">ğŸ”’ Local processing</span>
        <span class="pill" id="presetLabel">Preset: Korea</span>
      </div>
    </div>

    <div class="grid">
      <!-- Left -->
      <div class="card">
        <h2 id="t_step1">1) ì‚¬ì§„ ì—…ë¡œë“œ / ì¹´ë©”ë¼</h2>

        <div class="drop" id="drop" role="button" tabindex="0" aria-label="Choose photo">
          <div style="width:100%;">
            <div style="font-weight:800; margin-bottom:6px;" id="dropTitle">
              ì—¬ê¸°ì— ì‚¬ì§„ì„ ëŒì–´ë‹¤ ë†“ê±°ë‚˜<br/>íƒ­í•´ì„œ ì‚¬ì§„ ì„ íƒ
            </div>
            <div class="dropEmoji" aria-hidden="true">ğŸªª</div>

            <div class="row" style="margin-top:10px;">
              <button class="btn inline" id="pickBtn" type="button">ğŸ“ <span id="t_pick">íŒŒì¼ ì„ íƒ</span></button>
              <button class="btn inline secondary" id="camOpenBtn" type="button">ğŸ“· <span id="t_camOpen">ì¹´ë©”ë¼ ì—´ê¸°</span></button>
            </div>

            <input id="file" type="file" accept="image/*" />

            <div class="hint" id="t_dropHint" style="margin-top:10px;">
              ì§€ì›: JPG, PNG, WebP (HEICëŠ” ê¸°ê¸°/ë¸Œë¼ìš°ì €ì— ë”°ë¼ ì•ˆë  ìˆ˜ ìˆì–´ìš”)
            </div>
          </div>
        </div>

        <!-- Camera panel -->
        <div class="camPanel" id="camPanel" aria-label="Camera panel">
          <div class="camBar">
            <div class="pill" id="t_camTip">ğŸ“· ì¹´ë©”ë¼: ì…€í”¼/í›„ë©´ ì „í™˜ ê°€ëŠ¥</div>
            <div class="camBtns">
              <button class="btn inline secondary" id="camSwitchBtn" type="button">ğŸ”„ <span id="t_camSwitch">ì „í™˜</span></button>
              <button class="btn inline" id="camShotBtn" type="button">ğŸ“¸ <span id="t_camShot">ì´¬ì˜</span></button>
              <button class="btn inline secondary" id="camCloseBtn" type="button">âœ–ï¸ <span id="t_camClose">ë‹«ê¸°</span></button>
            </div>
          </div>
          <video id="video" playsinline autoplay muted></video>
        </div>

        <div style="height:12px;"></div>

        <h2 id="t_step2">2) ë¯¸ë¦¬ë³´ê¸° / í¬ë¡­</h2>
        <div class="editorWrap" id="editorWrap">
          <canvas id="canvas" aria-label="Crop editor"></canvas>
        </div>

        <!-- âœ… 4-country presets -->
        <div class="controls">
          <div class="seg" aria-label="Presets">
            <button type="button" class="presetBtn active" data-preset="kr" id="t_p_kr">ğŸ‡°ğŸ‡· Korea</button>
            <button type="button" class="presetBtn" data-preset="us" id="t_p_us">ğŸ‡ºğŸ‡¸ USA</button>
            <button type="button" class="presetBtn" data-preset="eu" id="t_p_eu">ğŸ‡ªğŸ‡º EU</button>
            <button type="button" class="presetBtn" data-preset="jp" id="t_p_jp">ğŸ‡¯ğŸ‡µ Japan</button>
          </div>

          <div class="sliderRow">
            <b id="t_guide">ê°€ì´ë“œ</b>
            <div style="display:flex; gap:10px; align-items:center; width:100%; flex-wrap:wrap;">
              <label style="display:inline-flex; gap:8px; align-items:center; margin:0; color:#cfe0ff; font-size:12px; cursor:pointer;">
                <input type="checkbox" id="showGuide" checked />
                <span id="t_showGuide">ì–¼êµ´ ê°€ì´ë“œ í‘œì‹œ</span>
              </label>
              <label style="display:inline-flex; gap:8px; align-items:center; margin:0; color:#cfe0ff; font-size:12px; cursor:pointer;">
                <input type="checkbox" id="snapCenter" checked />
                <span id="t_snapCenter">ìë™ ì¤‘ì•™(ê¶Œì¥)</span>
              </label>
            </div>
          </div>

          <div class="sliderRow">
            <b id="t_zoom">í™•ëŒ€</b>
            <input id="zoom" type="range" min="0.2" max="4" step="0.01" value="1" />
          </div>

          <div class="row">
            <div>
              <label id="t_upscale">ì—…ìŠ¤ì¼€ì¼</label>
              <select id="upscaleFactor">
                <option value="1">1Ã— (ê¸°ë³¸)</option>
                <option value="2">2Ã— (ì„ ëª…ë„â†‘)</option>
                <option value="4">4Ã— (ê³ í•´ìƒë„)</option>
              </select>
            </div>
            <div>
              <label id="t_outFormat">ì¶œë ¥ í˜•ì‹</label>
              <select id="outFormat">
                <option value="image/jpeg">JPG</option>
                <option value="image/png">PNG</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label id="t_bgFill">ë°°ê²½ìƒ‰ (JPGì—ì„œ íˆ¬ëª… ëŒ€ì‹  ì±„ì›€)</label>
              <select id="bgFill">
                <option value="#ffffff" id="t_bg1">í°ìƒ‰</option>
                <option value="#e9eef7" id="t_bg2">ì—°í•œ íšŒë°±</option>
                <option value="#cfe0ff" id="t_bg3">ì—°í•œ í•˜ëŠ˜</option>
                <option value="#0b0f17" id="t_bg4">ì–´ë‘ìš´(í…ŒìŠ¤íŠ¸ìš©)</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label id="t_outW">ì¶œë ¥ ê°€ë¡œ(px)</label>
              <input id="outW" type="number" min="64" step="1" />
            </div>
            <div>
              <label id="t_outH">ì¶œë ¥ ì„¸ë¡œ(px)</label>
              <input id="outH" type="number" min="64" step="1" />
            </div>
          </div>

          <div class="row">
            <button class="btn" id="download" disabled>ë‹¤ìš´ë¡œë“œ</button>
            <button class="btn secondary" id="reset" disabled>ì´ˆê¸°í™”</button>
          </div>

          <div class="msg" id="msg"></div>
          <div class="hint" id="t_howto">
            âœ… ì‚¬ìš©ë²•: ì‚¬ì§„ ì—…ë¡œë“œ/ì´¬ì˜ í›„, <b>ì‚¬ì§„ì„ ë“œë˜ê·¸</b>í•´ì„œ ìœ„ì¹˜ë¥¼ ì˜®ê¸°ê³  <b>í™•ëŒ€ ìŠ¬ë¼ì´ë”</b>ë¡œ í¬ê¸°ë¥¼ ë§ì¶”ì„¸ìš”.<br/>
            * ëª¨ë°”ì¼ì—ì„œ ë‘ ì†ê°€ë½ í™•ëŒ€/ì¶•ì†Œ ëŒ€ì‹ , ìŠ¬ë¼ì´ë” ë°©ì‹ì´ë¼ ì•ˆì •ì ì…ë‹ˆë‹¤.
          </div>
        </div>
      </div>

      <!-- Right -->
      <div class="card">
        <h2 id="t_infoTitle">ì„¤ëª…</h2>
        <div class="hint" style="margin-top:0" id="t_info1">
          <b>ì¦ëª…ì‚¬ì§„/ì—¬ê¶Œì‚¬ì§„ì€ â€œë¹„ìœ¨(ê°€ë¡œ:ì„¸ë¡œ)â€ì´ í•µì‹¬</b>ì…ë‹ˆë‹¤.
          í”„ë¦¬ì…‹ì„ ì„ íƒí•˜ë©´ ë¹„ìœ¨ê³¼ ê¶Œì¥ í”½ì…€ì´ ìë™ìœ¼ë¡œ ì„¤ì •ë©ë‹ˆë‹¤.
        </div>

        <div style="height:10px;"></div>

        <div class="hint" id="t_info2">
          <b>4ê°œ êµ­ê°€ í”„ë¦¬ì…‹(ê¶Œì¥ ì¶œë ¥ í¬ê¸°)</b><br/>
          â€¢ Korea: 354Ã—472px (3Ã—4)<br/>
          â€¢ USA: 600Ã—600px (2Ã—2)<br/>
          â€¢ EU(Schengen): 413Ã—531px (35Ã—45mm)<br/>
          â€¢ Japan: 413Ã—531px (35Ã—45mm)
        </div>

        <div style="height:10px;"></div>

        <div class="hint" id="t_info3">
          <b>íŒ</b><br/>
          â€¢ JPGë¡œ ë°›ìœ¼ë©´ ë°°ê²½ìƒ‰ì´ ê¹”ë”í•˜ê²Œ ì±„ì›Œì ¸ìš”.<br/>
          â€¢ PNGëŠ” íˆ¬ëª… ë°°ê²½ì´ ê°€ëŠ¥í•˜ì§€ë§Œ, ì¦ëª…ì‚¬ì§„ì€ ë³´í†µ í° ë°°ê²½ì´ ë§ì•„ì„œ JPG ê¶Œì¥.<br/>
          â€¢ ì—…ìŠ¤ì¼€ì¼ 2Ã—/4Ã—ëŠ” â€œë‹¤ìš´ë¡œë“œ í•´ìƒë„â€ë§Œ í‚¤ìš°ëŠ” ê°„ë‹¨ ì˜µì…˜ì…ë‹ˆë‹¤.
        </div>

        <div style="height:14px;"></div>

        <div class="footer">
          Â© <span id="year"></span> ConvertFiles24 Â·
          <a href="/" id="t_footerHome">Home</a>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  "use strict";
  const $ = (id) => document.getElementById(id);

  // ---- i18n ----
  const I18N = {
    ko: {
      htmlLang:"ko",
      title:"ConvertFiles24 Â· ì¦ëª…ì‚¬ì§„ / ì—¬ê¶Œì‚¬ì§„",
      sub:`ì—…ë¡œë“œ/ì¹´ë©”ë¼ â†’ ìœ„ì¹˜/í™•ëŒ€ ì¡°ì ˆ â†’ ë‹¤ìš´ë¡œë“œ. <b>ì„œë²„ ì—…ë¡œë“œ ì—†ì´</b> ë¸Œë¼ìš°ì €ì—ì„œ ë¡œì»¬ ì²˜ë¦¬ë©ë‹ˆë‹¤.`,
      homeBtn:"í™ˆìœ¼ë¡œ",
      localPill:"ğŸ”’ Local processing",
      presetPill:"Preset: ",
      step1:"1) ì‚¬ì§„ ì—…ë¡œë“œ / ì¹´ë©”ë¼",
      step2:"2) ë¯¸ë¦¬ë³´ê¸° / í¬ë¡­",
      dropTitle:"ì—¬ê¸°ì— ì‚¬ì§„ì„ ëŒì–´ë‹¤ ë†“ê±°ë‚˜<br/>íƒ­í•´ì„œ ì‚¬ì§„ ì„ íƒ",
      dropHint:"ì§€ì›: JPG, PNG, WebP (HEICëŠ” ê¸°ê¸°/ë¸Œë¼ìš°ì €ì— ë”°ë¼ ì•ˆë  ìˆ˜ ìˆì–´ìš”)",
      pick:"íŒŒì¼ ì„ íƒ",
      camOpen:"ì¹´ë©”ë¼ ì—´ê¸°",
      camTip:"ğŸ“· ì¹´ë©”ë¼: ì…€í”¼/í›„ë©´ ì „í™˜ ê°€ëŠ¥",
      camSwitch:"ì „í™˜",
      camShot:"ì´¬ì˜",
      camClose:"ë‹«ê¸°",

      p_kr:"ğŸ‡°ğŸ‡· Korea",
      p_us:"ğŸ‡ºğŸ‡¸ USA",
      p_eu:"ğŸ‡ªğŸ‡º EU",
      p_jp:"ğŸ‡¯ğŸ‡µ Japan",

      guide:"ê°€ì´ë“œ",
      showGuide:"ì–¼êµ´ ê°€ì´ë“œ í‘œì‹œ",
      snapCenter:"ìë™ ì¤‘ì•™(ê¶Œì¥)",
      zoom:"í™•ëŒ€",
      upscale:"ì—…ìŠ¤ì¼€ì¼",
      outFormat:"ì¶œë ¥ í˜•ì‹",
      bgFill:"ë°°ê²½ìƒ‰ (JPGì—ì„œ íˆ¬ëª… ëŒ€ì‹  ì±„ì›€)",
      bg1:"í°ìƒ‰",
      bg2:"ì—°í•œ íšŒë°±",
      bg3:"ì—°í•œ í•˜ëŠ˜",
      bg4:"ì–´ë‘ìš´(í…ŒìŠ¤íŠ¸ìš©)",
      outW:"ì¶œë ¥ ê°€ë¡œ(px)",
      outH:"ì¶œë ¥ ì„¸ë¡œ(px)",
      howto:`âœ… ì‚¬ìš©ë²•: ì‚¬ì§„ ì—…ë¡œë“œ/ì´¬ì˜ í›„, <b>ì‚¬ì§„ì„ ë“œë˜ê·¸</b>í•´ì„œ ìœ„ì¹˜ë¥¼ ì˜®ê¸°ê³  <b>í™•ëŒ€ ìŠ¬ë¼ì´ë”</b>ë¡œ í¬ê¸°ë¥¼ ë§ì¶”ì„¸ìš”.<br/>
             * ëª¨ë°”ì¼ì—ì„œ ë‘ ì†ê°€ë½ í™•ëŒ€/ì¶•ì†Œ ëŒ€ì‹ , ìŠ¬ë¼ì´ë” ë°©ì‹ì´ë¼ ì•ˆì •ì ì…ë‹ˆë‹¤.`,
      infoTitle:"ì„¤ëª…",
      info1:`<b>ì¦ëª…ì‚¬ì§„/ì—¬ê¶Œì‚¬ì§„ì€ â€œë¹„ìœ¨(ê°€ë¡œ:ì„¸ë¡œ)â€ì´ í•µì‹¬</b>ì…ë‹ˆë‹¤.
             í”„ë¦¬ì…‹ì„ ì„ íƒí•˜ë©´ ë¹„ìœ¨ê³¼ ê¶Œì¥ í”½ì…€ì´ ìë™ìœ¼ë¡œ ì„¤ì •ë©ë‹ˆë‹¤.`,
      info2:`<b>4ê°œ êµ­ê°€ í”„ë¦¬ì…‹(ê¶Œì¥ ì¶œë ¥ í¬ê¸°)</b><br/>
             â€¢ Korea: 354Ã—472px (3Ã—4)<br/>
             â€¢ USA: 600Ã—600px (2Ã—2)<br/>
             â€¢ EU(Schengen): 413Ã—531px (35Ã—45mm)<br/>
             â€¢ Japan: 413Ã—531px (35Ã—45mm)`,
      info3:`<b>íŒ</b><br/>
             â€¢ JPGë¡œ ë°›ìœ¼ë©´ ë°°ê²½ìƒ‰ì´ ê¹”ë”í•˜ê²Œ ì±„ì›Œì ¸ìš”.<br/>
             â€¢ PNGëŠ” íˆ¬ëª… ë°°ê²½ì´ ê°€ëŠ¥í•˜ì§€ë§Œ, ì¦ëª…ì‚¬ì§„ì€ ë³´í†µ í° ë°°ê²½ì´ ë§ì•„ì„œ JPG ê¶Œì¥.<br/>
             â€¢ ì—…ìŠ¤ì¼€ì¼ 2Ã—/4Ã—ëŠ” â€œë‹¤ìš´ë¡œë“œ í•´ìƒë„â€ë§Œ í‚¤ìš°ëŠ” ê°„ë‹¨ ì˜µì…˜ì…ë‹ˆë‹¤.`,
      footerHome:"Home",

      msgReady:"ì¤€ë¹„ ì™„ë£Œ! ì‚¬ì§„ì„ ë“œë˜ê·¸í•´ì„œ ìœ„ì¹˜ë¥¼ ë§ì¶”ê³  ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”.",
      msgLoading:"ë¡œë”© ì¤‘â€¦",
      msgCamOpen:"ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•˜ë©´ í™”ë©´ì´ í‘œì‹œë©ë‹ˆë‹¤.",
      msgCamDenied:"ì¹´ë©”ë¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆì–´ìš”. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ í—ˆìš©í•´ ì£¼ì„¸ìš”.",
      errOnlyImg:"ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì§€ì›í•©ë‹ˆë‹¤.",
      errLoadFail:"ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”. ë‹¤ë¥¸ íŒŒì¼ë¡œ ì‹œë„í•´ ì£¼ì„¸ìš”.",
      errSize:"ì¶œë ¥ ê°€ë¡œ/ì„¸ë¡œ(px)ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.",
      errDlFail:"ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.",
      okDlStart:"ë‹¤ìš´ë¡œë“œ ì‹œì‘: "
    },
    en: {
      htmlLang:"en",
      title:"ConvertFiles24 Â· ID/Passport Photo Maker",
      sub:`Upload/Camera â†’ move/zoom â†’ download. <b>No server upload</b> â€” processed locally.`,
      homeBtn:"Home",
      localPill:"ğŸ”’ Local processing",
      presetPill:"Preset: ",
      step1:"1) Upload / Camera",
      step2:"2) Preview / Crop",
      dropTitle:"Drag & drop a photo here<br/>or tap to choose",
      dropHint:"Supported: JPG, PNG, WebP (HEIC may not work on some devices/browsers)",
      pick:"Choose file",
      camOpen:"Open camera",
      camTip:"ğŸ“· Camera: switch selfie/back",
      camSwitch:"Switch",
      camShot:"Capture",
      camClose:"Close",

      p_kr:"ğŸ‡°ğŸ‡· Korea",
      p_us:"ğŸ‡ºğŸ‡¸ USA",
      p_eu:"ğŸ‡ªğŸ‡º EU",
      p_jp:"ğŸ‡¯ğŸ‡µ Japan",

      guide:"Guide",
      showGuide:"Show face guide",
      snapCenter:"Auto center (recommended)",
      zoom:"Zoom",
      upscale:"Upscale",
      outFormat:"Output format",
      bgFill:"Background fill (JPG replaces transparency)",
      bg1:"White",
      bg2:"Light gray",
      bg3:"Light sky",
      bg4:"Dark (test)",
      outW:"Output width (px)",
      outH:"Output height (px)",
      howto:`âœ… How to: Upload/capture, <b>drag</b> to position, use <b>zoom slider</b>.<br/>
             * Slider zoom is stable on mobile.`,
      infoTitle:"Info",
      info1:`<b>Aspect ratio is key</b>. Choosing a preset locks ratio and sets recommended pixels.`,
      info2:`<b>4 presets (recommended)</b><br/>
             â€¢ Korea: 354Ã—472px (3Ã—4)<br/>
             â€¢ USA: 600Ã—600px (2Ã—2)<br/>
             â€¢ EU(Schengen): 413Ã—531px (35Ã—45mm)<br/>
             â€¢ Japan: 413Ã—531px (35Ã—45mm)`,
      info3:`<b>Tips</b><br/>
             â€¢ JPG fills the background neatly.<br/>
             â€¢ PNG can be transparent, but white JPG is common for ID photos.<br/>
             â€¢ Upscale 2Ã—/4Ã— only increases download resolution.`,
      footerHome:"Home",

      msgReady:"Ready! Drag to position and download.",
      msgLoading:"Loadingâ€¦",
      msgCamOpen:"Allow camera permission to see preview.",
      msgCamDenied:"Camera permission denied. Enable it in browser settings.",
      errOnlyImg:"Images only.",
      errLoadFail:"Failed to load image. Try another file.",
      errSize:"Check output width/height (px).",
      errDlFail:"Download failed. Try again.",
      okDlStart:"Downloading: "
    },
    es: {
      htmlLang:"es",
      title:"ConvertFiles24 Â· Fotos para ID/Pasaporte",
      sub:`Archivo/CÃ¡mara â†’ mover/zoom â†’ descargar. <b>Sin subir al servidor</b> â€” procesamiento local.`,
      homeBtn:"Inicio",
      localPill:"ğŸ”’ Procesamiento local",
      presetPill:"Preset: ",
      step1:"1) Subir / CÃ¡mara",
      step2:"2) Vista previa / Recorte",
      dropTitle:"Arrastra y suelta una foto aquÃ­<br/>o toca para elegir",
      dropHint:"Soporta: JPG, PNG, WebP (HEIC puede no funcionar en algunos dispositivos/navegadores)",
      pick:"Elegir archivo",
      camOpen:"Abrir cÃ¡mara",
      camTip:"ğŸ“· CÃ¡mara: cambiar selfie/trasera",
      camSwitch:"Cambiar",
      camShot:"Capturar",
      camClose:"Cerrar",

      p_kr:"ğŸ‡°ğŸ‡· Korea",
      p_us:"ğŸ‡ºğŸ‡¸ USA",
      p_eu:"ğŸ‡ªğŸ‡º EU",
      p_jp:"ğŸ‡¯ğŸ‡µ Japan",

      guide:"GuÃ­a",
      showGuide:"Mostrar guÃ­a de rostro",
      snapCenter:"Centrar automÃ¡tico (recomendado)",
      zoom:"Zoom",
      upscale:"Escalar",
      outFormat:"Formato",
      bgFill:"Relleno de fondo (JPG reemplaza transparencia)",
      bg1:"Blanco",
      bg2:"Gris claro",
      bg3:"Cielo claro",
      bg4:"Oscuro (test)",
      outW:"Ancho (px)",
      outH:"Alto (px)",
      howto:`âœ… CÃ³mo usar: Sube/captura, <b>arrastra</b> para posicionar y usa el <b>slider de zoom</b>.<br/>
             * Zoom por slider es estable en mÃ³vil.`,
      infoTitle:"Info",
      info1:`<b>La proporciÃ³n es clave</b>. Elige un preset para fijar proporciÃ³n y pÃ­xeles recomendados.`,
      info2:`<b>4 presets (recomendado)</b><br/>
             â€¢ Korea: 354Ã—472px (3Ã—4)<br/>
             â€¢ USA: 600Ã—600px (2Ã—2)<br/>
             â€¢ EU(Schengen): 413Ã—531px (35Ã—45mm)<br/>
             â€¢ Japan: 413Ã—531px (35Ã—45mm)`,
      info3:`<b>Consejos</b><br/>
             â€¢ JPG rellena el fondo de forma limpia.<br/>
             â€¢ PNG puede ser transparente, pero JPG blanco es comÃºn.<br/>
             â€¢ 2Ã—/4Ã— solo aumenta la resoluciÃ³n de descarga.`,
      footerHome:"Inicio",

      msgReady:"Â¡Listo! Arrastra para posicionar y descarga.",
      msgLoading:"Cargandoâ€¦",
      msgCamOpen:"Permite la cÃ¡mara para ver la vista previa.",
      msgCamDenied:"Permiso de cÃ¡mara denegado. ActÃ­valo en la configuraciÃ³n del navegador.",
      errOnlyImg:"Solo imÃ¡genes.",
      errLoadFail:"No se pudo cargar. Prueba otro archivo.",
      errSize:"Revisa ancho/alto (px).",
      errDlFail:"Fallo de descarga. Intenta de nuevo.",
      okDlStart:"Descargando: "
    },
    ja: {
      htmlLang:"ja",
      title:"ConvertFiles24 Â· è¨¼æ˜å†™çœŸ / ãƒ‘ã‚¹ãƒãƒ¼ãƒˆå†™çœŸ",
      sub:`ãƒ•ã‚¡ã‚¤ãƒ«/ã‚«ãƒ¡ãƒ© â†’ ç§»å‹•/æ‹¡å¤§ â†’ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€‚<b>ã‚µãƒ¼ãƒãƒ¼é€ä¿¡ãªã—</b>ã§ãƒ­ãƒ¼ã‚«ãƒ«å‡¦ç†ã—ã¾ã™ã€‚`,
      homeBtn:"ãƒ›ãƒ¼ãƒ ",
      localPill:"ğŸ”’ ãƒ­ãƒ¼ã‚«ãƒ«å‡¦ç†",
      presetPill:"Preset: ",
      step1:"1) ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ / ã‚«ãƒ¡ãƒ©",
      step2:"2) ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ / ãƒˆãƒªãƒŸãƒ³ã‚°",
      dropTitle:"ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—<br/>ã¾ãŸã¯ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠ",
      dropHint:"å¯¾å¿œ: JPG, PNG, WebPï¼ˆHEICã¯ç’°å¢ƒã«ã‚ˆã‚Šä¸å¯ã®å ´åˆã‚ã‚Šï¼‰",
      pick:"ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ",
      camOpen:"ã‚«ãƒ¡ãƒ©ã‚’é–‹ã",
      camTip:"ğŸ“· ã‚«ãƒ¡ãƒ©: è‡ªæ’®ã‚Š/èƒŒé¢åˆ‡æ›¿",
      camSwitch:"åˆ‡æ›¿",
      camShot:"æ’®å½±",
      camClose:"é–‰ã˜ã‚‹",

      p_kr:"ğŸ‡°ğŸ‡· Korea",
      p_us:"ğŸ‡ºğŸ‡¸ USA",
      p_eu:"ğŸ‡ªğŸ‡º EU",
      p_jp:"ğŸ‡¯ğŸ‡µ Japan",

      guide:"ã‚¬ã‚¤ãƒ‰",
      showGuide:"é¡”ã‚¬ã‚¤ãƒ‰è¡¨ç¤º",
      snapCenter:"è‡ªå‹•ä¸­å¤®ï¼ˆæ¨å¥¨ï¼‰",
      zoom:"æ‹¡å¤§",
      upscale:"ã‚¢ãƒƒãƒ—ã‚¹ã‚±ãƒ¼ãƒ«",
      outFormat:"å‡ºåŠ›å½¢å¼",
      bgFill:"èƒŒæ™¯è‰²ï¼ˆJPGã¯é€æ˜ã‚’ç½®æ›ï¼‰",
      bg1:"ç™½",
      bg2:"è–„ã„ã‚°ãƒ¬ãƒ¼",
      bg3:"è–„ã„æ°´è‰²",
      bg4:"æš—ã„ï¼ˆãƒ†ã‚¹ãƒˆï¼‰",
      outW:"æ¨ª(px)",
      outH:"ç¸¦(px)",
      howto:`âœ… ä½¿ã„æ–¹ï¼šã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰/æ’®å½±å¾Œã€<b>ãƒ‰ãƒ©ãƒƒã‚°</b>ã§ä½ç½®èª¿æ•´ã€<b>æ‹¡å¤§ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼</b>ã§ã‚µã‚¤ã‚ºèª¿æ•´ã€‚<br/>
             * ãƒ¢ãƒã‚¤ãƒ«ã§ã‚‚å®‰å®šã—ã¾ã™ã€‚`,
      infoTitle:"èª¬æ˜",
      info1:`<b>æ¯”ç‡ï¼ˆç¸¦æ¨ªæ¯”ï¼‰ãŒé‡è¦</b>ã§ã™ã€‚ãƒ—ãƒªã‚»ãƒƒãƒˆã§æ¯”ç‡ã¨æ¨å¥¨ãƒ”ã‚¯ã‚»ãƒ«ã‚’è¨­å®šã—ã¾ã™ã€‚`,
      info2:`<b>4ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆæ¨å¥¨ï¼‰</b><br/>
             â€¢ Korea: 354Ã—472px (3Ã—4)<br/>
             â€¢ USA: 600Ã—600px (2Ã—2)<br/>
             â€¢ EU(Schengen): 413Ã—531px (35Ã—45mm)<br/>
             â€¢ Japan: 413Ã—531px (35Ã—45mm)`,
      info3:`<b>ãƒ’ãƒ³ãƒˆ</b><br/>
             â€¢ JPGã¯èƒŒæ™¯ãŒç¶ºéº—ã«å¡—ã‚Šã¤ã¶ã•ã‚Œã¾ã™ã€‚<br/>
             â€¢ PNGã¯é€æ˜å¯ã§ã™ãŒã€ç™½èƒŒæ™¯JPGãŒä¸€èˆ¬çš„ã§ã™ã€‚<br/>
             â€¢ 2Ã—/4Ã—ã¯ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰è§£åƒåº¦ã‚’ä¸Šã’ã‚‹ç°¡æ˜“ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã™ã€‚`,
      footerHome:"Home",

      msgReady:"æº–å‚™å®Œäº†ï¼ãƒ‰ãƒ©ãƒƒã‚°ã§èª¿æ•´ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚",
      msgLoading:"èª­ã¿è¾¼ã¿ä¸­â€¦",
      msgCamOpen:"ã‚«ãƒ¡ãƒ©è¨±å¯ã‚’ã™ã‚‹ã¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚",
      msgCamDenied:"ã‚«ãƒ¡ãƒ©è¨±å¯ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã§è¨±å¯ã—ã¦ãã ã•ã„ã€‚",
      errOnlyImg:"ç”»åƒã®ã¿å¯¾å¿œã§ã™ã€‚",
      errLoadFail:"ç”»åƒã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚åˆ¥ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§è©¦ã—ã¦ãã ã•ã„ã€‚",
      errSize:"å‡ºåŠ›ã‚µã‚¤ã‚º(px)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚",
      errDlFail:"ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚",
      okDlStart:"ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–‹å§‹: "
    }
  };

  function setText(id, html){ const el=$(id); if(el) el.innerHTML = html; }
  function setPlain(id, text){ const el=$(id); if(el) el.textContent = text; }

  // ---- Year ----
  $("year").textContent = new Date().getFullYear();

  // ---- Elements ----
  const drop = $("drop");
  const fileInput = $("file");
  const pickBtn = $("pickBtn");
  const camOpenBtn = $("camOpenBtn");
  const camPanel = $("camPanel");
  const camSwitchBtn = $("camSwitchBtn");
  const camShotBtn = $("camShotBtn");
  const camCloseBtn = $("camCloseBtn");
  const video = $("video");

  const canvas = $("canvas");
  const wrap = $("editorWrap");

  const outFormat = $("outFormat");
  const bgFill = $("bgFill");
  const outW = $("outW");
  const outH = $("outH");
  const zoomEl = $("zoom");
  const showGuide = $("showGuide");
  const snapCenter = $("snapCenter");
  const upscaleFactorEl = $("upscaleFactor");

  const presetLabel = $("presetLabel");
  const btnDownload = $("download");
  const btnReset = $("reset");
  const msg = $("msg");

  const ctx = canvas.getContext("2d", { alpha: true });

  function setMsg(text, type){
    msg.textContent = text || "";
    msg.className = "msg " + (type || "");
  }
  function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

  // ---- Presets (4 countries; China removed) ----
  const PRESETS = {
    kr: { name:"Korea (3Ã—4)", ratio: 3/4,   outW: 354, outH: 472, guide: { headTop: 0.18, chin: 0.76 } },
    us: { name:"USA (2Ã—2)",   ratio: 1,     outW: 600, outH: 600, guide: { headTop: 0.18, chin: 0.78 } },
    eu: { name:"EU (35Ã—45)",  ratio: 35/45, outW: 413, outH: 531, guide: { headTop: 0.16, chin: 0.78 } },
    jp: { name:"Japan (35Ã—45)",ratio:35/45, outW: 413, outH: 531, guide: { headTop: 0.16, chin: 0.78 } }
  };

  // ---- State ----
  let presetKey = "kr";
  let img = null;
  let imgW = 0, imgH = 0;

  // pan offsets in image pixels (relative to image center)
  let panX = 0, panY = 0;
  let isDragging = false;
  let dragStart = { x:0, y:0, panX:0, panY:0 };

  // editor render size
  let viewW = 0, viewH = 0;
  let dpr = Math.max(1, window.devicePixelRatio || 1);

  // crop rect in view pixels
  let crop = { x:0, y:0, w:0, h:0 };

  // i18n runtime
  function applyLang(lang){
    const t = I18N[lang] || I18N.ko;
    document.documentElement.lang = t.htmlLang;

    setPlain("t_title", t.title);
    setText("t_sub", t.sub);
    setPlain("t_homeBtn", t.homeBtn);
    setPlain("t_localPill", t.localPill);

    setPlain("t_step1", t.step1);
    setPlain("t_step2", t.step2);
    setText("dropTitle", t.dropTitle);
    setPlain("t_dropHint", t.dropHint);

    setPlain("t_pick", t.pick);
    setPlain("t_camOpen", t.camOpen);
    setPlain("t_camTip", t.camTip);
    setPlain("t_camSwitch", t.camSwitch);
    setPlain("t_camShot", t.camShot);
    setPlain("t_camClose", t.camClose);

    setPlain("t_p_kr", t.p_kr);
    setPlain("t_p_us", t.p_us);
    setPlain("t_p_eu", t.p_eu);
    setPlain("t_p_jp", t.p_jp);

    setPlain("t_guide", t.guide);
    setPlain("t_showGuide", t.showGuide);
    setPlain("t_snapCenter", t.snapCenter);
    setPlain("t_zoom", t.zoom);
    setPlain("t_upscale", t.upscale);
    setPlain("t_outFormat", t.outFormat);
    setPlain("t_bgFill", t.bgFill);

    setPlain("t_bg1", t.bg1);
    setPlain("t_bg2", t.bg2);
    setPlain("t_bg3", t.bg3);
    setPlain("t_bg4", t.bg4);

    setPlain("t_outW", t.outW);
    setPlain("t_outH", t.outH);
    setText("t_howto", t.howto);

    setPlain("t_infoTitle", t.infoTitle);
    setText("t_info1", t.info1);
    setText("t_info2", t.info2);
    setText("t_info3", t.info3);

    setPlain("t_footerHome", t.footerHome);

    window.__T = t;
    updatePresetPill();
  }

  function updatePresetPill(){
    const t = window.__T || I18N.ko;
    presetLabel.textContent = (t.presetPill || "Preset: ") + (PRESETS[presetKey]?.name || "Korea");
  }

  // ---- Preset selection ----
  function setPreset(key){
    if(!PRESETS[key]) key = "kr";
    presetKey = key;

    localStorage.setItem("cf24_idphoto_preset", presetKey);

    document.querySelectorAll(".presetBtn").forEach(b=>{
      b.classList.toggle("active", b.dataset.preset === key);
    });

    const p = PRESETS[key];
    outW.value = p.outW;
    outH.value = p.outH;

    updatePresetPill();
    layoutCanvas();
    if(img && snapCenter.checked){
      panX = 0; panY = 0;
    }
    render();
  }

  // ---- Upload/open ----
  function openPicker(){
    fileInput.value = "";
    fileInput.click();
  }
  pickBtn.addEventListener("click", openPicker);
  drop.addEventListener("click", openPicker);
  drop.addEventListener("keydown", (e)=>{
    if(e.key === "Enter" || e.key === " "){
      e.preventDefault();
      openPicker();
    }
  });

  ["dragenter","dragover"].forEach(evt=>{
    drop.addEventListener(evt, (e)=>{
      e.preventDefault(); e.stopPropagation();
      drop.classList.add("drag");
    });
  });
  ["dragleave","drop"].forEach(evt=>{
    drop.addEventListener(evt, (e)=>{
      e.preventDefault(); e.stopPropagation();
      drop.classList.remove("drag");
    });
  });
  drop.addEventListener("drop", (e)=>{
    const f = e.dataTransfer.files && e.dataTransfer.files[0];
    if(f) loadFile(f);
  });

  fileInput.addEventListener("change", (e)=>{
    const f = e.target.files && e.target.files[0];
    if(f) loadFile(f);
  });

  function loadFile(file){
    if(!file || !(file.type || "").startsWith("image/")){
      setMsg((window.__T?.errOnlyImg) || "Images only.", "err");
      return;
    }

    setMsg((window.__T?.msgLoading) || "Loadingâ€¦", "");
    const url = URL.createObjectURL(file);
    const im = new Image();
    im.onload = () => {
      URL.revokeObjectURL(url);

      img = im;
      imgW = im.naturalWidth || 0;
      imgH = im.naturalHeight || 0;

      panX = 0; panY = 0;
      zoomEl.value = "1";

      drop.classList.add("active");
      btnDownload.disabled = false;
      btnReset.disabled = false;

      layoutCanvas();
      render();
      setMsg((window.__T?.msgReady) || "Ready.", "ok");

      // close camera if open
      stopCamera();
    };
    im.onerror = () => {
      URL.revokeObjectURL(url);
      setMsg((window.__T?.errLoadFail) || "Failed to load.", "err");
    };
    im.src = url;
  }

  // ---- SessionStorage bridge (from main convert page Crop button) ----
  function tryLoadFromSession(){
    try{
      const dataUrl = sessionStorage.getItem("cf24_idphoto_img");
      if(!dataUrl) return false;

      const im = new Image();
      setMsg((window.__T?.msgLoading) || "Loadingâ€¦", "");
      im.onload = () => {
        img = im;
        imgW = im.naturalWidth || 0;
        imgH = im.naturalHeight || 0;
        panX = 0; panY = 0;
        zoomEl.value = "1";
        drop.classList.add("active");
        btnDownload.disabled = false;
        btnReset.disabled = false;
        layoutCanvas();
        render();
        setMsg((window.__T?.msgReady) || "Ready.", "ok");
      };
      im.onerror = () => {
        setMsg((window.__T?.errLoadFail) || "Failed to load.", "err");
      };
      im.src = dataUrl;

      // clear so it doesn't keep overriding
      sessionStorage.removeItem("cf24_idphoto_img");
      sessionStorage.removeItem("cf24_idphoto_name");
      return true;
    }catch(_){
      return false;
    }
  }

  // ---- Canvas layout ----
  function layoutCanvas(){
    const rect = wrap.getBoundingClientRect();
    viewW = Math.max(320, Math.floor(rect.width));
    const minH = window.matchMedia("(min-width: 1024px)").matches ? 420 : 320;
    viewH = Math.max(minH, Math.floor(rect.width * 0.72));
    viewH = Math.min(viewH, 520);

    dpr = Math.max(1, window.devicePixelRatio || 1);

    canvas.width = Math.floor(viewW * dpr);
    canvas.height = Math.floor(viewH * dpr);
    canvas.style.width = viewW + "px";
    canvas.style.height = viewH + "px";

    const pad = 18;
    const maxW = viewW - pad*2;
    const maxH = viewH - pad*2;

    const ratio = PRESETS[presetKey].ratio;

    let cw = maxW;
    let ch = cw / ratio;
    if(ch > maxH){
      ch = maxH;
      cw = ch * ratio;
    }

    crop.w = cw;
    crop.h = ch;
    crop.x = (viewW - cw) / 2;
    crop.y = (viewH - ch) / 2;
  }

  window.addEventListener("resize", ()=>{
    layoutCanvas();
    render();
  });

  // ---- Drag to pan ----
  function toLocal(e){
    const r = canvas.getBoundingClientRect();
    return { x: e.clientX - r.left, y: e.clientY - r.top };
  }

  canvas.addEventListener("pointerdown", (e)=>{
    if(!img) return;
    isDragging = true;
    canvas.setPointerCapture(e.pointerId);
    const p = toLocal(e);
    dragStart = { x:p.x, y:p.y, panX, panY };
  });

  canvas.addEventListener("pointermove", (e)=>{
    if(!img || !isDragging) return;
    const p = toLocal(e);

    const zoom = parseFloat(zoomEl.value || "1");
    const base = baseCoverScale();
    const scale = base * zoom;

    const dxView = p.x - dragStart.x;
    const dyView = p.y - dragStart.y;

    const dxImg = dxView / scale;
    const dyImg = dyView / scale;

    panX = dragStart.panX + dxImg;
    panY = dragStart.panY + dyImg;

    render();
  });

  function endDrag(e){
    if(!isDragging) return;
    isDragging = false;
    try{ canvas.releasePointerCapture(e.pointerId); }catch(_){}
  }
  canvas.addEventListener("pointerup", endDrag);
  canvas.addEventListener("pointercancel", endDrag);
  canvas.addEventListener("pointerleave", endDrag);

  zoomEl.addEventListener("input", ()=> render());
  showGuide.addEventListener("change", ()=> render());
  snapCenter.addEventListener("change", ()=>{
    if(snapCenter.checked){
      panX = 0; panY = 0;
      render();
    }
  });

  // ---- Rendering ----
  function baseCoverScale(){
    if(!img) return 1;
    const scaleX = crop.w / imgW;
    const scaleY = crop.h / imgH;
    return Math.max(scaleX, scaleY);
  }

  function render(){
    const cw = canvas.width;
    const ch = canvas.height;

    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0,0,cw,ch);

    ctx.scale(dpr, dpr);

    ctx.fillStyle = "#0a0e16";
    ctx.fillRect(0,0,viewW,viewH);

    if(img){
      const zoom = parseFloat(zoomEl.value || "1");
      const base = baseCoverScale();
      const scale = base * zoom;

      const cropCx = crop.x + crop.w/2;
      const cropCy = crop.y + crop.h/2;

      const drawW = imgW * scale;
      const drawH = imgH * scale;

      const panVX = panX * scale;
      const panVY = panY * scale;

      const drawX = cropCx - drawW/2 + panVX;
      const drawY = cropCy - drawH/2 + panVY;

      ctx.drawImage(img, drawX, drawY, drawW, drawH);

      // darken outside crop
      ctx.save();
      ctx.fillStyle = "rgba(0,0,0,.55)";
      ctx.fillRect(0,0,viewW,crop.y);
      ctx.fillRect(0,crop.y+crop.h,viewW,viewH-(crop.y+crop.h));
      ctx.fillRect(0,crop.y,crop.x,crop.h);
      ctx.fillRect(crop.x+crop.w,crop.y,viewW-(crop.x+crop.w),crop.h);
      ctx.restore();

      // crop border
      ctx.save();
      ctx.strokeStyle = "rgba(47,109,246,.85)";
      ctx.lineWidth = 2;
      ctx.strokeRect(crop.x, crop.y, crop.w, crop.h);
      ctx.restore();

      // guide lines
      if(showGuide.checked){
        const g = PRESETS[presetKey].guide;
        ctx.save();
        ctx.strokeStyle = "rgba(255,255,255,.55)";
        ctx.lineWidth = 1;
        ctx.setLineDash([6,6]);

        const yHead = crop.y + crop.h * g.headTop;
        const yChin = crop.y + crop.h * g.chin;

        ctx.beginPath(); ctx.moveTo(crop.x, yHead); ctx.lineTo(crop.x+crop.w, yHead); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(crop.x, yChin); ctx.lineTo(crop.x+crop.w, yChin); ctx.stroke();

        ctx.setLineDash([4,7]);
        const xMid = crop.x + crop.w/2;
        ctx.beginPath(); ctx.moveTo(xMid, crop.y); ctx.lineTo(xMid, crop.y+crop.h); ctx.stroke();
        ctx.restore();
      }

      // corners
      ctx.save();
      ctx.strokeStyle = "rgba(47,109,246,.95)";
      ctx.lineWidth = 3;
      const c = 16;
      ctx.beginPath(); ctx.moveTo(crop.x, crop.y+c); ctx.lineTo(crop.x, crop.y); ctx.lineTo(crop.x+c, crop.y); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(crop.x+crop.w-c, crop.y); ctx.lineTo(crop.x+crop.w, crop.y); ctx.lineTo(crop.x+crop.w, crop.y+c); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(crop.x, crop.y+crop.h-c); ctx.lineTo(crop.x, crop.y+crop.h); ctx.lineTo(crop.x+c, crop.y+crop.h); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(crop.x+crop.w-c, crop.y+crop.h); ctx.lineTo(crop.x+crop.w, crop.y+crop.h); ctx.lineTo(crop.x+crop.w, crop.y+crop.h-c); ctx.stroke();
      ctx.restore();

    } else {
      ctx.save();
      ctx.fillStyle = "rgba(255,255,255,.65)";
      ctx.font = "800 16px Inter, Noto Sans KR, sans-serif";
      ctx.fillText("Preview", 24, 42);
      ctx.fillStyle = "rgba(255,255,255,.45)";
      ctx.font = "600 12px Inter, Noto Sans KR, sans-serif";
      ctx.fillText("Upload or capture a photo to start cropping.", 24, 68);
      ctx.restore();
    }
  }

  // ---- Export + Upscale ----
  function exportCropped(){
    if(!img) return;

    const baseW = parseInt(outW.value, 10);
    const baseH = parseInt(outH.value, 10);
    if(!baseW || !baseH || baseW < 64 || baseH < 64){
      setMsg((window.__T?.errSize) || "Check output size.", "err");
      return;
    }

    const factor = parseInt(upscaleFactorEl.value || "1", 10);
    const targetW = baseW * factor;
    const targetH = baseH * factor;

    const out = document.createElement("canvas");
    out.width = targetW;
    out.height = targetH;
    const octx = out.getContext("2d", { alpha: true });

    const mime = outFormat.value;
    const fill = bgFill.value;

    if(mime === "image/jpeg"){
      octx.fillStyle = fill;
      octx.fillRect(0,0,targetW,targetH);
    }

    const zoom = parseFloat(zoomEl.value || "1");
    const base = baseCoverScale();
    const scale = base * zoom;

    const cropCx = crop.x + crop.w/2;
    const cropCy = crop.y + crop.h/2;

    const drawW = imgW * scale;
    const drawH = imgH * scale;

    const panVX = panX * scale;
    const panVY = panY * scale;

    const drawX = cropCx - drawW/2 + panVX;
    const drawY = cropCy - drawH/2 + panVY;

    // source rect in image pixels
    const sx = (crop.x - drawX) / scale;
    const sy = (crop.y - drawY) / scale;
    const sw = crop.w / scale;
    const sh = crop.h / scale;

    const sx2 = clamp(sx, -imgW, imgW*2);
    const sy2 = clamp(sy, -imgH, imgH*2);

    octx.imageSmoothingEnabled = true;
    octx.imageSmoothingQuality = "high";
    octx.drawImage(img, sx2, sy2, sw, sh, 0, 0, targetW, targetH);

    const ext = (mime === "image/png") ? "png" : "jpg";
    const name = `${presetKey}_x${factor}_` + new Date().toISOString().replace(/[:.]/g,"-") + "." + ext;

    out.toBlob((blob)=>{
      if(!blob){
        setMsg((window.__T?.errDlFail) || "Download failed.", "err");
        return;
      }
      const a = document.createElement("a");
      const url = URL.createObjectURL(blob);
      a.href = url;
      a.download = name;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 1500);
      setMsg(((window.__T?.okDlStart) || "Downloading: ") + name, "ok");
    }, mime, 0.92);
  }

  // ---- Buttons ----
  btnDownload.addEventListener("click", exportCropped);

  btnReset.addEventListener("click", ()=>{
    img = null; imgW = 0; imgH = 0;
    panX = 0; panY = 0;
    zoomEl.value = "1";
    fileInput.value = "";

    drop.classList.remove("active");
    btnDownload.disabled = true;
    btnReset.disabled = true;

    setMsg("", "");
    layoutCanvas();
    render();
    stopCamera();
  });

  document.querySelectorAll(".presetBtn").forEach(b=>{
    b.addEventListener("click", ()=> setPreset(b.dataset.preset));
  });

  function syncSizeKeepRatio(changed){
    const ratio = PRESETS[presetKey].ratio;
    const w = parseInt(outW.value, 10);
    const h = parseInt(outH.value, 10);
    if(changed === "w" && w){
      outH.value = Math.round(w / ratio);
    }
    if(changed === "h" && h){
      outW.value = Math.round(h * ratio);
    }
  }
  outW.addEventListener("input", ()=> syncSizeKeepRatio("w"));
  outH.addEventListener("input", ()=> syncSizeKeepRatio("h"));

  // ---- Language init (supports ?lang=xx) + persist ----
  const langSel = $("lang");
  function getLangFromUrl(){
    try{
      const u = new URL(location.href);
      const v = (u.searchParams.get("lang") || "").toLowerCase();
      return ["ko","en","es","ja"].includes(v) ? v : null;
    }catch(_){ return null; }
  }
  const storedLang = localStorage.getItem("cf24_lang");
  const initLang = getLangFromUrl() || (storedLang && ["ko","en","es","ja"].includes(storedLang) ? storedLang : "ko");
  langSel.value = initLang;
  applyLang(initLang);

  langSel.addEventListener("change", ()=>{
    const v = langSel.value;
    applyLang(v);
    localStorage.setItem("cf24_lang", v);
    try{
      const u = new URL(location.href);
      u.searchParams.set("lang", v);
      history.replaceState({}, "", u.toString());
    }catch(_){}
  });

  // ---- Camera (getUserMedia) ----
  let stream = null;
  let facingMode = "user"; // "user" (selfie) or "environment"

  async function openCamera(){
    if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
      setMsg("Camera not supported on this browser.", "err");
      return;
    }
    setMsg((window.__T?.msgCamOpen) || "Allow camera permission.", "");

    try{
      stopCamera();

      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: facingMode }, width: { ideal: 1280 }, height: { ideal: 720 } },
        audio: false
      });

      video.srcObject = stream;
      camPanel.classList.add("active");
      drop.classList.add("active");
    }catch(e){
      setMsg((window.__T?.msgCamDenied) || "Camera permission denied.", "err");
      camPanel.classList.remove("active");
      stream = null;
    }
  }

  function stopCamera(){
    if(stream){
      try{
        stream.getTracks().forEach(t => t.stop());
      }catch(_){}
    }
    stream = null;
    if(video) video.srcObject = null;
    camPanel.classList.remove("active");
  }

  function captureFromCamera(){
    if(!video || !stream) return;

    const vw = video.videoWidth || 1280;
    const vh = video.videoHeight || 720;

    const cap = document.createElement("canvas");
    cap.width = vw;
    cap.height = vh;
    const cctx = cap.getContext("2d", { alpha: false });

    // Some selfie cameras are mirrored in preview; we keep captured image as "what you see"
    // by mirroring when facingMode is "user".
    if(facingMode === "user"){
      cctx.translate(vw, 0);
      cctx.scale(-1, 1);
    }

    cctx.drawImage(video, 0, 0, vw, vh);
    const dataUrl = cap.toDataURL("image/jpeg", 0.95);

    const im = new Image();
    setMsg((window.__T?.msgLoading) || "Loadingâ€¦", "");
    im.onload = () => {
      img = im;
      imgW = im.naturalWidth || 0;
      imgH = im.naturalHeight || 0;
      panX = 0; panY = 0;
      zoomEl.value = "1";
      btnDownload.disabled = false;
      btnReset.disabled = false;
      layoutCanvas();
      render();
      setMsg((window.__T?.msgReady) || "Ready.", "ok");
      stopCamera();
    };
    im.onerror = () => setMsg((window.__T?.errLoadFail) || "Failed to load.", "err");
    im.src = dataUrl;
  }

  camOpenBtn.addEventListener("click", openCamera);
  camCloseBtn.addEventListener("click", stopCamera);
  camSwitchBtn.addEventListener("click", async ()=>{
    facingMode = (facingMode === "user") ? "environment" : "user";
    await openCamera();
  });
  camShotBtn.addEventListener("click", captureFromCamera);

  // mirror video preview for selfie (so UX feels natural)
  function updateVideoMirror(){
    video.style.transform = (facingMode === "user") ? "scaleX(-1)" : "none";
  }
  const _openCameraOriginal = openCamera;
  openCamera = async function(){
    await _openCameraOriginal();
    updateVideoMirror();
  };

  // ---- Init ----
  // preset init: url ?preset=kr/us/eu/jp OR localStorage
  function getPresetFromUrl(){
    try{
      const u = new URL(location.href);
      const v = (u.searchParams.get("preset") || "").toLowerCase();
      return PRESETS[v] ? v : null;
    }catch(_){ return null; }
  }
  const storedPreset = localStorage.getItem("cf24_idphoto_preset");
  presetKey = getPresetFromUrl() || (storedPreset && PRESETS[storedPreset] ? storedPreset : "kr");

  layoutCanvas();
  render();
  setPreset(presetKey);

  // try loading from main page "Crop" bridge
  tryLoadFromSession();
})();
</script>
</body>
</html>