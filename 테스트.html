<!doctype html>
<html lang="en" translate="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Merge PDF | ConvertFiles24</title>
  <meta name="description" content="Merge PDFs instantly in your browser. 100% local processing (no server upload)." />
  <meta name="robots" content="index,follow" />
  <meta name="theme-color" content="#0b0f17" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Noto+Sans+KR:wght@400;500;700;800&display=swap" rel="stylesheet">

  <!-- PDF-Lib (client-side merge) -->
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

  <style>
    :root{
      --radius:16px;
      --pad:16px;
      --border:1px solid rgba(255,255,255,.12);
      --blue: 47,109,246;
      --ease: cubic-bezier(.2,.8,.2,1);
    }
    *{ box-sizing:border-box; }
    html, body{ width:100%; max-width:100%; overflow-x:hidden; }
    body{
      margin:0;
      font-family: Inter, "Noto Sans KR", system-ui, -apple-system, "Segoe UI", Roboto, "Apple SD Gothic Neo", sans-serif;
      background:#0b0f17;
      color:#e9eef7;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: geometricPrecision;
    }

    /* entrance */
    body:not(.loaded) .card, body:not(.loaded) .top{ opacity:0; transform: translateY(8px); }
    body.loaded .top{ animation: cfFadeUp .35s var(--ease) both; }
    body.loaded .card{ animation: cfFadeUp .38s var(--ease) both; }
    @keyframes cfFadeUp{ from{opacity:0; transform:translateY(8px);} to{opacity:1; transform:translateY(0);} }
    @media (prefers-reduced-motion: reduce){
      *{ animation:none !important; transition:none !important; scroll-behavior:auto !important; }
      body:not(.loaded) .card, body:not(.loaded) .top{ opacity:1; transform:none; }
    }

    .wrap{
      max-width:980px;
      width:100%;
      margin:0 auto;
      padding:22px 14px 44px;
      overflow-x: clip;
    }

    .top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
      margin-bottom:14px;
      min-width:0;
    }

    .title{
      margin:0;
      font-weight:900;
      letter-spacing:-0.35px;
      line-height:1.15;
      color:#ffffff;
      font-size:22px;
    }
    .sub{
      margin:8px 0 0;
      color:#a7b3c7;
      font-size:13px;
      line-height:1.45;
    }

    .homeBtn{
      width:100%;
      display:flex; align-items:center; justify-content:center; gap:10px;
      padding:12px 14px;
      border-radius:999px;
      border:1px solid rgba(47,109,246,.55);
      background:rgba(47,109,246,.18);
      color:#e9eef7;
      font-weight:900;
      cursor:pointer;
      text-decoration:none;
      user-select:none;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
      max-width:380px;
      transition: transform .08s var(--ease), background .12s var(--ease), box-shadow .12s var(--ease);
    }
    .homeBtn:hover{ background:rgba(47,109,246,.24); }
    .homeBtn:active{ transform: scale(.99); }
    .homeBtn:focus-visible{
      outline:none;
      box-shadow: 0 0 0 3px rgba(var(--blue),.35), 0 10px 24px rgba(0,0,0,.25);
    }

    .langRow{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:8px;
      min-width:220px;
      max-width:100%;
      margin-left:auto;
    }
    .langLabel{
      font-size:12px;
      font-weight:900;
      color:#9fb0ca;
      letter-spacing:-0.2px;
      display:flex;
      align-items:center;
      gap:8px;
      opacity:.95;
    }
    .langSelect{
      width:220px;
      max-width:100%;
      padding:12px 12px;
      border-radius:999px;
      border:var(--border);
      background:rgba(255,255,255,.06);
      color:#e9eef7;
      outline:none;
      font-weight:900;
      transition: box-shadow .12s var(--ease), border-color .12s var(--ease), transform .08s var(--ease);
    }
    .langSelect:focus-visible{
      outline:none;
      border-color: rgba(var(--blue), .55);
      box-shadow: 0 0 0 3px rgba(var(--blue),.25);
    }
    option{ background:#0b0f17; color:#e9eef7; }
    @media (max-width: 420px){
      .langRow{ min-width:180px; }
      .langSelect{ width:180px; }
    }

    .pill{
      width:100%;
      border:1px solid rgba(120, 200, 255, .22);
      background:rgba(120, 200, 255, .06);
      border-radius:999px;
      padding:10px 14px;
      color:#cfe6ff;
      font-size:13px;
      font-weight:900;
      display:flex; align-items:center; justify-content:center; gap:10px;
      min-width:0;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
    }

    .card{
      border:var(--border);
      background:rgba(255,255,255,.03);
      border-radius:var(--radius);
      padding:var(--pad);
      margin-top:12px;
      min-width:0;
      max-width:100%;
      overflow-x: clip;
      will-change: transform, opacity;
    }
    .card h2{
      margin:0 0 10px;
      font-size:15px;
      color:#dbe7ff;
      letter-spacing:-0.2px;
      line-height:1.2;
    }

    .stageWrap{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:12px;
      min-width:0;
      max-width:100%;
    }
    @media (max-width: 860px){ .stageWrap{ grid-template-columns: 1fr; } }

    /* Upload box */
    .uploadBox{
      border: 1px dashed rgba(255,255,255,0.22);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.08);
      background: rgba(0,0,0,.20);
      border-radius: 16px;
      padding: 18px 14px;
      min-height: 170px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      gap:10px;
      text-align:center;
      user-select:none;
      cursor:pointer;
      transition: transform .08s var(--ease), border-color .12s var(--ease), background .12s var(--ease), box-shadow .12s var(--ease);
    }
    .uploadBox:hover{
      background: rgba(47,109,246,.06);
      border-color: rgba(47,109,246,.35);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.10);
    }
    .uploadBox:active{ transform: scale(.995); }
    .uploadBox.drag{
      background: rgba(47,109,246,.10);
      border-color: rgba(47,109,246,.55);
      box-shadow: 0 0 0 3px rgba(var(--blue),.20), inset 0 0 0 1px rgba(255,255,255,0.10);
    }
    .uploadTitle{
      font-weight:900;
      color:#e9eef7;
      letter-spacing:-.2px;
    }
    .uploadSub{
      color:#a7b3c7;
      font-size:12px;
      line-height:1.45;
    }

    /* Buttons */
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      min-width:0;
    }
    .row > *{ flex:1; min-width:160px; max-width:100%; min-width:0; }

    .btn{
      appearance:none; border:none; cursor:pointer;
      background:#2f6df6; color:white; font-weight:900;
      padding:12px 14px; border-radius:14px; width:100%;
      font-size:14px;
      letter-spacing: -0.2px;
      user-select:none;
      transition: transform .08s var(--ease), filter .12s var(--ease), box-shadow .12s var(--ease), background .12s var(--ease), border-color .12s var(--ease);
    }
    .btn:hover{ filter: brightness(1.02); }
    .btn:active{ transform: scale(.99); }
    .btn:focus-visible{ outline:none; box-shadow: 0 0 0 3px rgba(var(--blue),.22); }
    .btn:disabled{ opacity:.45; cursor:not-allowed; transform:none; filter:none; box-shadow:none; }

    .btn.secondary{
      background: rgba(47,109,246,.14);
      color:#e9eef7;
      border: 1px solid rgba(47,109,246,.30);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
    }
    .btn.secondary:hover{
      background: rgba(47,109,246,.18);
      border-color: rgba(47,109,246,.36);
    }

    /* List */
    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
      min-width:0;
    }

    /* âœ… NEW: list scroll wrapper (4ê°œ ì´ìƒì¼ ë•Œ JSë¡œ maxHeight/overflow ì ìš©) */
    .listWrap{
      min-width:0;
      max-width:100%;
    }
    .listWrap.scroll{
      max-height: 320px;
      overflow:auto;
      padding-right: 2px;
      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
      border-radius: 14px;
    }
    .listWrap.scroll::-webkit-scrollbar{ width:10px; }
    .listWrap.scroll::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.12);
      border-radius: 999px;
      border: 2px solid rgba(0,0,0,0);
      background-clip: padding-box;
    }
    .listWrap.scroll::-webkit-scrollbar-thumb:hover{
      background: rgba(255,255,255,.16);
      border: 2px solid rgba(0,0,0,0);
      background-clip: padding-box;
    }

    .item{
      border: var(--border);
      background: rgba(255,255,255,.04);
      border-radius: 14px;
      padding: 12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-width:0;
    }
    .itemLeft{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
      flex:1;
    }
    .itemName{
      font-weight:900;
      color:#e9eef7;
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .itemMeta{
      font-size:12px;
      color:#9fb0ca;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .itemBtns{
      display:flex;
      gap:8px;
      flex:0 0 auto;
      align-items:center;
    }
    .miniBtn{
      appearance:none;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      color:#dbe7ff;
      cursor:pointer;
      padding: 10px 10px;
      border-radius: 12px;
      font-weight:900;
      user-select:none;
      transition: transform .08s var(--ease), background .12s var(--ease), border-color .12s var(--ease), box-shadow .12s var(--ease);
      min-width:44px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .miniBtn:hover{
      background: rgba(47,109,246,.10);
      border-color: rgba(47,109,246,.35);
    }
    .miniBtn:active{ transform: scale(.98); }
    .miniBtn:focus-visible{
      outline:none;
      box-shadow: 0 0 0 3px rgba(var(--blue),.20);
    }

    .hint{ margin-top:10px; color:#9fb0ca; font-size:12px; line-height:1.5; }
    .msg{ margin-top:10px; font-size:13px; color:#cfe0ff; }
    .msg.err{ color:#ffb4b4; }
    .msg.ok{ color:#b8ffcc; }

    .meta{
      color:#b7c3d9;
      font-size:13px;
      line-height:1.5;
      word-break:break-word;
      min-width:0;
    }
    .meta b{ color:#e9eef7; }

    /* âœ… NEW: progress UI */
    .progressWrap{
      margin-top: 6px;
      width:100%;
      display:none;
    }
    .progressWrap.show{ display:block; }
    .progressTrack{
      margin-top:12px;
      width:100%;
      height:8px;
      background: rgba(255,255,255,.08);
      border-radius: 999px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.10);
    }
    .progressBar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(47,109,246,.85), rgba(46,204,113,.70));
      transition: width .18s var(--ease);
    }
    .progressText{
      margin-top:8px;
      font-size:12px;
      color:#bcd1ff;
      font-weight:900;
      letter-spacing:-0.2px;
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    .progressText span{ opacity:.95; }

    .footer{
      margin-top:16px;
      color:#94a6c2;
      font-size:12px;
      text-align:center;
    }
    .footer a{ color:#9fb0ca; text-decoration:none; border-bottom:1px dashed rgba(159,176,202,.35); }
    .footer a:hover{ color:#cfe0ff; border-bottom-color:rgba(207,224,255,.6); }

    input[type="file"]{ display:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div style="flex:1; min-width:240px;">
        <h1 class="title" id="page_title">Merge PDF</h1>
        <p class="sub" id="page_sub">Add PDFs â†’ reorder â†’ merge â†’ download. 100% local processing.</p>

        <div style="margin-top:10px;">
          <a class="homeBtn" href="/" id="home_btn">ğŸ  Home</a>
        </div>

        <div style="margin-top:10px;">
          <div class="pill">ğŸ”’ <span id="local_processing">Processed locally â€” no server upload</span></div>
        </div>
      </div>

      <div class="langRow">
        <div class="langLabel">ğŸŒ <span id="lang_label">Language</span></div>
        <select class="langSelect" id="langSelect" aria-label="Language">
          <option value="en">Global (English)</option>
          <option value="ko">í•œêµ­ì–´</option>
          <option value="es">EspaÃ±ol</option>
          <option value="ja">æ—¥æœ¬èª</option>
        </select>
      </div>
    </div>

    <div class="stageWrap">
      <!-- Left: Upload + list -->
      <div class="card">
        <h2 id="h_stage">Files</h2>

        <input id="fileInput" type="file" accept="application/pdf" multiple>
        <div class="uploadBox" id="uploadBox" role="button" tabindex="0" aria-label="Upload PDFs">
          <div class="uploadTitle" id="upload_title">Tap to choose PDFs, or drag & drop here</div>
          <div class="uploadSub" id="upload_sub">Tip: add multiple PDFs â€¢ reorder with â†‘â†“ â€¢ remove with âœ–</div>
        </div>

        <div class="msg" id="msg"></div>

        <div style="height:12px;"></div>

        <!-- âœ… NEW: list scroll wrapper -->
        <div class="listWrap" id="fileListWrap">
          <div class="list" id="list"></div>
        </div>

        <div class="hint" id="hint">
          Order matters. The merged PDF will follow the list from top to bottom.
        </div>
      </div>

      <!-- Right: Controls -->
      <div class="card">
        <h2 id="h_controls">Controls</h2>

        <div class="row">
          <button class="btn secondary" id="addBtn" type="button">â• Add PDFs</button>
          <button class="btn secondary" id="clearBtn" type="button" disabled>ğŸ—‘ï¸ Clear</button>
        </div>

        <div style="height:10px;"></div>

        <h2 id="h_output">Output</h2>

        <!-- âœ… NEW: progress bar above merge button -->
        <div class="progressWrap" id="progressWrap" aria-live="polite">
          <div class="progressTrack">
            <div class="progressBar" id="progressBar"></div>
          </div>
          <div class="progressText">
            <span id="progressLeft">Workingâ€¦</span>
            <span id="progressRight">0%</span>
          </div>
        </div>

        <div class="row">
          <button class="btn" id="mergeBtn" type="button" disabled>ğŸ§© Merge & Download</button>
        </div>

        <div style="height:12px;"></div>

        <div class="meta" id="meta">
          <b>Status</b><br/>Add PDFs to begin.
        </div>

        <div style="height:12px;"></div>

        <div class="row">
          <button class="btn secondary" id="resetBtn" type="button">â†©ï¸ Reset page</button>
        </div>

        <div class="hint" id="reset_hint">
          Reset clears selected files and returns to the initial state.
        </div>
      </div>
    </div>

    <div class="footer">
      Â© <span id="year"></span> ConvertFiles24 Â·
      <a href="/privacy.html">Privacy</a> Â·
      <a href="/terms.html">Terms</a>
    </div>
  </div>

<script>
(() => {
  "use strict";
  const $ = (id)=>document.getElementById(id);
  $("year").textContent = new Date().getFullYear();
  requestAnimationFrame(()=> document.body.classList.add("loaded"));

  // ========= i18n =========
  const STR = {
    en: {
      page_title: "Merge PDF",
      page_sub: "Add PDFs â†’ reorder â†’ merge â†’ download. 100% local processing.",
      home: "ğŸ  Home",
      local: "Processed locally â€” no server upload",
      lang_label: "Language",

      h_stage: "Files",
      upload_title: "Tap to choose PDFs, or drag & drop here",
      upload_sub: "Tip: add multiple PDFs â€¢ reorder with â†‘â†“ â€¢ remove with âœ–",
      hint: "Order matters. The merged PDF will follow the list from top to bottom.",

      h_controls: "Controls",
      add: "â• Add PDFs",
      clear: "ğŸ—‘ï¸ Clear",

      h_output: "Output",
      merge: "ğŸ§© Merge & Download",

      meta_idle: "<b>Status</b><br/>Add PDFs to begin.",
      meta_count: (n, pages) => `<b>Ready</b><br/>Files: ${n}<br/>Estimated pages: ${pages}+`,
      meta_busy: "<b>Workingâ€¦</b><br/>Merging PDFs locallyâ€¦",
      meta_done: (name, bytes) => `<b>Done</b><br/>Saved: ${name}<br/>Size: ${bytes}`,

      msg_add: "Added.",
      msg_need: "Please add at least 2 PDF files.",
      msg_one: "Added 1 file. Add more to merge.",
      msg_err: "Failed. Please try another PDF.",
      msg_ok: "âœ… Downloaded",

      reset: "â†©ï¸ Reset page",
      reset_hint: "Reset clears selected files and returns to the initial state.",

      prog_work: "Workingâ€¦",
      prog_merge: (i, n) => `Merging ${i}/${n}`
    },
    ko: {
      page_title: "PDF ë³‘í•©",
      page_sub: "PDF ì¶”ê°€ â†’ ìˆœì„œ ë³€ê²½ â†’ ë³‘í•© â†’ ë‹¤ìš´ë¡œë“œ. 100% ë¡œì»¬ ì²˜ë¦¬.",
      home: "ğŸ  í™ˆìœ¼ë¡œ",
      local: "ë¡œì»¬ ì²˜ë¦¬ â€” ì„œë²„ ì—…ë¡œë“œ ì—†ìŒ",
      lang_label: "ì–¸ì–´",

      h_stage: "íŒŒì¼",
      upload_title: "PDF ì„ íƒ ë˜ëŠ” ë“œë˜ê·¸ & ë“œë¡­",
      upload_sub: "íŒ: ì—¬ëŸ¬ PDF ì¶”ê°€ â€¢ â†‘â†“ë¡œ ìˆœì„œ ë³€ê²½ â€¢ âœ–ë¡œ ì‚­ì œ",
      hint: "ìˆœì„œê°€ ì¤‘ìš”í•´ìš”. ìœ„ì—ì„œ ì•„ë˜ ìˆœì„œëŒ€ë¡œ ë³‘í•©ë©ë‹ˆë‹¤.",

      h_controls: "ì¡°ì‘",
      add: "â• PDF ì¶”ê°€",
      clear: "ğŸ—‘ï¸ ë¹„ìš°ê¸°",

      h_output: "ì¶œë ¥",
      merge: "ğŸ§© ë³‘í•© í›„ ë‹¤ìš´ë¡œë“œ",

      meta_idle: "<b>ìƒíƒœ</b><br/>PDFë¥¼ ì¶”ê°€í•´ ì£¼ì„¸ìš”.",
      meta_count: (n, pages) => `<b>ì¤€ë¹„ë¨</b><br/>íŒŒì¼: ${n}ê°œ<br/>ì˜ˆìƒ í˜ì´ì§€: ${pages}+`,
      meta_busy: "<b>ì‘ì—…ì¤‘â€¦</b><br/>ë¡œì»¬ì—ì„œ PDF ë³‘í•© ì¤‘â€¦",
      meta_done: (name, bytes) => `<b>ì™„ë£Œ</b><br/>ì €ì¥: ${name}<br/>í¬ê¸°: ${bytes}`,

      msg_add: "ì¶”ê°€ë¨.",
      msg_need: "PDF íŒŒì¼ì„ ìµœì†Œ 2ê°œ ì´ìƒ ì¶”ê°€í•´ ì£¼ì„¸ìš”.",
      msg_one: "1ê°œ íŒŒì¼ì´ ì¶”ê°€ëì–´ìš”. ë” ì¶”ê°€í•˜ë©´ ë³‘í•©í•  ìˆ˜ ìˆì–´ìš”.",
      msg_err: "ì‹¤íŒ¨í–ˆì–´ìš”. ë‹¤ë¥¸ PDFë¡œ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.",
      msg_ok: "âœ… ë‹¤ìš´ë¡œë“œ ì™„ë£Œ",

      reset: "â†©ï¸ ì´ˆê¸°í™”",
      reset_hint: "ì´ˆê¸°í™”ëŠ” ì„ íƒëœ íŒŒì¼ì„ ëª¨ë‘ ì§€ìš°ê³  ì²˜ìŒ ìƒíƒœë¡œ ëŒë¦½ë‹ˆë‹¤.",

      prog_work: "ì‘ì—…ì¤‘â€¦",
      prog_merge: (i, n) => `ë³‘í•© ì¤‘ ${i}/${n}`
    },
    es: {
      page_title: "Unir PDF",
      page_sub: "AÃ±adir PDFs â†’ reordenar â†’ unir â†’ descargar. 100% local.",
      home: "ğŸ  Inicio",
      local: "Procesado local â€” sin servidor",
      lang_label: "Idioma",

      h_stage: "Archivos",
      upload_title: "Toca para elegir PDFs, o arrastra y suelta aquÃ­",
      upload_sub: "Consejo: aÃ±ade varios â€¢ reordena con â†‘â†“ â€¢ elimina con âœ–",
      hint: "El orden importa. El PDF final seguirÃ¡ la lista de arriba abajo.",

      h_controls: "Controles",
      add: "â• AÃ±adir PDFs",
      clear: "ğŸ—‘ï¸ Vaciar",

      h_output: "Salida",
      merge: "ğŸ§© Unir y descargar",

      meta_idle: "<b>Estado</b><br/>AÃ±ade PDFs para empezar.",
      meta_count: (n, pages) => `<b>Listo</b><br/>Archivos: ${n}<br/>PÃ¡ginas estimadas: ${pages}+`,
      meta_busy: "<b>Trabajandoâ€¦</b><br/>Uniendo PDFs localmenteâ€¦",
      meta_done: (name, bytes) => `<b>Hecho</b><br/>Guardado: ${name}<br/>TamaÃ±o: ${bytes}`,

      msg_add: "AÃ±adido.",
      msg_need: "AÃ±ade al menos 2 PDFs.",
      msg_one: "AÃ±adido 1 archivo. AÃ±ade mÃ¡s para unir.",
      msg_err: "FallÃ³. Prueba con otro PDF.",
      msg_ok: "âœ… Descargado",

      reset: "â†©ï¸ Reiniciar",
      reset_hint: "Reiniciar borra los archivos y vuelve al estado inicial.",

      prog_work: "Trabajandoâ€¦",
      prog_merge: (i, n) => `Uniendo ${i}/${n}`
    },
    ja: {
      page_title: "PDF çµåˆ",
      page_sub: "PDFè¿½åŠ  â†’ ä¸¦ã³æ›¿ãˆ â†’ çµåˆ â†’ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€‚100% ãƒ­ãƒ¼ã‚«ãƒ«å‡¦ç†ã€‚",
      home: "ğŸ  ãƒ›ãƒ¼ãƒ ",
      local: "ãƒ­ãƒ¼ã‚«ãƒ«å‡¦ç† â€” ã‚µãƒ¼ãƒãƒ¼ãªã—",
      lang_label: "è¨€èª",

      h_stage: "ãƒ•ã‚¡ã‚¤ãƒ«",
      upload_title: "PDFã‚’é¸æŠã€ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—",
      upload_sub: "ãƒ’ãƒ³ãƒˆ: è¤‡æ•°è¿½åŠ  â€¢ â†‘â†“ã§é †åºå¤‰æ›´ â€¢ âœ–ã§å‰Šé™¤",
      hint: "é †åºãŒé‡è¦ã§ã™ã€‚ä¸Šã‹ã‚‰ä¸‹ã®é †ã§çµåˆã•ã‚Œã¾ã™ã€‚",

      h_controls: "æ“ä½œ",
      add: "â• PDFè¿½åŠ ",
      clear: "ğŸ—‘ï¸ ã‚¯ãƒªã‚¢",

      h_output: "å‡ºåŠ›",
      merge: "ğŸ§© çµåˆã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",

      meta_idle: "<b>çŠ¶æ…‹</b><br/>PDFã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚",
      meta_count: (n, pages) => `<b>æº–å‚™OK</b><br/>ãƒ•ã‚¡ã‚¤ãƒ«: ${n}<br/>æ¨å®šãƒšãƒ¼ã‚¸: ${pages}+`,
      meta_busy: "<b>å‡¦ç†ä¸­â€¦</b><br/>ãƒ­ãƒ¼ã‚«ãƒ«ã§PDFã‚’çµåˆä¸­â€¦",
      meta_done: (name, bytes) => `<b>å®Œäº†</b><br/>ä¿å­˜: ${name}<br/>ã‚µã‚¤ã‚º: ${bytes}`,

      msg_add: "è¿½åŠ ã—ã¾ã—ãŸã€‚",
      msg_need: "PDFã‚’2ã¤ä»¥ä¸Šè¿½åŠ ã—ã¦ãã ã•ã„ã€‚",
      msg_one: "1ã¤è¿½åŠ ã—ã¾ã—ãŸã€‚ã•ã‚‰ã«è¿½åŠ ã™ã‚‹ã¨çµåˆã§ãã¾ã™ã€‚",
      msg_err: "å¤±æ•—ã—ã¾ã—ãŸã€‚åˆ¥ã®PDFã§è©¦ã—ã¦ãã ã•ã„ã€‚",
      msg_ok: "âœ… ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†",

      reset: "â†©ï¸ ãƒªã‚»ãƒƒãƒˆ",
      reset_hint: "ãƒªã‚»ãƒƒãƒˆã¯é¸æŠã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¶ˆã—ã¦åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã€‚",

      prog_work: "å‡¦ç†ä¸­â€¦",
      prog_merge: (i, n) => `çµåˆä¸­ ${i}/${n}`
    }
  };

  function getQueryLang(){
    try{
      const u = new URL(location.href);
      const q = (u.searchParams.get("lang")||"").toLowerCase();
      if(q && STR[q]) return q;
    }catch(e){}
    return null;
  }
  function detectLang(){
    const q = getQueryLang();
    if(q) return q;
    const saved = localStorage.getItem("cf24_lang");
    if(saved && STR[saved]) return saved;
    const nav = (navigator.language || "").toLowerCase();
    if(nav.startsWith("ko")) return "ko";
    if(nav.startsWith("ja")) return "ja";
    if(nav.startsWith("es")) return "es";
    return "en";
  }

  let LANG = detectLang();
  function t(){ return STR[LANG] || STR.en; }

  function setLang(lang){
    if(!STR[lang]) lang = "en";
    LANG = lang;
    localStorage.setItem("cf24_lang", lang);
    $("langSelect").value = lang;
    document.documentElement.lang = lang;

    $("page_title").textContent = t().page_title;
    $("page_sub").textContent = t().page_sub;
    $("home_btn").textContent = t().home;
    $("local_processing").textContent = t().local;
    $("lang_label").textContent = t().lang_label;

    $("h_stage").textContent = t().h_stage;
    $("upload_title").textContent = t().upload_title;
    $("upload_sub").textContent = t().upload_sub;
    $("hint").textContent = t().hint;

    $("h_controls").textContent = t().h_controls;
    $("addBtn").textContent = t().add;
    $("clearBtn").textContent = t().clear;

    $("h_output").textContent = t().h_output;
    $("mergeBtn").textContent = t().merge;

    $("resetBtn").textContent = t().reset;
    $("reset_hint").textContent = t().reset_hint;

    updateMeta();
  }
  $("langSelect").addEventListener("change", (e)=> setLang(e.target.value));

  // ========= state =========
  const fileInput = $("fileInput");
  const uploadBox = $("uploadBox");
  const listEl = $("list");
  const listWrap = $("fileListWrap");
  const msgEl = $("msg");
  const addBtn = $("addBtn");
  const clearBtn = $("clearBtn");
  const mergeBtn = $("mergeBtn");
  const metaEl = $("meta");
  const resetBtn = $("resetBtn");

  // progress
  const progressWrap = $("progressWrap");
  const progressBar = $("progressBar");
  const progressLeft = $("progressLeft");
  const progressRight = $("progressRight");

  /** items: { file:File, name:string, size:number } */
  let items = [];
  let busy = false;

  function setMsg(text, cls){
    msgEl.textContent = text || "";
    msgEl.className = "msg " + (cls || "");
  }

  function fmtBytes(n){
    const u = ["B","KB","MB","GB"];
    let i=0, v=n;
    while(v>=1024 && i<u.length-1){ v/=1024; i++; }
    return `${v.toFixed(i===0?0:2)} ${u[i]}`;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  function canMerge(){
    return !busy && items.length >= 2;
  }

  function setProgress(pct, leftText){
    const p = Math.max(0, Math.min(100, pct|0));
    progressWrap.classList.add("show");
    progressBar.style.width = p + "%";
    progressLeft.textContent = leftText || t().prog_work;
    progressRight.textContent = p + "%";
  }
  function hideProgressSoon(){
    setTimeout(()=>{
      progressWrap.classList.remove("show");
      progressBar.style.width = "0%";
      progressLeft.textContent = t().prog_work;
      progressRight.textContent = "0%";
    }, 650);
  }

  function updateListScroll(){
    // âœ… 4ê°œ ì´ìƒì´ë©´ listWrapì— ìŠ¤í¬ë¡¤ í´ë˜ìŠ¤ ì ìš©
    if(items.length >= 4){
      listWrap.classList.add("scroll");
    }else{
      listWrap.classList.remove("scroll");
    }
  }

  function updateMeta(){
    if(busy){
      metaEl.innerHTML = t().meta_busy;
      return;
    }
    if(items.length === 0){
      metaEl.innerHTML = t().meta_idle;
      return;
    }
    const approxPages = items.length; // light estimate
    metaEl.innerHTML = t().meta_count(items.length, approxPages);
  }

  function updateButtons(){
    clearBtn.disabled = busy || items.length === 0;
    mergeBtn.disabled = !canMerge();
  }

  function renderList(){
    listEl.innerHTML = "";
    if(items.length === 0){
      updateListScroll();
      updateMeta();
      updateButtons();
      return;
    }

    items.forEach((it, idx)=>{
      const row = document.createElement("div");
      row.className = "item";

      const left = document.createElement("div");
      left.className = "itemLeft";

      const name = document.createElement("div");
      name.className = "itemName";
      name.textContent = it.name;

      const meta = document.createElement("div");
      meta.className = "itemMeta";
      meta.textContent = `${fmtBytes(it.size)} â€¢ #${idx+1}`;

      left.appendChild(name);
      left.appendChild(meta);

      const btns = document.createElement("div");
      btns.className = "itemBtns";

      const up = document.createElement("button");
      up.className = "miniBtn";
      up.type = "button";
      up.title = "Move up";
      up.textContent = "â†‘";
      up.disabled = busy || idx === 0;
      up.addEventListener("click", ()=>{
        if(idx === 0) return;
        const tmp = items[idx-1];
        items[idx-1] = items[idx];
        items[idx] = tmp;
        renderList();
        updateMeta();
        updateButtons();
      });

      const down = document.createElement("button");
      down.className = "miniBtn";
      down.type = "button";
      down.title = "Move down";
      down.textContent = "â†“";
      down.disabled = busy || idx === items.length-1;
      down.addEventListener("click", ()=>{
        if(idx === items.length-1) return;
        const tmp = items[idx+1];
        items[idx+1] = items[idx];
        items[idx] = tmp;
        renderList();
        updateMeta();
        updateButtons();
      });

      const del = document.createElement("button");
      del.className = "miniBtn";
      del.type = "button";
      del.title = "Remove";
      del.textContent = "âœ–";
      del.disabled = busy;
      del.addEventListener("click", ()=>{
        items.splice(idx,1);
        renderList();
        updateMeta();
        updateButtons();
      });

      btns.appendChild(up);
      btns.appendChild(down);
      btns.appendChild(del);

      row.appendChild(left);
      row.appendChild(btns);
      listEl.appendChild(row);
    });

    updateListScroll();
    updateMeta();
    updateButtons();
  }

  function onlyPDF(files){
    return Array.from(files || []).filter(f=>{
      const nameOk = (f.name||"").toLowerCase().endsWith(".pdf");
      const typeOk = (f.type||"").toLowerCase().includes("pdf");
      return nameOk || typeOk;
    });
  }

  function addFiles(fileList){
    const fs = onlyPDF(fileList);
    if(fs.length === 0){
      setMsg(t().msg_err, "err");
      return;
    }
    fs.forEach(f=>{
      items.push({ file:f, name:f.name || "file.pdf", size:f.size || 0 });
    });
    setMsg(items.length === 1 ? t().msg_one : t().msg_add, "ok");
    renderList();
  }

  // ========= upload interactions =========
  addBtn.addEventListener("click", ()=> fileInput.click());
  uploadBox.addEventListener("click", ()=> fileInput.click());
  uploadBox.addEventListener("keydown", (e)=>{
    if(e.key === "Enter" || e.key === " "){
      e.preventDefault();
      fileInput.click();
    }
  });

  fileInput.addEventListener("change", (e)=>{
    addFiles(e.target.files);
    fileInput.value = "";
  });

  ["dragenter","dragover"].forEach(evt=>{
    uploadBox.addEventListener(evt, (e)=>{
      e.preventDefault();
      e.stopPropagation();
      uploadBox.classList.add("drag");
    });
  });
  ["dragleave","drop"].forEach(evt=>{
    uploadBox.addEventListener(evt, (e)=>{
      e.preventDefault();
      e.stopPropagation();
      uploadBox.classList.remove("drag");
    });
  });
  uploadBox.addEventListener("drop", (e)=>{
    addFiles(e.dataTransfer.files);
  });

  clearBtn.addEventListener("click", ()=>{
    if(busy) return;
    items = [];
    setMsg("", "");
    renderList();
  });

  resetBtn.addEventListener("click", ()=>{
    if(busy) return;
    items = [];
    setMsg("", "");
    renderList();
    window.scrollTo({ top: 0, behavior: "smooth" });
  });

  // ========= merge =========
  function downloadBytes(bytes, filename){
    const blob = new Blob([bytes], { type: "application/pdf" });
    const a = document.createElement("a");
    const url = URL.createObjectURL(blob);
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1500);
  }

  function buildName(){
    const stamp = new Date().toISOString().replace(/[:.]/g,"-");
    return `merged_${stamp}.pdf`;
  }

  async function mergePDFs(onProgress){
    if(items.length < 2) throw new Error(t().msg_need);
    if(!window.PDFLib || !window.PDFLib.PDFDocument) throw new Error("PDF library not loaded.");
    const { PDFDocument } = window.PDFLib;

    const outDoc = await PDFDocument.create();

    const total = items.length;
    let done = 0;

    // start progress
    if(typeof onProgress === "function"){
      onProgress(1, t().prog_merge(0, total));
    }

    for(const it of items){
      const buf = await it.file.arrayBuffer();
      const srcDoc = await PDFDocument.load(buf, { ignoreEncryption: true });
      const pages = await outDoc.copyPages(srcDoc, srcDoc.getPageIndices());
      pages.forEach(p => outDoc.addPage(p));

      done++;
      const pct = Math.round((done / total) * 100);
      if(typeof onProgress === "function"){
        onProgress(pct, t().prog_merge(done, total));
      }
    }

    const bytes = await outDoc.save();
    return bytes;
  }

  mergeBtn.addEventListener("click", async ()=>{
    try{
      if(!canMerge()){
        setMsg(items.length < 2 ? t().msg_need : "", "err");
        return;
      }
      busy = true;
      setMsg("", "");
      updateButtons();
      updateMeta();

      setProgress(1, t().prog_merge(0, items.length));

      const bytes = await mergePDFs((pct, leftText)=> setProgress(pct, leftText));
      const name = buildName();
      downloadBytes(bytes, name);

      busy = false;
      setMsg(t().msg_ok, "ok");
      metaEl.innerHTML = t().meta_done(escapeHtml(name), fmtBytes(bytes.byteLength || bytes.length || 0));
      updateButtons();

      hideProgressSoon();
    }catch(err){
      busy = false;
      updateButtons();
      updateMeta();
      setMsg((err && err.message) ? err.message : t().msg_err, "err");
      hideProgressSoon();
    }
  });

  // init
  setLang(LANG);
  renderList();
})();
</script>
</body>
</html>