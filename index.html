<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë©‹ì¬ì´ ì§„ì•¡ ë£¨í‹´ ì²´í¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <meta name="theme-color" content="#ffffff" />
  <link rel="manifest" href="manifest.json" />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      min-height: 100vh;
      background: #f5f5f7;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 16px;
    }

    .app {
      width: 100%;
      max-width: 420px;
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
      padding: 20px 18px 18px;
    }

    .header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .icon-circle {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: #e5f0ff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
    }

    h1 {
      font-size: 20px;
      font-weight: 700;
      color: #222;
    }

    .subtitle {
      font-size: 13px;
      color: #666;
      margin-bottom: 12px;
    }

    .status-bar {
      display: grid;
      grid-template-columns: 1.3fr 1fr;
      gap: 10px;
      margin-bottom: 8px;
    }

    .status-box {
      background: #f7f9fc;
      border-radius: 12px;
      padding: 10px;
    }

    .status-label {
      font-size: 11px;
      color: #888;
      margin-bottom: 4px;
    }

    .status-value {
      font-size: 14px;
      font-weight: 600;
      color: #222;
    }

    .status-value.small {
      font-size: 13px;
    }

    .voice-row {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 6px;
      margin-bottom: 10px;
    }

    .voice-row label {
      font-size: 12px;
      color: #666;
    }

    .voice-toggle {
      width: 42px;
      height: 22px;
      border-radius: 999px;
      background: #e5e7eb;
      position: relative;
      cursor: pointer;
      transition: background 0.2s;
    }

    .voice-toggle-circle {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #ffffff;
      position: absolute;
      top: 2px;
      left: 2px;
      transition: transform 0.2s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    .voice-toggle.on {
      background: #2563eb;
    }

    .voice-toggle.on .voice-toggle-circle {
      transform: translateX(20px);
    }

    .controls {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }

    #playPauseBtn {
      flex: 1.3;
      background: #2563eb;
      color: #fff;
    }

    #resetBtn {
      flex: 1;
      background: #e5e7eb;
      color: #111827;
    }

    .hourglass-wrap {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }

    .hourglass-label {
      font-size: 12px;
      color: #777;
    }

    .hourglass {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #f3f4ff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: transform 0.4s ease;
    }

    .section-title {
      font-size: 13px;
      font-weight: 600;
      color: #555;
      margin-bottom: 6px;
      margin-top: 4px;
    }

    ol {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 360px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .step {
      border-radius: 12px;
      padding: 10px;
      background: #f9fafb;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .step.timed.current {
      border: 1px solid #2563eb;
      background: #eef3ff;
    }

    .step.timed.done {
      background: #e0fce4;
    }

    .step.note {
      background: #fdf5e6;
    }

    .step-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .step-title-box {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .step-index {
      font-size: 12px;
      font-weight: 700;
      color: #6b7280;
      background: #e5e7eb;
      border-radius: 999px;
      padding: 2px 7px;
    }

    .step-title {
      font-size: 14px;
      font-weight: 600;
      color: #111827;
    }

    .step-status {
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
    }

    .step-body {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .step-time {
      font-size: 12px;
      color: #374151;
    }

    .step-tip {
      font-size: 11px;
      color: #9b6b00;
      text-align: right;
      flex: 1;
    }

    .footer-note {
      margin-top: 8px;
      font-size: 11px;
      color: #9ca3af;
      text-align: right;
    }

    @media (max-width: 380px) {
      .app {
        padding: 16px 14px 14px;
      }
      h1 {
        font-size: 18px;
      }
      .subtitle {
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="icon-circle">âœ…</div>
      <div>
        <h1>ë©‹ì¬ì´ ì§„ì•¡ ë£¨í‹´ ì²´í¬</h1>
        <p class="subtitle">06:20 ê¸°ìƒ ê¸°ì¤€ ì•„ì¹¨ ë£¨í‹´ + DGL + ì €ë… ì§„ì•¡ í‹°</p>
      </div>
    </div>

    <div class="status-bar">
      <div class="status-box">
        <div class="status-label">í˜„ì¬ ë‹¨ê³„</div>
        <div class="status-value" id="currentStepLabel">ëŒ€ê¸°ì¤‘</div>
      </div>
      <div class="status-box">
        <div class="status-label">ì•„ì¹¨ íƒ€ì´ë¨¸ ë‚¨ì€ ì‹œê°„</div>
        <div class="status-value small" id="totalRemainingTime">-</div>
      </div>
    </div>

    <div class="voice-row">
      <label for="voiceToggle">ìŒì„± ì•ˆë‚´</label>
      <div id="voiceToggle" class="voice-toggle on">
        <div class="voice-toggle-circle"></div>
      </div>
    </div>

    <div class="controls">
      <button id="playPauseBtn">ì•„ì¹¨ ë£¨í‹´ ì¬ìƒ â–¶</button>
      <button id="resetBtn">ì²˜ìŒë¶€í„° âŸ³</button>
    </div>

    <div class="hourglass-wrap">
      <span class="hourglass-label">ëª¨ë˜ì‹œê³„ (ë‹¨ê³„ ë„˜ì–´ê°ˆ ë•Œë§ˆë‹¤ 180Â° íšŒì „ + ìŒì„± ì•ˆë‚´)</span>
      <div class="hourglass" id="hourglass">â³</div>
    </div>

    <p class="section-title">ì²´í¬ë¦¬ìŠ¤íŠ¸</p>
    <ol id="stepList"></ol>

    <p class="footer-note">â€» 1~4ë²ˆì€ íƒ€ì´ë¨¸, 5~6ë²ˆì€ ì‹œê°„ëŒ€ ì•ˆë‚´ìš© ì²´í¬</p>
  </div>

  <script>
    // ---- ë£¨í‹´ ì •ì˜ (ë©‹ì¬ì´ ë§ì¶¤) ----
    const steps = [
      {
        id: 1,
        title: "ê¸°ìƒ + ì†Œê¸ˆë¬¼ 150~200ml ë§ˆì‹œê¸°",
        duration: 180,
        type: "timed",
        speakText: "1ë‹¨ê³„, ê¸°ìƒ í›„ ì†Œê¸ˆë¬¼ 150ì—ì„œ 200 ë°€ë¦¬ë¦¬í„° ë§ˆì‹œê¸° ì‹œì‘í•©ë‹ˆë‹¤."
      },
      {
        id: 2,
        title: "ì „ë ¥ ëŸ°ë‹ 5ë¶„",
        duration: 300,
        type: "timed",
        speakText: "2ë‹¨ê³„, ì „ë ¥ ëŸ°ë‹ 5ë¶„ ì‹œì‘í•©ë‹ˆë‹¤. ë¬´ë¦¬í•˜ì§€ ë§ê³  í˜¸í¡ì— ì§‘ì¤‘í•´ ì£¼ì„¸ìš”."
      },
      {
        id: 3,
        title: "ëŸ°ë‹ í›„ íœ´ì‹ 10ë¶„",
        duration: 600,
        type: "timed",
        speakText: "3ë‹¨ê³„, ëŸ°ë‹ í›„ íœ´ì‹ 10ë¶„ì…ë‹ˆë‹¤. ì‹¬ì¥ì´ ì§„ì •ë  ë•Œê¹Œì§€ í¸í•˜ê²Œ ì‰¬ì–´ ì£¼ì„¸ìš”."
      },
      {
        id: 4,
        title: "í™©ê¸°Â·ë§¥ë¬¸ë™ + ìœ ì‚°ê·  + ì¹¼ë¡œë¦¬ ëª¬ìŠ¤í„° ì •ë¦¬í•´ì„œ ì„­ì·¨",
        duration: 300,
        type: "timed",
        speakText: "4ë‹¨ê³„, í™©ê¸° ë˜ëŠ” ë§¥ë¬¸ë™ ì°¨, ìœ ì‚°ê· , ê·¸ë¦¬ê³  ì¹¼ë¡œë¦¬ ëª¬ìŠ¤í„°ë¥¼ ì •ë¦¬í•´ì„œ ì„­ì·¨í•©ë‹ˆë‹¤."
      },
      {
        id: 5,
        title: "ì ì‹¬ 30ë¶„ ì „ DGL 1ì • (ìœ„ ì ë§‰ ë³´í˜¸)",
        duration: 0,
        type: "note",
        tip: "ì ì‹¬ ì‹œê°„ ì „ì— ì´ ë‹¨ê³„ë¥¼ ì§ì ‘ ì²´í¬í•´ ì¤˜."
      },
      {
        id: 6,
        title: "ì €ë… ì§„ì•¡ í‹° ë£¨í‹´ (ë°°+ë„ë¼ì§€+ëŒ€ì¶” ë˜ëŠ” ë§¥ë¬¸ë™ì°¨)",
        duration: 0,
        type: "note",
        tip: "ì €ë… ì‹í›„ ë˜ëŠ” ìê¸° ì „ ì§„ì•¡ í‹° ë£¨í‹´ìœ¼ë¡œ ì²´í¬."
      }
    ];

    const stepListEl = document.getElementById("stepList");
    const currentStepLabelEl = document.getElementById("currentStepLabel");
    const totalRemainingTimeEl = document.getElementById("totalRemainingTime");
    const playPauseBtn = document.getElementById("playPauseBtn");
    const resetBtn = document.getElementById("resetBtn");
    const hourglassEl = document.getElementById("hourglass");
    const voiceToggleEl = document.getElementById("voiceToggle");

    let currentIndex = -1;
    let remainingSeconds = 0;
    let timerId = null;
    let isRunning = false;
    let hourglassAngle = 0;

    // ---- ìŒì„± ì•ˆë‚´ ê¸°ëŠ¥ ----
    function isVoiceOn() {
      return voiceToggleEl.classList.contains("on");
    }

    function speak(text) {
      if (!isVoiceOn()) return;
      if (!("speechSynthesis" in window)) return;

      // ì´ì „ ë§ ì¤‘ì§€
      window.speechSynthesis.cancel();

      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = "ko-KR";

      const voices = window.speechSynthesis.getVoices();
      const koVoices = voices.filter(v => v.lang && v.lang.startsWith("ko"));
      if (koVoices.length > 0) {
        // ë³´í†µ ì—¬ì„±ì²˜ëŸ¼ ë“¤ë¦¬ëŠ” ì²« í•œêµ­ì–´ ìŒì„± ì„ íƒ
        utter.voice = koVoices[0];
      }

      window.speechSynthesis.speak(utter);
    }

    function speakStepStart(step) {
      if (step.type !== "timed") return;
      const text = step.speakText || `${step.id}ë‹¨ê³„, ${step.title} ì‹œì‘í•©ë‹ˆë‹¤.`;
      speak(text);
    }

    // ---- í™”ë©´ ê·¸ë¦¬ê¸° ----
    function renderSteps() {
      stepListEl.innerHTML = "";
      steps.forEach((step, idx) => {
        const li = document.createElement("li");
        li.classList.add("step");
        li.classList.add(step.type);
        li.dataset.index = idx;

        const header = document.createElement("div");
        header.classList.add("step-header");

        const titleBox = document.createElement("div");
        titleBox.classList.add("step-title-box");

        const indexSpan = document.createElement("span");
        indexSpan.classList.add("step-index");
        indexSpan.textContent = step.id;

        const titleSpan = document.createElement("span");
        titleSpan.classList.add("step-title");
        titleSpan.textContent = step.title;

        titleBox.appendChild(indexSpan);
        titleBox.appendChild(titleSpan);

        const statusSpan = document.createElement("span");
        statusSpan.classList.add("step-status");
        statusSpan.id = `status-${step.id}`;
        statusSpan.textContent = step.type === "timed" ? "ëŒ€ê¸°ì¤‘" : "ì²´í¬ìš©";

        header.appendChild(titleBox);
        header.appendChild(statusSpan);

        const body = document.createElement("div");
        body.classList.add("step-body");

        const timeSpan = document.createElement("span");
        timeSpan.classList.add("step-time");
        timeSpan.id = `time-${step.id}`;
        if (step.type === "timed") {
          timeSpan.textContent = `ì˜ˆì • ì‹œê°„: ${formatTime(step.duration)}`;
        } else {
          timeSpan.textContent = `ê¶Œì¥ ì‹œê°„ëŒ€ ì•ˆë‚´`;
        }
        body.appendChild(timeSpan);

        if (step.tip) {
          const tipSpan = document.createElement("span");
          tipSpan.classList.add("step-tip");
          tipSpan.textContent = step.tip;
          body.appendChild(tipSpan);
        }

        li.appendChild(header);
        li.appendChild(body);
        stepListEl.appendChild(li);
      });
    }

    function formatTime(seconds) {
      if (seconds <= 0) return "00:00";
      const m = Math.floor(seconds / 60);
      const s = seconds % 60;
      return `${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
    }

    function updateTotalRemainingTime() {
      let total = 0;
      steps.forEach((step, idx) => {
        if (step.type !== "timed") return;
        if (idx < currentIndex) return;
        if (idx === currentIndex) {
          total += remainingSeconds;
        } else {
          total += step.duration;
        }
      });
      totalRemainingTimeEl.textContent = total > 0 ? formatTime(total) : "ì™„ë£Œ";
    }

    function setCurrentStep(idx) {
      currentIndex = idx;

      document.querySelectorAll(".step.timed").forEach(el => {
        el.classList.remove("current");
      });

      if (idx === -1) {
        currentStepLabelEl.textContent = "ëŒ€ê¸°ì¤‘";
        updateTotalRemainingTime();
        return;
      }

      const step = steps[idx];
      const li = stepListEl.querySelector(`.step[data-index="${idx}"]`);
      if (li && step.type === "timed") {
        li.classList.add("current");
      }
      currentStepLabelEl.textContent = `${step.id}ë‹¨ê³„ Â· ${step.title}`;
      remainingSeconds = step.duration;

      const timeEl = document.getElementById(`time-${step.id}`);
      if (timeEl) timeEl.textContent = `ë‚¨ì€ ì‹œê°„: ${formatTime(remainingSeconds)}`;

      const statusEl = document.getElementById(`status-${step.id}`);
      if (statusEl) statusEl.textContent = "ì§„í–‰ì¤‘";

      updateTotalRemainingTime();
    }

    function moveToNextTimedStep() {
      let nextIdx = currentIndex;
      const len = steps.length;
      while (true) {
        nextIdx++;
        if (nextIdx >= len) {
          return -1;
        }
        if (steps[nextIdx].type === "timed") {
          return nextIdx;
        }
      }
    }

    function rotateHourglass() {
      hourglassAngle += 180;
      hourglassEl.style.transform = `rotate(${hourglassAngle}deg)`;
    }

    function markCurrentAsDone() {
      if (currentIndex < 0) return;
      const step = steps[currentIndex];

      const li = stepListEl.querySelector(`.step[data-index="${currentIndex}"]`);
      if (li && step.type === "timed") {
        li.classList.remove("current");
        li.classList.add("done");
      }
      const statusEl = document.getElementById(`status-${step.id}`);
      if (statusEl) statusEl.textContent = "ì™„ë£Œ";
      const timeEl = document.getElementById(`time-${step.id}`);
      if (timeEl) timeEl.textContent = `ì™„ë£Œë¨`;
    }

    function tick() {
      if (!isRunning || currentIndex === -1) return;

      if (remainingSeconds > 0) {
        remainingSeconds--;
        const step = steps[currentIndex];
        const timeEl = document.getElementById(`time-${step.id}`);
        if (timeEl) {
          timeEl.textContent = `ë‚¨ì€ ì‹œê°„: ${formatTime(remainingSeconds)}`;
        }
        updateTotalRemainingTime();
      }

      if (remainingSeconds <= 0) {
        markCurrentAsDone();
        rotateHourglass();

        const nextIdx = moveToNextTimedStep();
        if (nextIdx === -1) {
          isRunning = false;
          clearInterval(timerId);
          timerId = null;
          playPauseBtn.textContent = "ì•„ì¹¨ ë£¨í‹´ ì™„ë£Œ ğŸ‰";
          currentStepLabelEl.textContent = "ì•„ì¹¨ ë£¨í‹´ ëª¨ë‘ ì™„ë£Œ!";
          updateTotalRemainingTime();
          speak("ë©‹ì¬ì´, ì•„ì¹¨ ë£¨í‹´ ëª¨ë‘ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ê³ í–ˆì–´.");
          return;
        } else {
          setCurrentStep(nextIdx);
          speakStepStart(steps[nextIdx]);
        }
      }
    }

    function startTimer() {
      if (isRunning) return;

      if (currentIndex === -1) {
        const firstIdx = steps.findIndex(s => s.type === "timed");
        if (firstIdx === -1) return;
        setCurrentStep(firstIdx);
        speak("ë©‹ì¬ì´, ì•„ì¹¨ ë£¨í‹´ì„ ì‹œì‘í•©ë‹ˆë‹¤.");
        speakStepStart(steps[firstIdx]);
      }

      isRunning = true;
      playPauseBtn.textContent = "ì¼ì‹œì •ì§€ â¸";
      if (!timerId) {
        timerId = setInterval(tick, 1000);
      }
    }

    function pauseTimer() {
      isRunning = false;
      playPauseBtn.textContent = "ì•„ì¹¨ ë£¨í‹´ ì¬ìƒ â–¶";
      // ë§ë„ ì ì‹œ ë©ˆì¶¤
      if ("speechSynthesis" in window) {
        window.speechSynthesis.cancel();
      }
    }

    function resetAll() {
      isRunning = false;
      if (timerId) {
        clearInterval(timerId);
        timerId = null;
      }
      currentIndex = -1;
      remainingSeconds = 0;
      hourglassAngle = 0;
      hourglassEl.style.transform = "rotate(0deg)";
      playPauseBtn.textContent = "ì•„ì¹¨ ë£¨í‹´ ì¬ìƒ â–¶";
      currentStepLabelEl.textContent = "ëŒ€ê¸°ì¤‘";

      if ("speechSynthesis" in window) {
        window.speechSynthesis.cancel();
      }

      steps.forEach(step => {
        const statusEl = document.getElementById(`status-${step.id}`);
        const timeEl = document.getElementById(`time-${step.id}`);
        const li = stepListEl.querySelector(`.step[data-index="${step.id - 1}"]`);
        if (li && step.type === "timed") {
          li.classList.remove("current", "done");
        }

        if (statusEl) {
          statusEl.textContent = step.type === "timed" ? "ëŒ€ê¸°ì¤‘" : "ì²´í¬ìš©";
        }
        if (timeEl) {
          if (step.type === "timed") {
            timeEl.textContent = `ì˜ˆì • ì‹œê°„: ${formatTime(step.duration)}`;
          } else {
            timeEl.textContent = `ê¶Œì¥ ì‹œê°„ëŒ€ ì•ˆë‚´`;
          }
        }
      });

      updateTotalRemainingTime();
    }

    // ---- ì´ë²¤íŠ¸ ----
    playPauseBtn.addEventListener("click", () => {
      if (isRunning) {
        pauseTimer();
      } else {
        startTimer();
      }
    });

    resetBtn.addEventListener("click", resetAll);

    voiceToggleEl.addEventListener("click", () => {
      voiceToggleEl.classList.toggle("on");
      if (!isVoiceOn() && "speechSynthesis" in window) {
        window.speechSynthesis.cancel();
      }
    });

    // ì´ˆê¸° ë Œë”ë§
    renderSteps();
    updateTotalRemainingTime();

    // PWAìš© ì„œë¹„ìŠ¤ì›Œì»¤ ë“±ë¡
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("service-worker.js").catch(() => {});
      });
    }

    // ì¼ë¶€ ë¸Œë¼ìš°ì €ì—ì„œ í•œêµ­ì–´ ìŒì„± ëª©ë¡ ë¡œë”©ìš©
    if ("speechSynthesis" in window) {
      window.speechSynthesis.getVoices();
      window.speechSynthesis.onvoiceschanged = () => {
        window.speechSynthesis.getVoices();
      };
    }
  </script>
</body>
</html>
