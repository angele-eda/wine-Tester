<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë©‹ì¬ì´ ì§„ì•¡ ë£¨í‹´ ì²´í¬</title>
  <link rel="manifest" href="manifest.json" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 20px;
    }
    .card {
      background: #ffffff;
      border-radius: 20px;
      padding: 20px;
      max-width: 480px;
      margin: auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }
    .title-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
    }
    .title-icon {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      background: #e5f0ff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    .title-text {
      font-size: 18px;
      font-weight: 700;
    }
    .subtitle {
      font-size: 12px;
      color: #666;
      margin-bottom: 10px;
    }
    .status-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      font-size: 13px;
      color: #333;
    }
    .hourglass {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #f3f4ff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: transform 0.4s ease;
    }
    .button {
      background: #1a73e8;
      color: #fff;
      border: none;
      padding: 14px;
      width: 100%;
      border-radius: 14px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 14px;
    }
    .button:active {
      opacity: 0.9;
    }
    .steps {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .step {
      padding: 12px 14px;
      border-radius: 12px;
      background: #f8f9fa;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 14px;
    }
    .step-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }
    .step-title {
      font-weight: 600;
    }
    .step-time {
      font-size: 12px;
      color: #555;
    }
    .step-status {
      font-size: 12px;
      color: #777;
    }
    .step.highlight {
      background: #fff7d6;
    }
    .step.timed.current {
      border: 1px solid #1a73e8;
      background: #eef3ff;
    }
    .step.timed.done {
      background: #e7f9ea;
    }
    @media (max-width: 400px) {
      .card { padding: 16px; }
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="title-row">
      <div class="title-icon">ğŸ“</div>
      <div class="title-text">ë©‹ì¬ì´ ì§„ì•¡ ë£¨í‹´ ì²´í¬</div>
    </div>
    <div class="subtitle">
      06:20 ê¸°ìƒ ê¸°ì¤€ Â· ì•„ì¹¨ ë£¨í‹´ + DGL + ì €ë… ì§„ì•¡ í‹°
    </div>

    <div class="status-row">
      <div>í˜„ì¬ ë‹¨ê³„: <span id="currentStepLabel">ëŒ€ê¸°ì¤‘</span></div>
      <div class="hourglass" id="hourglass">â³</div>
    </div>

    <button class="button" id="playBtn">ì•„ì¹¨ ë£¨í‹´ ì¬ìƒ â–¶</button>

    <div class="steps" id="stepsContainer"></div>
  </div>

<script>
/*
  ğŸ§© 1. ë£¨í‹´ ì„¤ì • (ì‹œê°„ì€ ì´ˆë‹¨ìœ„)
  -------------------------------- */
const steps = [
  { id: 1, text: "ê¸°ìƒ í›„ ì†Œê¸ˆë¬¼ 150~200ml ë§ˆì‹œê¸°", duration: 180 }, // 3ë¶„
  { id: 2, text: "ì „ë ¥ ëŸ°ë‹ 5ë¶„",                duration: 300 }, // 5ë¶„
  { id: 3, text: "ëŸ°ë‹ í›„ íœ´ì‹ 10ë¶„",             duration: 600 }, // 10ë¶„
  { id: 4, text: "í™©ê¸°/ë§¥ë¬¸ë™ + ìœ ì‚°ê·  + ì¹¼ë¡œë¦¬ ëª¬ìŠ¤í„°", duration: 300 }, // 5ë¶„
  { id: 5, text: "ì ì‹¬ 30ë¶„ ì „ DGL 1ì •",          duration: 0 },   // ì•ˆë‚´ìš©
  { id: 6, text: "ì €ë… ì§„ì•¡ í‹°(ë°°+ë„ë¼ì§€+ëŒ€ì¶” ë˜ëŠ” ë§¥ë¬¸ë™)", duration: 0 } // ì•ˆë‚´ìš©
];

const playBtn   = document.getElementById("playBtn");
const stepsEl   = document.getElementById("stepsContainer");
const currentStepLabel = document.getElementById("currentStepLabel");
const hourglassEl = document.getElementById("hourglass");

let currentIndex = -1;      // í˜„ì¬ ì§„í–‰ ì¤‘ì¸ step index
let remainingSec = 0;       // í˜„ì¬ ë‹¨ê³„ ë‚¨ì€ ì‹œê°„
let timerId = null;
let isRunning = false;
let hourglassAngle = 0;

/*
  ğŸ§© 2. í™”ë©´ì— ìŠ¤í… ëª©ë¡ ê·¸ë¦¬ê¸°
  -------------------------------- */
function renderSteps() {
  stepsEl.innerHTML = "";
  steps.forEach((step) => {
    const div = document.createElement("div");
    div.className = "step " + (step.duration > 0 ? "timed" : "highlight");
    div.id = "step-" + step.id;

    const header = document.createElement("div");
    header.className = "step-header";

    const title = document.createElement("div");
    title.className = "step-title";
    title.textContent = step.id + ". " + step.text;

    const status = document.createElement("div");
    status.className = "step-status";
    status.id = "status-" + step.id;
    status.textContent = step.duration > 0 ? "ëŒ€ê¸°ì¤‘" : "ì²´í¬ìš©";

    header.appendChild(title);
    header.appendChild(status);

    const time = document.createElement("div");
    time.className = "step-time";
    time.id = "time-" + step.id;
    if (step.duration > 0) {
      time.textContent = "ì˜ˆì • ì‹œê°„: " + formatTime(step.duration);
    } else {
      time.textContent = "ê¶Œì¥ ì‹œê°„ëŒ€: ë©‹ì¬ì´ê°€ ì§ì ‘ ì²´í¬";
    }

    div.appendChild(header);
    div.appendChild(time);
    stepsEl.appendChild(div);
  });
}

function formatTime(sec) {
  const m = Math.floor(sec / 60);
  const s = sec % 60;
  return String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0");
}

/*
  ğŸ§© 3. ìŒì„± ì•ˆë‚´ (ì—¬ì í•œêµ­ì–´ ëª©ì†Œë¦¬ ìš°ì„ )
  -------------------------------- */
function speak(text) {
  if (!("speechSynthesis" in window)) return;

  window.speechSynthesis.cancel();

  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = "ko-KR";

  const voices = window.speechSynthesis.getVoices();
  const koVoices = voices.filter(v => v.lang && v.lang.startsWith("ko"));
  if (koVoices.length > 0) {
    // ë³´í†µ ì²« ë²ˆì§¸ê°€ ì—¬ì ë³´ì´ìŠ¤ì¸ ê²½ìš°ê°€ ë§ìŒ
    utter.voice = koVoices[0];
  }

  window.speechSynthesis.speak(utter);
}

function speakStep(step) {
  if (step.duration <= 0) return;
  speak(`${step.id}ë‹¨ê³„, ${step.text} ì‹œì‘í•©ë‹ˆë‹¤.`);
}

/*
  ğŸ§© 4. ë‹¨ê³„ ì „í™˜ / íƒ€ì´ë¨¸
  -------------------------------- */
function setCurrentStep(index) {
  // ê¸°ì¡´ current í‘œì‹œ ì œê±°
  steps.forEach(step => {
    const el = document.getElementById("step-" + step.id);
    if (!el) return;
    el.classList.remove("current");
  });

  if (index < 0) {
    currentIndex = -1;
    currentStepLabel.textContent = "ëŒ€ê¸°ì¤‘";
    remainingSec = 0;
    return;
  }

  currentIndex = index;
  const step = steps[index];

  const el = document.getElementById("step-" + step.id);
  if (el && step.duration > 0) {
    el.classList.add("current");
  }

  currentStepLabel.textContent = `${step.id}ë‹¨ê³„ Â· ${step.text}`;

  if (step.duration > 0) {
    remainingSec = step.duration;
    const timeEl = document.getElementById("time-" + step.id);
    if (timeEl) {
      timeEl.textContent = "ë‚¨ì€ ì‹œê°„: " + formatTime(remainingSec);
    }
    const statusEl = document.getElementById("status-" + step.id);
    if (statusEl) statusEl.textContent = "ì§„í–‰ì¤‘";
  }
}

function markStepDone(index) {
  const step = steps[index];
  if (!step || step.duration <= 0) return;

  const el = document.getElementById("step-" + step.id);
  if (el) {
    el.classList.remove("current");
    el.classList.add("done");
  }
  const statusEl = document.getElementById("status-" + step.id);
  if (statusEl) statusEl.textContent = "ì™„ë£Œ";
  const timeEl = document.getElementById("time-" + step.id);
  if (timeEl) timeEl.textContent = "ì™„ë£Œë¨";
}

function nextTimedStepIndex(fromIndex) {
  for (let i = fromIndex + 1; i < steps.length; i++) {
    if (steps[i].duration > 0) return i;
  }
  return -1;
}

function rotateHourglass() {
  hourglassAngle += 180;
  hourglassEl.style.transform = `rotate(${hourglassAngle}deg)`;
}

function tick() {
  if (!isRunning || currentIndex < 0) return;

  if (remainingSec > 0) {
    remainingSec--;
    const step = steps[currentIndex];
    const timeEl = document.getElementById("time-" + step.id);
    if (timeEl) {
      timeEl.textContent = "ë‚¨ì€ ì‹œê°„: " + formatTime(remainingSec);
    }
  }

  if (remainingSec <= 0) {
    // í˜„ì¬ ë‹¨ê³„ ì™„ë£Œ
    markStepDone(currentIndex);
    rotateHourglass();

    const nextIndex = nextTimedStepIndex(currentIndex);
    if (nextIndex === -1) {
      // ëª¨ë“  íƒ€ì´ë¨¸ ë‹¨ê³„ ë
      isRunning = false;
      clearInterval(timerId);
      timerId = null;
      playBtn.textContent = "ì•„ì¹¨ ë£¨í‹´ ì™„ë£Œ ğŸ‰";
      currentStepLabel.textContent = "íƒ€ì´ë¨¸ ë‹¨ê³„ ëª¨ë‘ ì™„ë£Œ!";
      speak("ë©‹ì¬ì´, ì•„ì¹¨ ë£¨í‹´ íƒ€ì´ë¨¸ ë‹¨ê³„ê°€ ëª¨ë‘ ëë‚¬ì–´ìš”. ìˆ˜ê³ í–ˆì–´.");
      return;
    }

    // ë‹¤ìŒ ë‹¨ê³„ë¡œ ë„˜ì–´ê°€ë©´ì„œ ìŒì„± ì•ˆë‚´
    setCurrentStep(nextIndex);
    speakStep(steps[nextIndex]);
  }
}

function startRoutine() {
  if (isRunning) {
    // ì¼ì‹œì •ì§€
    isRunning = false;
    playBtn.textContent = "ì•„ì¹¨ ë£¨í‹´ ì¬ìƒ â–¶";
    if ("speechSynthesis" in window) {
      window.speechSynthesis.cancel();
    }
    return;
  }

  // ì²˜ìŒ ì‹œì‘
  if (currentIndex === -1) {
    const firstIndex = steps.findIndex(s => s.duration > 0);
    if (firstIndex === -1) return;

    speak("ë©‹ì¬ì´, ì•„ì¹¨ ë£¨í‹´ì„ ì‹œì‘í•©ë‹ˆë‹¤.");
    setCurrentStep(firstIndex);
    speakStep(steps[firstIndex]);
  }

  isRunning = true;
  playBtn.textContent = "ì¼ì‹œì •ì§€ â¸";

  if (!timerId) {
    timerId = setInterval(tick, 1000);
  }
}

/*
  ğŸ§© 5. ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ì—°ê²°
  -------------------------------- */
renderSteps();
setCurrentStep(-1);

playBtn.addEventListener("click", startRoutine);

// ì„œë¹„ìŠ¤ì›Œì»¤ (PWAìš©)
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("service-worker.js").catch(() => {});
  });
}

// ì¼ë¶€ ë¸Œë¼ìš°ì €ì—ì„œ ìŒì„± ëª©ë¡ ë¡œë”© íŠ¸ë¦¬ê±°
if ("speechSynthesis" in window) {
  speechSynthesis.getVoices();
  speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();
}
</script>
</body>
</html>