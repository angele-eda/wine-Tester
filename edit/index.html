<!doctype html>
<html lang="en" translate="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Edit Image | ConvertFiles24</title>
  <meta name="description" content="Edit images online: crop-free move/zoom/rotate/flip, resize, and download. 100% local processing (no server upload)." />
  <meta name="robots" content="index,follow" />
  <meta name="theme-color" content="#0b0f17" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Noto+Sans+KR:wght@400;500;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --radius:16px;
      --pad:16px;
      --border:1px solid rgba(255,255,255,.12);
      --blue: 47,109,246;
      --ease: cubic-bezier(.2,.8,.2,1);
    }
    *{ box-sizing:border-box; }
    html, body{ width:100%; max-width:100%; overflow-x:hidden; }
    body{
      margin:0;
      font-family: Inter, "Noto Sans KR", system-ui, -apple-system, "Segoe UI", Roboto, "Apple SD Gothic Neo", sans-serif;
      background:#0b0f17;
      color:#e9eef7;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: geometricPrecision;
    }

    body:not(.loaded) .card, body:not(.loaded) .top{ opacity:0; transform: translateY(8px); }
    body.loaded .top{ animation: cfFadeUp .35s var(--ease) both; }
    body.loaded .card{ animation: cfFadeUp .38s var(--ease) both; }
    @keyframes cfFadeUp{ from{opacity:0; transform:translateY(8px);} to{opacity:1; transform:translateY(0);} }
    @media (prefers-reduced-motion: reduce){
      *{ animation:none !important; transition:none !important; scroll-behavior:auto !important; }
      body:not(.loaded) .card, body:not(.loaded) .top{ opacity:1; transform:none; }
    }

    .wrap{
      max-width:980px;
      width:100%;
      margin:0 auto;
      padding:22px 14px 44px;
      overflow-x: clip;
    }

    .top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
      margin-bottom:14px;
      min-width:0;
    }

    .title{
      margin:0;
      font-weight:900;
      letter-spacing:-0.35px;
      line-height:1.15;
      color:#ffffff;
      font-size:22px;
    }
    .sub{
      margin:8px 0 0;
      color:#a7b3c7;
      font-size:13px;
      line-height:1.45;
    }

    .homeBtn{
      width:100%;
      display:flex; align-items:center; justify-content:center; gap:10px;
      padding:12px 14px;
      border-radius:999px;
      border:1px solid rgba(47,109,246,.55);
      background:rgba(47,109,246,.18);
      color:#e9eef7;
      font-weight:900;
      cursor:pointer;
      text-decoration:none;
      user-select:none;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
      max-width:380px;
      transition: transform .08s var(--ease), background .12s var(--ease), box-shadow .12s var(--ease);
    }
    .homeBtn:hover{ background:rgba(47,109,246,.24); }
    .homeBtn:active{ transform: scale(.99); }
    .homeBtn:focus-visible{
      outline:none;
      box-shadow: 0 0 0 3px rgba(var(--blue),.35), 0 10px 24px rgba(0,0,0,.25);
    }

    .langRow{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:8px;
      min-width:220px;
      max-width:100%;
      margin-left:auto;
    }
    .langLabel{
      font-size:12px;
      font-weight:900;
      color:#9fb0ca;
      letter-spacing:-0.2px;
      display:flex;
      align-items:center;
      gap:8px;
      opacity:.95;
    }
    .langSelect{
      width:220px;
      max-width:100%;
      padding:12px 12px;
      border-radius:999px;
      border:var(--border);
      background:rgba(255,255,255,.06);
      color:#e9eef7;
      outline:none;
      font-weight:900;
      transition: box-shadow .12s var(--ease), border-color .12s var(--ease), transform .08s var(--ease);
    }
    .langSelect:focus-visible{
      outline:none;
      border-color: rgba(var(--blue), .55);
      box-shadow: 0 0 0 3px rgba(var(--blue),.25);
    }
    option{ background:#0b0f17; color:#e9eef7; }
    @media (max-width: 420px){
      .langRow{ min-width:180px; }
      .langSelect{ width:180px; }
    }

    .pill{
      width:100%;
      border:1px solid rgba(120, 200, 255, .22);
      background:rgba(120, 200, 255, .06);
      border-radius:999px;
      padding:10px 14px;
      color:#cfe6ff;
      font-size:13px;
      font-weight:900;
      display:flex; align-items:center; justify-content:center; gap:10px;
      min-width:0;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
    }

    .card{
      border:var(--border);
      background:rgba(255,255,255,.03);
      border-radius:var(--radius);
      padding:var(--pad);
      margin-top:12px;
      min-width:0;
      max-width:100%;
      overflow-x: clip;
      will-change: transform, opacity;
    }

    /* ‚úÖ ÌÉÄÏù¥Ìè¨Îßå ÏÇ¥Ïßù ÌòÑÎåÄÏ†ÅÏúºÎ°ú */
    .card h2{
      margin:0 0 10px;
      font-size:14px;          /* 15 -> 14 */
      color:#dbe7ff;
      letter-spacing:-0.15px;  /* -0.2 -> -0.15 */
      line-height:1.25;
      font-weight:800;         /* Îçú ‚ÄúÌóàÎ¶¨Î©çÌÖÖ‚Äù */
    }

    .cardHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin:0 0 10px;
    }
    .cardHead h2{ margin:0; }

    .resetIconBtn{
      appearance:none;
      border:none;
      background:transparent;
      color:#dbe7ff;
      cursor:pointer;
      width:36px; height:36px;
      border-radius:10px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      transition: transform .08s var(--ease), background .12s var(--ease), box-shadow .12s var(--ease), opacity .12s var(--ease);
      opacity:.92;
      padding:0;
    }
    .resetIconBtn:hover{ background: rgba(47,109,246,.07); opacity:1; }
    .resetIconBtn:active{ transform: scale(.98); }
    .resetIconBtn:focus-visible{
      outline:none;
      box-shadow: 0 0 0 3px rgba(var(--blue),.25);
      background: rgba(47,109,246,.07);
      opacity:1;
    }
    .resetIconBtn svg{ width:20px; height:20px; display:block; }

    .stageWrap{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:12px;
      min-width:0;
      max-width:100%;
    }
    @media (max-width: 860px){ .stageWrap{ grid-template-columns: 1fr; } }

    .stage{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.25);
      border-radius:16px;
      overflow:hidden;
      position:relative;
      aspect-ratio: 4 / 3;
      min-height: 320px;
      touch-action: none;
      width:100%;
      max-width:100%;
    }
    @media (max-width: 480px){ .stage{ min-height: 280px; } }

    canvas{
      display:block;
      width:100%;
      height:100%;
      max-width:100%;
      max-height:100%;
    }

    .crosshair{
      position:absolute;
      left:50%; top:50%;
      width:56px; height:56px;
      transform:translate(-50%,-50%);
      pointer-events:none;
      opacity:.78;
      filter: drop-shadow(0 2px 8px rgba(0,0,0,.45));
    }
    .crosshair:before,
    .crosshair:after{
      content:"";
      position:absolute;
      left:50%; top:50%;
      background:rgba(235,245,255,.95);
      transform:translate(-50%,-50%);
      border-radius:999px;
    }
    .crosshair:before{ width:2px; height:46px; }
    .crosshair:after{ width:46px; height:2px; }
    .crossDot{
      position:absolute;
      left:50%; top:50%;
      width:10px; height:10px;
      transform:translate(-50%,-50%);
      border-radius:999px;
      border:2px solid rgba(235,245,255,.95);
      background:rgba(11,15,23,.35);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.25);
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      min-width:0;
    }
    .row > *{
      flex:1;
      min-width:160px;
      max-width:100%;
      min-width:0;
    }

    .btn{
      appearance:none; border:none; cursor:pointer;
      background:#2f6df6; color:white; font-weight:900;
      padding:12px 14px; border-radius:14px; width:100%;
      font-size:14px;
      letter-spacing: -0.2px;
      user-select:none;
      transition: transform .08s var(--ease), filter .12s var(--ease), box-shadow .12s var(--ease), background .12s var(--ease), border-color .12s var(--ease);
    }

    .btn.secondary{
      background: rgba(47,109,246,.14);
      color:#e9eef7;
      border: 1px solid rgba(47,109,246,.30);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
    }
    .btn.secondary:hover{
      background: rgba(47,109,246,.18);
      border-color: rgba(47,109,246,.36);
    }

    .btn:hover{ filter: brightness(1.02); }
    .btn:active{ transform: scale(.99); }
    .btn:focus-visible{ outline:none; box-shadow: 0 0 0 3px rgba(var(--blue),.22); }
    .btn:disabled{ opacity:.45; cursor:not-allowed; transform:none; filter:none; box-shadow:none; }

    label{ display:block; font-size:12px; color:#a7b3c7; margin-bottom:6px; }
    select, input[type="number"]{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      background:rgba(255,255,255,.06);
      color:#e9eef7;
      border:var(--border);
      outline:none;
      font-weight:900;
      max-width:100%;
      transition: box-shadow .12s var(--ease), border-color .12s var(--ease);
    }
    select:focus-visible, input[type="number"]:focus-visible{
      border-color: rgba(var(--blue), .55);
      box-shadow: 0 0 0 3px rgba(var(--blue),.22);
    }

    .chkRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .chk{
      display:inline-flex;
      gap:8px;
      align-items:center;
      border:var(--border);
      background:rgba(255,255,255,.04);
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      user-select:none;
      font-size:12px;
      color:#cfe0ff;
      white-space:nowrap;
      width: fit-content;
    }
    .chk input{ width:16px; height:16px; }

    .hint{ margin-top:10px; color:#9fb0ca; font-size:12px; line-height:1.5; }
    .msg{ margin-top:10px; font-size:13px; color:#cfe0ff; }
    .msg.err{ color:#ffb4b4; }
    .msg.ok{ color:#b8ffcc; }

    .meta{
      color:#b7c3d9;
      font-size:13px;
      line-height:1.5;
      word-break:break-word;
      min-width:0;
    }
    .meta b{ color:#e9eef7; }

    .footer{
      margin-top:16px;
      color:#94a6c2;
      font-size:12px;
      text-align:center;
    }
    .footer a{ color:#9fb0ca; text-decoration:none; border-bottom:1px dashed rgba(159,176,202,.35); }
    .footer a:hover{ color:#cfe0ff; border-bottom-color:rgba(207,224,255,.6); }

    input[type="file"]{ display:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div style="flex:1; min-width:240px;">
        <h1 class="title" id="page_title">Edit</h1>
        <p class="sub" id="page_sub">Move/zoom/rotate/flip ‚Üí resize ‚Üí download. 100% local processing.</p>

        <div style="margin-top:10px;">
          <a class="homeBtn" href="/" id="home_btn">üè† Home</a>
        </div>

        <div style="margin-top:10px;">
          <div class="pill">üîí <span id="local_processing">Processed locally ‚Äî no server upload</span></div>
        </div>
      </div>

      <div class="langRow">
        <div class="langLabel">üåê <span id="lang_label">Language</span></div>
        <select class="langSelect" id="langSelect" aria-label="Language">
          <option value="en">Global (English)</option>
          <option value="ko">ÌïúÍµ≠Ïñ¥</option>
          <option value="es">Espa√±ol</option>
          <option value="ja">Êó•Êú¨Ë™û</option>
        </select>
      </div>
    </div>

    <div class="stageWrap">
      <div class="card">
        <h2 id="h_stage">Preview / Edit</h2>
        <div class="stage" id="stage">
          <canvas id="cv"></canvas>
          <div class="crosshair" aria-hidden="true">
            <div class="crossDot" aria-hidden="true"></div>
          </div>
        </div>
        <div class="msg" id="msg"></div>
      </div>

      <div class="card">
        <div class="cardHead">
          <h2 id="h_controls">Controls</h2>
          <button class="resetIconBtn" id="resetViewBtn" type="button" aria-label="Reset view" title="Reset view">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M20 12a8 8 0 1 1-2.35-5.65" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M20 4v6h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>

        <div class="row">
          <button class="btn secondary" id="fitBtn" type="button">‚Üî Fit</button>
          <button class="btn secondary" id="centerBtn" type="button">üéØ Center</button>
        </div>

        <div style="height:10px;"></div>

        <div class="row">
          <button class="btn secondary" id="zoomOutBtn" type="button">‚ûñ Zoom out</button>
          <button class="btn secondary" id="zoomInBtn" type="button">‚ûï Zoom in</button>
        </div>

        <div style="height:10px;"></div>

        <div class="row">
          <button class="btn secondary" id="rotLBtn" type="button">‚ü≤ Rotate</button>
          <button class="btn secondary" id="rotRBtn" type="button">‚ü≥ Rotate</button>
        </div>

        <div style="height:10px;"></div>

        <div class="row">
          <button class="btn secondary" id="flipHBtn" type="button">‚áã Flip H</button>
          <button class="btn secondary" id="flipVBtn" type="button">‚áµ Flip V</button>
        </div>

        <div style="height:12px;"></div>

        <h2 id="h_output">Output</h2>

        <div class="row">
          <div>
            <label id="lbl_format">Format</label>
            <select id="outFormat">
              <option value="image/jpeg" selected>JPG</option>
              <option value="image/png">PNG</option>
              <option value="image/webp">WebP</option>
            </select>
          </div>
          <div>
            <label id="lbl_quality">Quality</label>
            <select id="quality">
              <option value="0.95">Max (0.95)</option>
              <option value="0.90" selected>High (0.90)</option>
              <option value="0.80">Normal (0.80)</option>
              <option value="0.70">Small (0.70)</option>
            </select>
          </div>
        </div>

        <div style="height:10px;"></div>

        <div class="row">
          <div>
            <label id="lbl_w">Width (px)</label>
            <input id="w" type="number" min="1" placeholder="blank = stage size">
          </div>
          <div>
            <label id="lbl_h">Height (px)</label>
            <input id="h" type="number" min="1" placeholder="blank = stage size">
          </div>
        </div>

        <div class="hint" id="size_hint">If you fill only one side, aspect ratio is preserved automatically.</div>

        <div style="height:12px;"></div>

        <h2 id="h_aspect">Aspect</h2>

        <div class="chkRow">
          <label class="chk" title="Keep aspect ratio when exporting">
            <input type="checkbox" id="aspectLock" checked>
            <span id="aspect_lock_txt">Keep aspect ratio</span>
          </label>
        </div>

        <div style="height:8px;"></div>

        <div class="row">
          <div>
            <label id="lbl_aspectMode">Mode</label>
            <select id="aspectMode">
              <option value="contain" selected>Contain (no crop)</option>
              <option value="cover">Cover (crop)</option>
              <option value="stretch">Stretch (fill)</option>
            </select>
            <div class="hint" id="aspect_hint">Contain = may add margins ‚Ä¢ Cover = fills and may crop ‚Ä¢ Stretch = distorts</div>
          </div>
        </div>

        <div style="height:12px;"></div>

        <h2 id="h_download">Download</h2>
        <button class="btn" id="downloadBtn" type="button" disabled>‚¨áÔ∏è Download</button>

        <div style="height:12px;"></div>
        <div class="meta" id="meta">
          <b>Preview</b><br/>Open from main preview ‚úÇÔ∏è button.
        </div>
      </div>
    </div>

    <div class="footer">
      ¬© <span id="year"></span> ConvertFiles24 ¬∑
      <a href="/privacy.html">Privacy</a> ¬∑
      <a href="/terms.html">Terms</a>
    </div>
  </div>

<script>
(() => {
  "use strict";
  const $ = (id)=>document.getElementById(id);
  $("year").textContent = new Date().getFullYear();
  requestAnimationFrame(()=> document.body.classList.add("loaded"));

  const STR = {/* (ÎÑà ÏõêÎ≥∏ Í∑∏ÎåÄÎ°ú) */};
  // ‚úÖ ÎÑ§Í∞Ä Ïù¥ÎØ∏ Í∞ñÍ≥† ÏûàÎäî STR Í∑∏ÎåÄÎ°ú ÎëêÍ≥† Ïã∂ÏúºÎ©¥ Ïó¨Í∏∞ STR Î∂ÄÎ∂ÑÏùÄ "Í∏∞Ï°¥ STR"Î°ú Î∂ôÏó¨ÎÑ£Ïñ¥ÎèÑ Îê®.
  // ÏßÄÍ∏à Î©îÏãúÏßÄ Í∏∏Ïù¥ ÎïåÎ¨∏Ïóê STRÎäî ÏÉùÎûµÌñàÏßÄÎßå, ÎÑà ÌååÏùºÏóêÏÑúÎäî Í∏∞Ï°¥ STRÎ•º Í∑∏ÎåÄÎ°ú Ïú†ÏßÄÌïòÎ©¥ Îê®.

  // ====== ÏïÑÎûòÎäî "Ïù¥ÎØ∏ÏßÄ Î∂àÎü¨Ïò§Í∏∞"Îßå ÌôïÏã§Ìûà ÌïòÎäî ÌïµÏã¨ ======
  function getQueryLang(){
    try{
      const u = new URL(location.href);
      const q = (u.searchParams.get("lang")||"").toLowerCase();
      if(q && STR[q]) return q;
    }catch(e){}
    return null;
  }
  function detectLang(){
    const q = getQueryLang();
    if(q) return q;
    const saved = localStorage.getItem("cf24_lang");
    if(saved && STR[saved]) return saved;
    const nav = (navigator.language || "").toLowerCase();
    if(nav.startsWith("ko")) return "ko";
    if(nav.startsWith("ja")) return "ja";
    if(nav.startsWith("es")) return "es";
    return "en";
  }

  let LANG = detectLang();
  function t(){ return STR[LANG] || STR.en; }

  function setLang(lang){
    if(!STR[lang]) lang = "en";
    LANG = lang;
    localStorage.setItem("cf24_lang", lang);
    $("langSelect").value = lang;
    document.documentElement.lang = lang;

    $("page_title").textContent = t().page_title;
    $("page_sub").textContent = t().page_sub;
    $("home_btn").textContent = t().home;
    $("local_processing").textContent = t().local;
    $("lang_label").textContent = t().lang_label;

    $("h_stage").textContent = t().h_stage;
    $("h_controls").textContent = t().controls;
    $("fitBtn").textContent = t().fit;
    $("centerBtn").textContent = t().center;
    $("zoomOutBtn").textContent = t().zoomOut;
    $("zoomInBtn").textContent = t().zoomIn;
    $("rotLBtn").textContent = t().rotL;
    $("rotRBtn").textContent = t().rotR;
    $("flipHBtn").textContent = t().flipH;
    $("flipVBtn").textContent = t().flipV;

    $("resetViewBtn").setAttribute("aria-label", t().resetView);
    $("resetViewBtn").setAttribute("title", t().resetView);

    $("h_output").textContent = t().h_output;
    $("lbl_format").textContent = t().format;
    $("lbl_quality").textContent = t().quality;
    $("lbl_w").textContent = t().w;
    $("lbl_h").textContent = t().h;
    $("size_hint").textContent = t().size_hint;

    $("h_aspect").textContent = t().h_aspect;
    $("aspect_lock_txt").textContent = t().aspect_lock;
    $("lbl_aspectMode").textContent = t().aspect_mode;
    $("aspect_hint").textContent = t().aspect_hint;

    $("h_download").textContent = t().h_download;
    $("downloadBtn").textContent = t().download;

    if(!img) $("meta").innerHTML = t().meta_idle;
    setTimeout(()=>resizeCanvas(), 0);
  }
  $("langSelect").addEventListener("change", (e)=> setLang(e.target.value));

  const stage = $("stage");
  const cv = $("cv");
  const ctx = cv.getContext("2d", { alpha:true });

  const fitBtn = $("fitBtn");
  const centerBtn = $("centerBtn");
  const zoomInBtn = $("zoomInBtn");
  const zoomOutBtn = $("zoomOutBtn");
  const rotLBtn = $("rotLBtn");
  const rotRBtn = $("rotRBtn");
  const flipHBtn = $("flipHBtn");
  const flipVBtn = $("flipVBtn");
  const resetViewBtn = $("resetViewBtn");

  const outFormatEl = $("outFormat");
  const qualityEl = $("quality");
  const wEl = $("w");
  const hEl = $("h");
  const aspectLockEl = $("aspectLock");
  const aspectModeEl = $("aspectMode");

  const downloadBtn = $("downloadBtn");
  const msgEl = $("msg");

  let img = null;
  let imgName = "image";
  let imgW = 0, imgH = 0;

  const initialView = { scale: 1, offX: 0, offY: 0, rot: 0, flipH: 1, flipV: 1 };
  const view = { scale: 1, offX: 0, offY: 0, rot: 0, flipH: 1, flipV: 1 };

  function setMsg(text, cls){
    msgEl.textContent = text || "";
    msgEl.className = "msg " + (cls || "");
  }
  function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

  function resizeCanvas(){
    const rect = stage.getBoundingClientRect();
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    cv.width = Math.round(rect.width * dpr);
    cv.height = Math.round(rect.height * dpr);
    cv.style.width = rect.width + "px";
    cv.style.height = rect.height + "px";
    ctx.setTransform(dpr,0,0,dpr,0,0);
    redraw();
  }
  window.addEventListener("resize", resizeCanvas);

  function stageRect(){ return stage.getBoundingClientRect(); }

  function redraw(){
    const rect = stageRect();
    ctx.clearRect(0,0,rect.width,rect.height);
    if(!img) return;

    ctx.save();
    ctx.translate(rect.width/2, rect.height/2);
    ctx.translate(view.offX, view.offY);
    ctx.rotate((view.rot * Math.PI) / 180);
    ctx.scale(view.scale * view.flipH, view.scale * view.flipV);
    ctx.drawImage(img, -imgW/2, -imgH/2, imgW, imgH);
    ctx.restore();

    updateMeta();
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  function updateMeta(){
    if(!img){
      $("meta").innerHTML = t().meta_idle;
      downloadBtn.disabled = true;
      resetViewBtn.disabled = true;
      resetViewBtn.style.opacity = ".55";
      return;
    }
    $("meta").innerHTML = t().meta_info(escapeHtml(imgName), imgW, imgH);
    downloadBtn.disabled = false;
    resetViewBtn.disabled = false;
    resetViewBtn.style.opacity = "";

    const mime = outFormatEl.value;
    const disableQ = (mime === "image/png");
    qualityEl.disabled = disableQ;
    qualityEl.style.opacity = disableQ ? ".6" : "1";
  }

  function zoomBy(factor, cx, cy){
    if(!img) return;
    const rect = stageRect();
    const x = (typeof cx === "number") ? cx : rect.width/2;
    const y = (typeof cy === "number") ? cy : rect.height/2;

    const px = x - rect.width/2;
    const py = y - rect.height/2;

    const beforeX = (px - view.offX) / view.scale;
    const beforeY = (py - view.offY) / view.scale;

    view.scale = clamp(view.scale * factor, 0.05, 20);
    view.offX = px - beforeX * view.scale;
    view.offY = py - beforeY * view.scale;

    redraw();
  }

  function resetView(){
    if(!img) return;
    view.scale = initialView.scale;
    view.offX = initialView.offX;
    view.offY = initialView.offY;
    view.rot  = initialView.rot;
    view.flipH = initialView.flipH;
    view.flipV = initialView.flipV;
    wEl.value = "";
    hEl.value = "";
    aspectLockEl.checked = true;
    aspectModeEl.value = "contain";
    redraw();
    setMsg(t().msg_ready, "ok");
  }

  fitBtn.addEventListener("click", ()=> img ? (()=>{
    const rect = stageRect();
    const s = Math.min(rect.width / imgW, rect.height / imgH);
    view.scale = s; view.offX = 0; view.offY = 0; redraw();
  })() : setMsg(t().msg_need,"err"));

  centerBtn.addEventListener("click", ()=> img ? (view.offX=0, view.offY=0, redraw()) : setMsg(t().msg_need,"err"));
  zoomInBtn.addEventListener("click", ()=> img ? zoomBy(1.08) : setMsg(t().msg_need,"err"));
  zoomOutBtn.addEventListener("click", ()=> img ? zoomBy(1/1.08) : setMsg(t().msg_need,"err"));

  rotLBtn.addEventListener("click", ()=> img ? (view.rot=(view.rot-90)%360, redraw()) : setMsg(t().msg_need,"err"));
  rotRBtn.addEventListener("click", ()=> img ? (view.rot=(view.rot+90)%360, redraw()) : setMsg(t().msg_need,"err"));

  flipHBtn.addEventListener("click", ()=> img ? (view.flipH*=-1, redraw()) : setMsg(t().msg_need,"err"));
  flipVBtn.addEventListener("click", ()=> img ? (view.flipV*=-1, redraw()) : setMsg(t().msg_need,"err"));
  resetViewBtn.addEventListener("click", ()=> img ? resetView() : setMsg(t().msg_need,"err"));

  // ===== pointer events + wheel (ÎÑà ÏõêÎ≥∏ Í∑∏ÎåÄÎ°ú Ïú†ÏßÄ) =====
  const pointers = new Map();
  let lastPan = null;
  let lastPinch = null;

  stage.addEventListener("pointerdown", (e)=>{
    stage.setPointerCapture(e.pointerId);
    pointers.set(e.pointerId, { x:e.clientX, y:e.clientY });

    if(pointers.size === 1){
      lastPan = { x:e.clientX, y:e.clientY, offX:view.offX, offY:view.offY };
      lastPinch = null;
    } else if(pointers.size === 2){
      const pts = Array.from(pointers.values());
      lastPinch = pinchState(pts[0], pts[1]);
      lastPan = null;
    }
  });

  stage.addEventListener("pointermove", (e)=>{
    if(!img) return;
    if(!pointers.has(e.pointerId)) return;

    pointers.set(e.pointerId, { x:e.clientX, y:e.clientY });

    if(pointers.size === 1 && lastPan){
      const dx = e.clientX - lastPan.x;
      const dy = e.clientY - lastPan.y;
      view.offX = lastPan.offX + dx;
      view.offY = lastPan.offY + dy;
      redraw();
      return;
    }

    if(pointers.size === 2 && lastPinch){
      const rect = stageRect();
      const pts = Array.from(pointers.values());
      const now = pinchState(pts[0], pts[1]);
      const factor = now.dist / (lastPinch.dist || now.dist);
      const cx = now.midX - rect.left;
      const cy = now.midY - rect.top;
      zoomBy(factor, cx, cy);
      lastPinch = now;
    }
  });

  stage.addEventListener("pointerup", (e)=>{
    pointers.delete(e.pointerId);
    if(pointers.size === 1){
      const pts = Array.from(pointers.values());
      lastPan = { x:pts[0].x, y:pts[0].y, offX:view.offX, offY:view.offY };
      lastPinch = null;
    } else {
      lastPan = null;
      lastPinch = null;
    }
  });

  stage.addEventListener("pointercancel", ()=>{
    pointers.clear(); lastPan = null; lastPinch = null;
  });

  function pinchState(a,b){
    const dx = a.x - b.x;
    const dy = a.y - b.y;
    const dist = Math.sqrt(dx*dx + dy*dy);
    return { dist, midX:(a.x+b.x)/2, midY:(a.y+b.y)/2 };
  }

  stage.addEventListener("wheel", (e)=>{
    if(!img) return;
    e.preventDefault();
    const rect = stageRect();
    const cx = e.clientX - rect.left;
    const cy = e.clientY - rect.top;
    const dir = (e.deltaY > 0) ? -1 : 1;
    const factor = dir > 0 ? 1.08 : 1/1.08;
    zoomBy(factor, cx, cy);
  }, { passive:false });

  // ‚úÖ ÌïµÏã¨: Î©îÏù∏ÏóêÏÑú Ïñ¥Îñ§ ÌÇ§Î°ú Ï†ÄÏû•Ìï¥ÎèÑ Ïû°ÏïÑÏò§Í∏∞
  function loadFromSession(){
    const imgKeys = [
      "cf24_edit_img",
      "cf24_idphoto_img",
      "cf24_preview_img",
      "cf24_main_preview_img",
      "cf24_preview_dataurl",
      "cf24_image_dataurl"
    ];
    const nameKeys = [
      "cf24_edit_name",
      "cf24_idphoto_name",
      "cf24_preview_name",
      "cf24_file_name"
    ];

    let dataUrl = null;
    for(const k of imgKeys){
      const v = sessionStorage.getItem(k);
      if(v && typeof v === "string" && v.startsWith("data:")){
        dataUrl = v; break;
      }
    }

    let name = "image";
    for(const k of nameKeys){
      const v = sessionStorage.getItem(k);
      if(v){ name = v; break; }
    }

    if(!dataUrl){
      setMsg(t().msg_need, "err");
      img = null;
      updateMeta();
      resizeCanvas();
      return;
    }

    imgName = name;

    const im = new Image();
    im.onload = ()=>{
      img = im;
      imgW = im.naturalWidth || 1;
      imgH = im.naturalHeight || 1;

      const rect = stageRect();
      const s = Math.min(rect.width / imgW, rect.height / imgH);
      initialView.scale = s;
      initialView.offX = 0;
      initialView.offY = 0;
      initialView.rot = 0;
      initialView.flipH = 1;
      initialView.flipV = 1;

      resetView();
      setMsg(t().msg_ready, "ok");
      updateMeta();
      resizeCanvas();
    };
    im.onerror = ()=>{
      img = null;
      imgW = imgH = 0;
      setMsg(t().msg_need, "err");
      updateMeta();
      resizeCanvas();
    };
    im.src = dataUrl;
  }

  function downloadBlob(blob, filename){
    const a = document.createElement("a");
    const url = URL.createObjectURL(blob);
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1500);
  }

  function buildName(){
    const stamp = new Date().toISOString().replace(/[:.]/g,"-");
    const mime = outFormatEl.value;
    const ext = (mime === "image/png") ? "png" : (mime === "image/webp" ? "webp" : "jpg");
    const base = (imgName || "image").replace(/\.[^.]+$/, "");
    return `${base}_edit_${stamp}.${ext}`;
  }

  // ‚úÖ ÎÑ§Í∞Ä Ïò¨Î¶∞ stageToOutput(Ïù¥ÎØ∏ÏßÄ ÏòÅÏó≠Îßå Ï†ÄÏû•) Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©ÌïòÎ©¥ Îê®.
  // Ïó¨Í∏∞ÏÑúÎäî Í∏∏Ïù¥ ÎïåÎ¨∏Ïóê ÏÉùÎûµ. (ÎÑàÍ∞Ä ÎßàÏßÄÎßâÏúºÎ°ú Î∂ôÏù∏ stageToOutput Í∑∏ÎåÄÎ°ú Ïú†ÏßÄ)

  // init
  setLang(LANG);
  updateMeta();
  resizeCanvas();
  loadFromSession();
})();
</script>
</body>
</html>