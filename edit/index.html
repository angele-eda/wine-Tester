<!doctype html>
<html lang="en" translate="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Edit Image | ConvertFiles24</title>
  <meta name="description" content="Edit images online: crop/move/zoom/rotate/flip, resize, and download. 100% local processing (no server upload)." />
  <meta name="robots" content="index,follow" />
  <meta name="theme-color" content="#0b0f17" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Noto+Sans+KR:wght@400;500;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --radius:16px;
      --pad:16px;
      --border:1px solid rgba(255,255,255,.12);
      --blue: 47,109,246;
      --ease: cubic-bezier(.2,.8,.2,1);
    }
    *{ box-sizing:border-box; }
    html, body{ width:100%; max-width:100%; overflow-x:hidden; }
    body{
      margin:0;
      font-family: Inter, "Noto Sans KR", system-ui, -apple-system, "Segoe UI", Roboto, "Apple SD Gothic Neo", sans-serif;
      background:#0b0f17;
      color:#e9eef7;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: geometricPrecision;
    }

    /* entrance */
    body:not(.loaded) .card, body:not(.loaded) .top{ opacity:0; transform: translateY(8px); }
    body.loaded .top{ animation: cfFadeUp .35s var(--ease) both; }
    body.loaded .card{ animation: cfFadeUp .38s var(--ease) both; }
    @keyframes cfFadeUp{ from{opacity:0; transform:translateY(8px);} to{opacity:1; transform:translateY(0);} }
    @media (prefers-reduced-motion: reduce){
      *{ animation:none !important; transition:none !important; scroll-behavior:auto !important; }
      body:not(.loaded) .card, body:not(.loaded) .top{ opacity:1; transform:none; }
    }

    .wrap{
      max-width:980px;
      width:100%;
      margin:0 auto;
      padding:22px 14px 44px;
      overflow-x: clip;
    }

    .top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
      margin-bottom:14px;
      min-width:0;
    }

    .title{
      margin:0;
      font-weight:900;
      letter-spacing:-0.35px;
      line-height:1.15;
      color:#ffffff;
      font-size:22px;
    }
    .sub{
      margin:8px 0 0;
      color:#a7b3c7;
      font-size:13px;
      line-height:1.45;
    }

    .homeBtn{
      width:100%;
      display:flex; align-items:center; justify-content:center; gap:10px;
      padding:12px 14px;
      border-radius:999px;
      border:1px solid rgba(47,109,246,.55);
      background:rgba(47,109,246,.18);
      color:#e9eef7;
      font-weight:900;
      cursor:pointer;
      text-decoration:none;
      user-select:none;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
      max-width:380px;
      transition: transform .08s var(--ease), background .12s var(--ease), box-shadow .12s var(--ease), filter .12s var(--ease);
    }
    .homeBtn:hover{ background:rgba(47,109,246,.24); }
    .homeBtn:active{
      transform: scale(.99);
      filter: brightness(1.04);
      box-shadow: 0 6px 16px rgba(0,0,0,.22), inset 0 0 0 1px rgba(255,255,255,.06);
    }
    .homeBtn:focus-visible{
      outline:none;
      box-shadow: 0 0 0 3px rgba(var(--blue),.35), 0 10px 24px rgba(0,0,0,.25);
    }

    .langRow{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:8px;
      min-width:220px;
      max-width:100%;
      margin-left:auto;
    }
    .langLabel{
      font-size:12px;
      font-weight:900;
      color:#9fb0ca;
      letter-spacing:-0.2px;
      display:flex;
      align-items:center;
      gap:8px;
      opacity:.95;
    }
    .langSelect{
      width:220px;
      max-width:100%;
      padding:12px 12px;
      border-radius:999px;
      border:var(--border);
      background:rgba(255,255,255,.06);
      color:#e9eef7;
      outline:none;
      font-weight:900;
      transition: box-shadow .12s var(--ease), border-color .12s var(--ease), transform .08s var(--ease);
    }
    .langSelect:focus-visible{
      outline:none;
      border-color: rgba(var(--blue), .55);
      box-shadow: 0 0 0 3px rgba(var(--blue),.25);
    }
    option{ background:#0b0f17; color:#e9eef7; }
    @media (max-width: 420px){
      .langRow{ min-width:180px; }
      .langSelect{ width:180px; }
    }

    .pill{
      width:100%;
      border:1px solid rgba(120, 200, 255, .22);
      background:rgba(120, 200, 255, .06);
      border-radius:999px;
      padding:10px 14px;
      color:#cfe6ff;
      font-size:13px;
      font-weight:900;
      display:flex; align-items:center; justify-content:center; gap:10px;
      min-width:0;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
    }

    .card{
      border:var(--border);
      background:rgba(255,255,255,.03);
      border-radius:var(--radius);
      padding:var(--pad);
      margin-top:12px;
      min-width:0;
      max-width:100%;
      overflow-x: clip;
      will-change: transform, opacity;
    }
    .card h2{
      margin:0 0 10px;
      font-size:15px;
      color:#dbe7ff;
      letter-spacing:-0.2px;
      line-height:1.2;
    }

    .cardHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin:0 0 10px;
    }
    .cardHead h2{ margin:0; }

    .headActions{
      display:flex;
      align-items:center;
      gap:10px;
      margin-left:auto;
    }

    .iconBtn{
      appearance:none;
      border:none;
      background:transparent;
      color:#dbe7ff;
      cursor:pointer;
      width:48px; height:48px;
      border-radius:12px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      transition: transform .08s var(--ease), background .12s var(--ease), box-shadow .12s var(--ease), opacity .12s var(--ease), filter .12s var(--ease);
      opacity:.92;
      padding:0;
    }
    .iconBtn:hover{ background: rgba(47,109,246,.07); opacity:1; }
    .iconBtn:active{
      transform: scale(.98);
      filter: brightness(1.04);
      background: rgba(47,109,246,.10);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
    }
    .iconBtn:focus-visible{
      outline:none;
      box-shadow: 0 0 0 3px rgba(var(--blue),.25);
      background: rgba(47,109,246,.07);
      opacity:1;
    }
    .iconBtn:disabled{ opacity:.45; cursor:not-allowed; transform:none; background:transparent; box-shadow:none; filter:none; }
    .iconBtn svg{ width:20px; height:20px; display:block; }

    .stageWrap{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:12px;
      min-width:0;
      max-width:100%;
    }
    @media (max-width: 860px){ .stageWrap{ grid-template-columns: 1fr; } }

    /* âœ… stageëŠ” overflow visible (í•¸ë“¤ ì•ˆ ì˜ë¦¼) */
    .stage{
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      position:relative;
      aspect-ratio: 4 / 3;
      min-height: 320px;
      touch-action: none;
      width:100%;
      max-width:100%;
      overflow: visible;
      background: transparent;
    }
    @media (max-width: 480px){ .stage{ min-height: 280px; } }

    /* âœ… ì´ë¯¸ì§€/ìº”ë²„ìŠ¤ë§Œ ê¹”ë”í•˜ê²Œ í´ë¦½ */
    .canvasClip{
      position:absolute;
      inset:0;
      border-radius:16px;
      overflow:hidden;
      background:rgba(0,0,0,.25);
      pointer-events:none; /* stageê°€ pan/zoomì„ ë°›ë„ë¡ */
    }
    .canvasClip canvas{
      display:block;
      width:100%;
      height:100%;
    }

    /* Crosshair overlay */
    .crosshair{
      position:absolute;
      left:50%; top:50%;
      width:56px; height:56px;
      transform:translate(-50%,-50%);
      pointer-events:none;
      opacity:.78;
      filter: drop-shadow(0 2px 8px rgba(0,0,0,.45));
    }
    .crosshair:before,
    .crosshair:after{
      content:"";
      position:absolute;
      left:50%; top:50%;
      background:rgba(235,245,255,.95);
      transform:translate(-50%,-50%);
      border-radius:999px;
    }
    .crosshair:before{ width:2px; height:46px; }
    .crosshair:after{ width:46px; height:2px; }
    .crossDot{
      position:absolute;
      left:50%; top:50%;
      width:10px; height:10px;
      transform:translate(-50%,-50%);
      border-radius:999px;
      border:2px solid rgba(235,245,255,.95);
      background:rgba(11,15,23,.35);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.25);
    }

    /* Crop overlay */
    .cropOverlay{
      position:absolute;
      inset:0;
      display:none;
      pointer-events:none;
    }
    .cropOverlay.show{ display:block; }

    .cropShade{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,.32);
      pointer-events:none;
      border-radius:16px;
    }

    .cropBox{
      position:absolute;
      border:2px solid rgba(106,169,255,.9);
      border-radius:10px;
      box-shadow: 0 0 0 9999px rgba(0,0,0,.35);
      pointer-events:none;
      touch-action:none;
    }

    .cropGrid{
      position:absolute;
      inset:0;
      border-radius:10px;
      overflow:hidden;
      opacity:.35;
      pointer-events:none;
    }
    .cropGrid::before, .cropGrid::after{
      content:"";
      position:absolute; inset:0;
      background:
        linear-gradient(to right, rgba(255,255,255,.5) 0 0) 33.33% 0/1px 100% no-repeat,
        linear-gradient(to right, rgba(255,255,255,.5) 0 0) 66.66% 0/1px 100% no-repeat,
        linear-gradient(to bottom, rgba(255,255,255,.5) 0 0) 0 33.33%/100% 1px no-repeat,
        linear-gradient(to bottom, rgba(255,255,255,.5) 0 0) 0 66.66%/100% 1px no-repeat;
    }

    .handle{
      position:absolute;
      width:48px; height:48px;
      border-radius:999px;
      background: transparent;
      transform: translate(-50%,-50%);
      pointer-events:auto;
      touch-action:none;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .handleDot{
      width:18px; height:18px;
      border-radius:999px;
      background: rgba(235,245,255,.95);
      box-shadow: 0 6px 14px rgba(0,0,0,.35);
      pointer-events:none;
    }

    .handle[data-h="n"]{ left:50%; top:0%; cursor: ns-resize; }
    .handle[data-h="s"]{ left:50%; top:100%; cursor: ns-resize; }
    .handle[data-h="w"]{ left:0%;  top:50%; cursor: ew-resize; }
    .handle[data-h="e"]{ left:100%;top:50%; cursor: ew-resize; }
    .handle[data-h="nw"]{ left:0%;  top:0%; cursor: nwse-resize; }
    .handle[data-h="ne"]{ left:100%;top:0%; cursor: nesw-resize; }
    .handle[data-h="sw"]{ left:0%;  top:100%; cursor: nesw-resize; }
    .handle[data-h="se"]{ left:100%;top:100%; cursor: nwse-resize; }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      min-width:0;
    }
    .row > *{
      flex:1;
      min-width:160px;
      max-width:100%;
      min-width:0;
    }

    .btn{
      appearance:none; border:none; cursor:pointer;
      background:#2f6df6; color:white; font-weight:900;
      padding:12px 14px; border-radius:14px; width:100%;
      font-size:14px;
      letter-spacing: -0.2px;
      user-select:none;
      transition: transform .08s var(--ease), filter .12s var(--ease), box-shadow .12s var(--ease), background .12s var(--ease), border-color .12s var(--ease);
      min-height:48px;
    }

    .btn.secondary{
      background: rgba(47,109,246,.14);
      color:#e9eef7;
      border: 1px solid rgba(47,109,246,.30);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
    }
    .btn.secondary:hover{
      background: rgba(47,109,246,.18);
      border-color: rgba(47,109,246,.36);
    }

    .btn:hover{ filter: brightness(1.02); }
    .btn:active{
      transform: scale(.99);
      filter: brightness(1.05);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.07), 0 10px 18px rgba(0,0,0,.18);
    }
    .btn.secondary:active{
      background: rgba(47,109,246,.22);
      border-color: rgba(47,109,246,.44);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.07);
    }
    .btn:focus-visible{ outline:none; box-shadow: 0 0 0 3px rgba(var(--blue),.22); }
    .btn:disabled{ opacity:.45; cursor:not-allowed; transform:none; filter:none; box-shadow:none; }

    label{ display:block; font-size:12px; color:#a7b3c7; margin-bottom:6px; }
    select, input[type="number"]{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      background:rgba(255,255,255,.06);
      color:#e9eef7;
      border:var(--border);
      outline:none;
      font-weight:900;
      max-width:100%;
      transition: box-shadow .12s var(--ease), border-color .12s var(--ease);
      min-height:48px;
    }
    select:focus-visible, input[type="number"]:focus-visible{
      border-color: rgba(var(--blue), .55);
      box-shadow: 0 0 0 3px rgba(var(--blue),.22);
    }

    .chkRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .chk{
      display:inline-flex;
      gap:8px;
      align-items:center;
      border:var(--border);
      background:rgba(255,255,255,.04);
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      user-select:none;
      font-size:12px;
      color:#cfe0ff;
      white-space:nowrap;
      width: fit-content;
      min-height:48px;
    }
    .chk input{ width:18px; height:18px; }

    .hint{ margin-top:10px; color:#9fb0ca; font-size:12px; line-height:1.5; }
    .msg{ margin-top:10px; font-size:13px; color:#cfe0ff; }
    .msg.err{ color:#ffb4b4; }
    .msg.ok{ color:#b8ffcc; }

    .meta{
      color:#b7c3d9;
      font-size:13px;
      line-height:1.5;
      word-break:break-word;
      min-width:0;
    }
    .meta b{ color:#e9eef7; }

    .footer{
      margin-top:16px;
      color:#94a6c2;
      font-size:12px;
      text-align:center;
    }
    .footer a{ color:#9fb0ca; text-decoration:none; border-bottom:1px dashed rgba(159,176,202,.35); }
    .footer a:hover{ color:#cfe0ff; border-bottom-color:rgba(207,224,255,.6); }

    input[type="file"]{ display:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div style="flex:1; min-width:240px;">
        <h1 class="title" id="page_title">Edit</h1>
        <p class="sub" id="page_sub">Move/zoom/rotate/flip â†’ crop â†’ resize â†’ download. 100% local processing.</p>

        <div style="margin-top:10px;">
          <a class="homeBtn" href="/" id="home_btn">ğŸ  Home</a>
        </div>

        <div style="margin-top:10px;">
          <div class="pill">ğŸ”’ <span id="local_processing">Processed locally â€” no server upload</span></div>
        </div>
      </div>

      <div class="langRow">
        <div class="langLabel">ğŸŒ <span id="lang_label">Language</span></div>
        <select class="langSelect" id="langSelect" aria-label="Language">
          <option value="en">Global (English)</option>
          <option value="ko">í•œêµ­ì–´</option>
          <option value="es">EspaÃ±ol</option>
          <option value="ja">æ—¥æœ¬èª</option>
        </select>
      </div>
    </div>

    <div class="stageWrap">
      <!-- Left: stage -->
      <div class="card">
        <h2 id="h_stage">Preview / Edit</h2>
        <div class="stage" id="stage">
          <!-- âœ… ìº”ë²„ìŠ¤ëŠ” í´ë¦½ ë˜í¼ ì•ˆ -->
          <div class="canvasClip" aria-hidden="true">
            <canvas id="cv"></canvas>
          </div>

          <!-- Crop overlay -->
          <div class="cropOverlay" id="cropOverlay" aria-hidden="true">
            <div class="cropShade"></div>
            <div class="cropBox" id="cropBox" role="application" aria-label="Crop box">
              <div class="cropGrid"></div>

              <div class="handle" data-h="nw"><span class="handleDot"></span></div>
              <div class="handle" data-h="n"><span class="handleDot"></span></div>
              <div class="handle" data-h="ne"><span class="handleDot"></span></div>
              <div class="handle" data-h="w"><span class="handleDot"></span></div>
              <div class="handle" data-h="e"><span class="handleDot"></span></div>
              <div class="handle" data-h="sw"><span class="handleDot"></span></div>
              <div class="handle" data-h="s"><span class="handleDot"></span></div>
              <div class="handle" data-h="se"><span class="handleDot"></span></div>
            </div>
          </div>

          <div class="crosshair" aria-hidden="true">
            <div class="crossDot" aria-hidden="true"></div>
          </div>
        </div>
        <div class="msg" id="msg"></div>
      </div>

      <!-- Right: controls -->
      <div class="card">
        <div class="cardHead">
          <h2 id="h_controls">Controls</h2>

          <div class="headActions" aria-label="Quick actions">
            <button class="iconBtn" id="loadImgBtn" type="button" aria-label="Load image" title="Load image">
              <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M4.5 6.8c0-1.1.9-2 2-2h11c1.1 0 2 .9 2 2v10.4c0 1.1-.9 2-2 2h-11c-1.1 0-2-.9-2-2V6.8Z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
                <path d="M8 13.4l2.2-2.2a1.1 1.1 0 0 1 1.6 0l2.6 2.6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M13.6 12.8l1-1a1.1 1.1 0 0 1 1.6 0l2.2 2.2" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M9.1 9.2h.01" stroke="currentColor" stroke-width="3.2" stroke-linecap="round"/>
              </svg>
            </button>

            <button class="iconBtn" id="undoBtn" type="button" aria-label="Undo / Reset view" title="Undo / Reset view" disabled>
              <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M20 12a8 8 0 1 1-2.35-5.65" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M20 4v6h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
        </div>

        <div class="row">
          <button class="btn secondary" id="cropToggleBtn" type="button">âœ‚ï¸ Crop: ON</button>
          <button class="btn secondary" id="cropApplyBtn" type="button">âœ‚ï¸ Crop</button>
        </div>

        <div style="height:10px;"></div>

        <div class="row">
          <button class="btn secondary" id="hiResBtn" type="button">âœ¨ Hi-Res: ON</button>
        </div>
        <div class="hint" id="hires_hint">Hi-Res ON = sharper crop/export but may be heavier on memory.</div>

        <div style="height:10px;"></div>

        <div class="row">
          <button class="btn secondary" id="fitBtn" type="button">â†” Fit</button>
          <button class="btn secondary" id="centerBtn" type="button">ğŸ¯ Center</button>
        </div>

        <div style="height:10px;"></div>

        <div class="row">
          <button class="btn secondary" id="zoomOutBtn" type="button">â– Zoom out</button>
          <button class="btn secondary" id="zoomInBtn" type="button">â• Zoom in</button>
        </div>

        <div style="height:10px;"></div>

        <div class="row">
          <button class="btn secondary" id="rotLBtn" type="button">âŸ² Rotate</button>
          <button class="btn secondary" id="rotRBtn" type="button">âŸ³ Rotate</button>
        </div>

        <div style="height:10px;"></div>

        <div class="row">
          <button class="btn secondary" id="flipHBtn" type="button">â‡‹ Flip H</button>
          <button class="btn secondary" id="flipVBtn" type="button">â‡µ Flip V</button>
        </div>

        <div style="height:12px;"></div>

        <h2 id="h_output">Output</h2>

        <div class="row">
          <div>
            <label id="lbl_format">Format</label>
            <select id="outFormat">
              <option value="image/jpeg" selected>JPG</option>
              <option value="image/png">PNG</option>
              <option value="image/webp">WebP</option>
            </select>
          </div>
          <div>
            <label id="lbl_quality">Quality</label>
            <select id="quality">
              <option value="0.95">Max (0.95)</option>
              <option value="0.90" selected>High (0.90)</option>
              <option value="0.80">Normal (0.80)</option>
              <option value="0.70">Small (0.70)</option>
            </select>
          </div>
        </div>

        <div style="height:10px;"></div>

        <div class="row">
          <div>
            <label id="lbl_w">Width (px)</label>
            <input id="w" type="number" min="1" placeholder="blank = stage size">
          </div>
          <div>
            <label id="lbl_h">Height (px)</label>
            <input id="h" type="number" min="1" placeholder="blank = stage size">
          </div>
        </div>

        <div class="hint" id="size_hint">If you fill only one side, aspect ratio is preserved automatically.</div>

        <div style="height:12px;"></div>

        <h2 id="h_aspect">Aspect</h2>

        <div class="chkRow">
          <label class="chk" title="Keep aspect ratio when exporting">
            <input type="checkbox" id="aspectLock" checked>
            <span id="aspect_lock_txt">Keep aspect ratio</span>
          </label>
        </div>

        <div style="height:8px;"></div>

        <div class="row">
          <div>
            <label id="lbl_aspectMode">Mode</label>
            <select id="aspectMode">
              <option value="contain" selected>Contain (no crop)</option>
              <option value="cover">Cover (crop)</option>
              <option value="stretch">Stretch (fill)</option>
            </select>
            <div class="hint" id="aspect_hint">Contain = may add margins â€¢ Cover = fills and may crop â€¢ Stretch = distorts</div>
          </div>
        </div>

        <div style="height:12px;"></div>

        <h2 id="h_download">Download</h2>
        <button class="btn" id="downloadBtn" type="button" disabled>â¬‡ï¸ Download</button>

        <div style="height:10px;"></div>
        <button class="btn secondary" id="resetAllBtn" type="button" disabled>Reset (remove image)</button>

        <div style="height:12px;"></div>
        <div class="meta" id="meta">
          <b>Preview</b><br/>Open from main preview âœ‚ï¸ button.
        </div>
      </div>
    </div>

    <div class="footer">
      Â© <span id="year"></span> ConvertFiles24 Â·
      <a href="/privacy.html">Privacy</a> Â·
      <a href="/terms.html">Terms</a>
    </div>
  </div>

  <input id="pickInput" type="file" accept="image/*">

<script>
(() => {
  "use strict";
  const $ = (id)=>document.getElementById(id);
  $("year").textContent = new Date().getFullYear();
  requestAnimationFrame(()=> document.body.classList.add("loaded"));

  // ========= i18n =========
  const STR = {
    en: {
      page_title: "Edit",
      page_sub: "Move/zoom/rotate/flip â†’ crop â†’ resize â†’ download. 100% local processing.",
      home: "ğŸ  Home",
      local: "Processed locally â€” no server upload",
      lang_label: "Language",

      h_stage: "Preview / Edit",
      controls: "Controls",

      crop_on: "âœ‚ï¸ Crop: ON",
      crop_off: "âœ‚ï¸ Crop: OFF",
      crop_apply: "âœ‚ï¸ Crop",

      hires_on: "âœ¨ Hi-Res: ON",
      hires_off:"âœ¨ Hi-Res: OFF",
      hires_hint:"Hi-Res ON = sharper crop/export but may be heavier on memory.",

      fit: "â†” Fit",
      center: "ğŸ¯ Center",
      zoomOut: "â– Zoom out",
      zoomIn: "â• Zoom in",
      rotL: "âŸ² Rotate",
      rotR: "âŸ³ Rotate",
      flipH: "â‡‹ Flip H",
      flipV: "â‡µ Flip V",

      loadImg: "Load image",
      undo: "Undo / Reset view",

      h_output: "Output",
      format: "Format",
      quality: "Quality",
      w: "Width (px)",
      h: "Height (px)",
      size_hint: "If you fill only one side, aspect ratio is preserved automatically.",

      h_aspect: "Aspect",
      aspect_lock: "Keep aspect ratio",
      aspect_mode: "Mode",
      aspect_hint: "Contain = may add margins â€¢ Cover = fills and may crop â€¢ Stretch = distorts",

      h_download: "Download",
      download: "â¬‡ï¸ Download",
      reset_all: "Reset (remove image)",

      msg_need: "No image found. Go back to main page and press âœ‚ï¸ next to Preview.",
      msg_ready: "Ready. Drag to move. Pinch / mouse wheel / buttons to zoom.",
      msg_crop_on: "Crop ON: Drag handles to resize. (Box does not move.) Press Crop to apply.",
      msg_crop_applied: "âœ… Cropped",
      msg_ok: "âœ… Downloaded",
      msg_idb_fail: "Could not load from local storage. Try re-opening from main page.",

      meta_idle: "<b>Preview</b><br/>Open from main preview âœ‚ï¸ button.",
      meta_info: (name, w, h) => `<b>Image</b><br/>Name: ${name}<br/>Resolution: ${w}Ã—${h}px`
    },
    ko: {
      page_title: "í¸ì§‘",
      page_sub: "ì´ë™/í™•ëŒ€/íšŒì „/ë°˜ì „ â†’ ìë¥´ê¸° â†’ í¬ê¸° ì¡°ì ˆ â†’ ë‹¤ìš´ë¡œë“œ. 100% ë¡œì»¬ ì²˜ë¦¬.",
      home: "ğŸ  í™ˆìœ¼ë¡œ",
      local: "ë¡œì»¬ ì²˜ë¦¬ â€” ì„œë²„ ì—…ë¡œë“œ ì—†ìŒ",
      lang_label: "ì–¸ì–´",

      h_stage: "ë¯¸ë¦¬ë³´ê¸° / í¸ì§‘",
      controls: "ì¡°ì‘",

      crop_on: "âœ‚ï¸ ìë¥´ê¸°: ON",
      crop_off: "âœ‚ï¸ ìë¥´ê¸°: OFF",
      crop_apply: "âœ‚ï¸ ìë¥´ê¸°",

      hires_on: "âœ¨ ê³ í™”ì§ˆ: ON",
      hires_off:"âœ¨ ê³ í™”ì§ˆ: OFF",
      hires_hint:"ê³ í™”ì§ˆ ON = ë” ì„ ëª…í•œ í¬ë¡­/ì €ì¥(ê¸°ê¸° ë©”ëª¨ë¦¬ ë¶€ë‹´ì´ ëŠ˜ ìˆ˜ ìˆì–´ìš”).",

      fit: "â†” ë§ì¶”ê¸°",
      center: "ğŸ¯ ì¤‘ì•™",
      zoomOut: "â– ì¶•ì†Œ",
      zoomIn: "â• í™•ëŒ€",
      rotL: "âŸ² íšŒì „",
      rotR: "âŸ³ íšŒì „",
      flipH: "â‡‹ ì¢Œìš°ë°˜ì „",
      flipV: "â‡µ ìƒí•˜ë°˜ì „",

      loadImg: "ì´ë¯¸ì§€ ë¶ˆëŸ¬ì˜¤ê¸°",
      undo: "ë˜ëŒë¦¬ê¸°/ë·°ì´ˆê¸°í™”",

      h_output: "ì¶œë ¥",
      format: "í˜•ì‹",
      quality: "í’ˆì§ˆ",
      w: "ê°€ë¡œ(px)",
      h: "ì„¸ë¡œ(px)",
      size_hint: "í•œìª½ë§Œ ì…ë ¥í•˜ë©´ ë¹„ìœ¨ ìœ ì§€ë¡œ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.",

      h_aspect: "ë¹„ìœ¨",
      aspect_lock: "ë¹„ìœ¨ ìœ ì§€",
      aspect_mode: "ëª¨ë“œ",
      aspect_hint: "Contain=ì—¬ë°± ê°€ëŠ¥ â€¢ Cover=ê½‰ ì±„ìš°ê³  ì¼ë¶€ ì˜ë¦´ ìˆ˜ ìˆìŒ â€¢ Stretch=ëŠ˜ì–´ë‚¨",

      h_download: "ë‹¤ìš´ë¡œë“œ",
      download: "â¬‡ï¸ ë‹¤ìš´ë¡œë“œ",
      reset_all: "ì´ˆê¸°í™”(ì´ë¯¸ì§€ ì œê±°)",

      msg_need: "ì´ë¯¸ì§€ê°€ ì—†ì–´ìš”. ë©”ì¸ì—ì„œ ë¯¸ë¦¬ë³´ê¸° ì˜† âœ‚ï¸ ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ë“¤ì–´ì˜¤ì„¸ìš”.",
      msg_ready: "ì¤€ë¹„ ì™„ë£Œ! ë“œë˜ê·¸ë¡œ ì´ë™, í•€ì¹˜/ë§ˆìš°ìŠ¤íœ /ë²„íŠ¼ìœ¼ë¡œ í™•ëŒ€í•˜ì„¸ìš”.",
      msg_crop_on: "ìë¥´ê¸° ON: í•¸ë“¤ë¡œ í¬ê¸°ë§Œ ì¡°ì ˆí•©ë‹ˆë‹¤(ë°•ìŠ¤ ì´ë™ ì—†ìŒ). â€˜ìë¥´ê¸°â€™ë¡œ ì ìš©í•˜ì„¸ìš”.",
      msg_crop_applied: "âœ… ì˜ë¼ëƒˆì–´ìš”",
      msg_ok: "âœ… ë‹¤ìš´ë¡œë“œ ì™„ë£Œ",
      msg_idb_fail: "ë¡œì»¬ ì €ì¥ì†Œì—ì„œ ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”. ë©”ì¸ì—ì„œ ë‹¤ì‹œ ì—´ì–´ì£¼ì„¸ìš”.",

      meta_idle: "<b>ë¯¸ë¦¬ë³´ê¸°</b><br/>ë©”ì¸ ë¯¸ë¦¬ë³´ê¸° ì˜† âœ‚ï¸ ë²„íŠ¼ìœ¼ë¡œ ì—´ì–´ì£¼ì„¸ìš”.",
      meta_info: (name, w, h) => `<b>ì´ë¯¸ì§€</b><br/>íŒŒì¼ëª…: ${name}<br/>í•´ìƒë„: ${w}Ã—${h}px`
    },
    es: {
      page_title: "Editar",
      page_sub: "Mover/zoom/rotar/voltear â†’ recortar â†’ redimensionar â†’ descargar. 100% local.",
      home: "ğŸ  Inicio",
      local: "Procesado local â€” sin servidor",
      lang_label: "Idioma",

      h_stage: "Vista previa / Editar",
      controls: "Controles",

      crop_on: "âœ‚ï¸ Recorte: ON",
      crop_off: "âœ‚ï¸ Recorte: OFF",
      crop_apply: "âœ‚ï¸ Recortar",

      hires_on: "âœ¨ Alta: ON",
      hires_off:"âœ¨ Alta: OFF",
      hires_hint:"ON = recorte/exportaciÃ³n mÃ¡s nÃ­tidos, pero puede usar mÃ¡s memoria.",

      fit: "â†” Ajustar",
      center: "ğŸ¯ Centrar",
      zoomOut: "â– Alejar",
      zoomIn: "â• Acercar",
      rotL: "âŸ² Rotar",
      rotR: "âŸ³ Rotar",
      flipH: "â‡‹ Voltear H",
      flipV: "â‡µ Voltear V",

      loadImg: "Cargar imagen",
      undo: "Deshacer / Reiniciar vista",

      h_output: "Salida",
      format: "Formato",
      quality: "Calidad",
      w: "Ancho (px)",
      h: "Alto (px)",
      size_hint: "Si introduces solo un lado, se mantiene la proporciÃ³n automÃ¡ticamente.",

      h_aspect: "ProporciÃ³n",
      aspect_lock: "Mantener proporciÃ³n",
      aspect_mode: "Modo",
      aspect_hint: "Contain = puede dejar mÃ¡rgenes â€¢ Cover = rellena y puede recortar â€¢ Stretch = deforma",

      h_download: "Descargar",
      download: "â¬‡ï¸ Descargar",
      reset_all: "Reiniciar (quitar imagen)",

      msg_need: "No se encontrÃ³ imagen. Vuelve a la pÃ¡gina principal y pulsa âœ‚ï¸ junto a Vista previa.",
      msg_ready: "Listo. Arrastra para mover. Pellizca / rueda del ratÃ³n / botones para zoom.",
      msg_crop_on: "Recorte ON: Ajusta SOLO con asas. (El cuadro no se mueve.) Pulsa Recortar para aplicar.",
      msg_crop_applied: "âœ… Recortado",
      msg_ok: "âœ… Descargado",
      msg_idb_fail: "No se pudo cargar desde almacenamiento local. Vuelve a abrir desde la pÃ¡gina principal.",

      meta_idle: "<b>Vista previa</b><br/>Abrir desde el botÃ³n âœ‚ï¸ junto a Vista previa en la pÃ¡gina principal.",
      meta_info: (name, w, h) => `<b>Imagen</b><br/>Nombre: ${name}<br/>ResoluciÃ³n: ${w}Ã—${h}px`
    },
    ja: {
      page_title: "ç·¨é›†",
      page_sub: "ç§»å‹•/ã‚ºãƒ¼ãƒ /å›è»¢/åè»¢ â†’ åˆ‡ã‚ŠæŠœã â†’ ãƒªã‚µã‚¤ã‚º â†’ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€‚100% ãƒ­ãƒ¼ã‚«ãƒ«å‡¦ç†ã€‚",
      home: "ğŸ  ãƒ›ãƒ¼ãƒ ",
      local: "ãƒ­ãƒ¼ã‚«ãƒ«å‡¦ç† â€” ã‚µãƒ¼ãƒãƒ¼ãªã—",
      lang_label: "è¨€èª",

      h_stage: "ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ / ç·¨é›†",
      controls: "æ“ä½œ",

      crop_on: "âœ‚ï¸ åˆ‡ã‚ŠæŠœã: ON",
      crop_off: "âœ‚ï¸ åˆ‡ã‚ŠæŠœã: OFF",
      crop_apply: "âœ‚ï¸ åˆ‡ã‚ŠæŠœã",

      hires_on: "âœ¨ é«˜ç”»è³ª: ON",
      hires_off:"âœ¨ é«˜ç”»è³ª: OFF",
      hires_hint:"ON = ã‚ˆã‚Šé®®æ˜ãªåˆ‡ã‚ŠæŠœã/ä¿å­˜ï¼ˆãƒ¡ãƒ¢ãƒªè² è·ãŒå¢—ãˆã‚‹å¯èƒ½æ€§ï¼‰",

      fit: "â†” ãƒ•ã‚£ãƒƒãƒˆ",
      center: "ğŸ¯ ä¸­å¤®",
      zoomOut: "â– ç¸®å°",
      zoomIn: "â• æ‹¡å¤§",
      rotL: "âŸ² å›è»¢",
      rotR: "âŸ³ å›è»¢",
      flipH: "â‡‹ å·¦å³åè»¢",
      flipV: "â‡µ ä¸Šä¸‹åè»¢",

      loadImg: "ç”»åƒã‚’èª­ã¿è¾¼ã‚€",
      undo: "æˆ»ã™/è¡¨ç¤ºãƒªã‚»ãƒƒãƒˆ",

      h_output: "å‡ºåŠ›",
      format: "å½¢å¼",
      quality: "å“è³ª",
      w: "å¹…(px)",
      h: "é«˜ã•(px)",
      size_hint: "ç‰‡æ–¹ã ã‘å…¥åŠ›ã™ã‚‹ã¨æ¯”ç‡ã‚’ç¶­æŒã—ã¦è‡ªå‹•è¨ˆç®—ã—ã¾ã™ã€‚",

      h_aspect: "æ¯”ç‡",
      aspect_lock: "æ¯”ç‡ã‚’ç¶­æŒ",
      aspect_mode: "ãƒ¢ãƒ¼ãƒ‰",
      aspect_hint: "Contain=ä½™ç™½ã‚ã‚Š â€¢ Cover=å…¨é¢è¡¨ç¤º(ä¸€éƒ¨åˆ‡ã‚Œã‚‹) â€¢ Stretch=å¤‰å½¢",

      h_download: "ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
      download: "â¬‡ï¸ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
      reset_all: "ãƒªã‚»ãƒƒãƒˆ(ç”»åƒå‰Šé™¤)",

      msg_need: "ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ¡ã‚¤ãƒ³ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ¨ªã® âœ‚ï¸ ã‚’æŠ¼ã—ã¦é–‹ã„ã¦ãã ã•ã„ã€‚",
      msg_ready: "æº–å‚™OKã€‚ãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹•ã€ãƒ”ãƒ³ãƒ/ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«/ãƒœã‚¿ãƒ³ã§ã‚ºãƒ¼ãƒ ã€‚",
      msg_crop_on: "åˆ‡ã‚ŠæŠœãON: ãƒãƒ³ãƒ‰ãƒ«ã®ã¿ã§ã‚µã‚¤ã‚ºå¤‰æ›´ã€‚(æ ã¯ç§»å‹•ã—ã¾ã›ã‚“) åˆ‡ã‚ŠæŠœãã§é©ç”¨ã€‚",
      msg_crop_applied: "âœ… åˆ‡ã‚ŠæŠœãå®Œäº†",
      msg_ok: "âœ… ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†",
      msg_idb_fail: "ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã‹ã‚‰èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ¡ã‚¤ãƒ³ã‹ã‚‰é–‹ãç›´ã—ã¦ãã ã•ã„ã€‚",

      meta_idle: "<b>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</b><br/>ãƒ¡ã‚¤ãƒ³ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ¨ª âœ‚ï¸ ã‹ã‚‰é–‹ã„ã¦ãã ã•ã„ã€‚",
      meta_info: (name, w, h) => `<b>ç”»åƒ</b><br/>åå‰: ${name}<br/>è§£åƒåº¦: ${w}Ã—${h}px`
    }
  };

  function getQueryLang(){
    try{
      const u = new URL(location.href);
      const q = (u.searchParams.get("lang")||"").toLowerCase();
      if(q && STR[q]) return q;
    }catch(e){}
    return null;
  }
  function detectLang(){
    const q = getQueryLang();
    if(q) return q;
    const saved = localStorage.getItem("cf24_lang");
    if(saved && STR[saved]) return saved;
    const nav = (navigator.language || "").toLowerCase();
    if(nav.startsWith("ko")) return "ko";
    if(nav.startsWith("ja")) return "ja";
    if(nav.startsWith("es")) return "es";
    return "en";
  }

  let LANG = detectLang();
  function t(){ return STR[LANG] || STR.en; }

  // ========= Hi-Res mode (persist) =========
  function detectHiRes(){
    const saved = localStorage.getItem("cf24_hires");
    if(saved === "0") return false;
    if(saved === "1") return true;
    return true; // âœ… ê¸°ë³¸ ON
  }
  let HIRES = detectHiRes();
  function setHiRes(on){
    HIRES = !!on;
    localStorage.setItem("cf24_hires", HIRES ? "1" : "0");
    syncHiResUI();
  }

  function setLang(lang){
    if(!STR[lang]) lang = "en";
    LANG = lang;
    localStorage.setItem("cf24_lang", lang);
    $("langSelect").value = lang;
    document.documentElement.lang = lang;

    $("page_title").textContent = t().page_title;
    $("page_sub").textContent = t().page_sub;
    $("home_btn").textContent = t().home;
    $("local_processing").textContent = t().local;
    $("lang_label").textContent = t().lang_label;

    $("h_stage").textContent = t().h_stage;
    $("h_controls").textContent = t().controls;

    syncCropBtnText();
    syncHiResUI();

    $("fitBtn").textContent = t().fit;
    $("centerBtn").textContent = t().center;
    $("zoomOutBtn").textContent = t().zoomOut;
    $("zoomInBtn").textContent = t().zoomIn;
    $("rotLBtn").textContent = t().rotL;
    $("rotRBtn").textContent = t().rotR;
    $("flipHBtn").textContent = t().flipH;
    $("flipVBtn").textContent = t().flipV;

    $("loadImgBtn").setAttribute("aria-label", t().loadImg);
    $("loadImgBtn").setAttribute("title", t().loadImg);
    $("undoBtn").setAttribute("aria-label", t().undo);
    $("undoBtn").setAttribute("title", t().undo);

    $("h_output").textContent = t().h_output;
    $("lbl_format").textContent = t().format;
    $("lbl_quality").textContent = t().quality;
    $("lbl_w").textContent = t().w;
    $("lbl_h").textContent = t().h;
    $("size_hint").textContent = t().size_hint;

    $("h_aspect").textContent = t().h_aspect;
    $("aspect_lock_txt").textContent = t().aspect_lock;
    $("lbl_aspectMode").textContent = t().aspect_mode;
    $("aspect_hint").textContent = t().aspect_hint;

    $("h_download").textContent = t().h_download;
    $("downloadBtn").textContent = t().download;
    $("resetAllBtn").textContent = t().reset_all;

    if(!img) $("meta").innerHTML = t().meta_idle;
    setTimeout(()=>resizeCanvas(), 0);
  }
  $("langSelect").addEventListener("change", (e)=> setLang(e.target.value));

  // ========= IndexedDB bridge (same store as index) =========
  const CF24_IDB_NAME = "cf24_blob_store_v1";
  const CF24_IDB_STORE = "blobs";

  function idbOpen(){
    return new Promise((resolve, reject)=>{
      if(!("indexedDB" in window)) return reject(new Error("IndexedDB not supported"));
      const req = indexedDB.open(CF24_IDB_NAME, 1);
      req.onupgradeneeded = () => {
        const db = req.result;
        if(!db.objectStoreNames.contains(CF24_IDB_STORE)){
          db.createObjectStore(CF24_IDB_STORE);
        }
      };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error || new Error("IDB open fail"));
    });
  }

  async function idbGet(key){
    const db = await idbOpen();
    return new Promise((resolve, reject)=>{
      const tx = db.transaction(CF24_IDB_STORE, "readonly");
      const store = tx.objectStore(CF24_IDB_STORE);
      const req = store.get(key);
      req.onsuccess = () => resolve(req.result || null);
      req.onerror = () => reject(req.error || new Error("IDB get fail"));
      tx.oncomplete = () => { try{ db.close(); }catch(e){} };
      tx.onerror = () => { try{ db.close(); }catch(e){} };
      tx.onabort = () => { try{ db.close(); }catch(e){} };
    });
  }

  async function idbPut(key, blob){
    const db = await idbOpen();
    return new Promise((resolve, reject)=>{
      const tx = db.transaction(CF24_IDB_STORE, "readwrite");
      const store = tx.objectStore(CF24_IDB_STORE);
      store.put(blob, key);
      tx.oncomplete = () => { try{ db.close(); }catch(e){} resolve(true); };
      tx.onerror = () => { try{ db.close(); }catch(e){} reject(tx.error || new Error("IDB put fail")); };
      tx.onabort = () => { try{ db.close(); }catch(e){} reject(tx.error || new Error("IDB put abort")); };
    });
  }

  // ========= editor engine =========
  const stage = $("stage");
  const cv = $("cv");
  const ctx = cv.getContext("2d", { alpha:true });

  const cropOverlay = $("cropOverlay");
  const cropBoxEl = $("cropBox");
  const cropToggleBtn = $("cropToggleBtn");
  const cropApplyBtn = $("cropApplyBtn");

  const hiResBtn = $("hiResBtn");
  const hiResHintEl = $("hires_hint");

  const fitBtn = $("fitBtn");
  const centerBtn = $("centerBtn");
  const zoomInBtn = $("zoomInBtn");
  const zoomOutBtn = $("zoomOutBtn");
  const rotLBtn = $("rotLBtn");
  const rotRBtn = $("rotRBtn");
  const flipHBtn = $("flipHBtn");
  const flipVBtn = $("flipVBtn");

  const loadImgBtn = $("loadImgBtn");
  const pickInput = $("pickInput");
  const undoBtn = $("undoBtn");

  const outFormatEl = $("outFormat");
  const qualityEl = $("quality");
  const wEl = $("w");
  const hEl = $("h");
  const aspectLockEl = $("aspectLock");
  const aspectModeEl = $("aspectMode");

  const downloadBtn = $("downloadBtn");
  const resetAllBtn = $("resetAllBtn");
  const msgEl = $("msg");

  let img = null;
  let imgName = "image";
  let imgW = 0, imgH = 0;

  const initialView = { scale: 1, offX: 0, offY: 0, rot: 0, flipH: 1, flipV: 1 };
  const view = { scale: 1, offX: 0, offY: 0, rot: 0, flipH: 1, flipV: 1 };

  let cropOn = true;
  const crop = { x: 0, y: 0, w: 0, h: 0 };
  const CROP_MIN = 60;

  const history = [];
  function snap(){
    return { view: { ...view }, crop: { ...crop }, cropOn, HIRES };
  }
  function sameSnap(a,b){
    if(!a || !b) return false;
    const v1=a.view, v2=b.view;
    const c1=a.crop, c2=b.crop;
    const eqV =
      Math.abs(v1.scale-v2.scale)<1e-6 &&
      Math.abs(v1.offX-v2.offX)<0.5 &&
      Math.abs(v1.offY-v2.offY)<0.5 &&
      (v1.rot===v2.rot) &&
      (v1.flipH===v2.flipH) &&
      (v1.flipV===v2.flipV);
    const eqC =
      Math.abs(c1.x-c2.x)<0.5 &&
      Math.abs(c1.y-c2.y)<0.5 &&
      Math.abs(c1.w-c2.w)<0.5 &&
      Math.abs(c1.h-c2.h)<0.5 &&
      a.cropOn===b.cropOn &&
      (!!a.HIRES === !!b.HIRES);
    return eqV && eqC;
  }
  function pushHistory(prev){
    if(!img) return;
    const last = history[history.length-1];
    if(last && sameSnap(last, prev)) return;
    history.push(prev);
    if(history.length > 80) history.shift();
    undoBtn.disabled = history.length === 0;
  }
  function clearHistory(){
    history.length = 0;
    undoBtn.disabled = true;
  }
  function applySnap(s){
    if(!s) return;
    Object.assign(view, s.view);
    cropOn = !!s.cropOn;
    Object.assign(crop, s.crop);
    if(typeof s.HIRES !== "undefined") setHiRes(!!s.HIRES);
    syncCropUI();
    redraw();
  }

  function setMsg(text, cls){
    msgEl.textContent = text || "";
    msgEl.className = "msg " + (cls || "");
  }
  function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }
  function stageRect(){ return stage.getBoundingClientRect(); }

  function syncHiResUI(){
    hiResBtn.textContent = HIRES ? t().hires_on : t().hires_off;
    hiResHintEl.textContent = t().hires_hint;
  }

  hiResBtn.addEventListener("click", ()=>{
    pushHistory(snap());
    setHiRes(!HIRES);
  });

  function hiResMult(){
    const s = Math.abs(view.scale || 1);
    const m = 1 / Math.max(1e-6, s);
    const maxMul = HIRES ? 16 : 8;
    return clamp(m, 1, maxMul);
  }

  function resizeCanvas(){
    const rect = stageRect();
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    cv.width = Math.round(rect.width * dpr);
    cv.height = Math.round(rect.height * dpr);
    cv.style.width = rect.width + "px";
    cv.style.height = rect.height + "px";
    ctx.setTransform(dpr,0,0,dpr,0,0);

    ensureCropDefault();
    syncCropBoxEl();
    redraw();
  }
  window.addEventListener("resize", resizeCanvas);

  function fitToStage(){
    if(!img) return;
    const rect = stageRect();
    const s = Math.min(rect.width / imgW, rect.height / imgH);
    view.scale = s;
    view.offX = 0;
    view.offY = 0;
    redraw();
  }
  function centerOnly(){
    if(!img) return;
    view.offX = 0;
    view.offY = 0;
    redraw();
  }

  function redraw(){
    const rect = stageRect();
    ctx.clearRect(0,0,rect.width,rect.height);
    if(!img){
      syncCropBoxEl();
      updateMeta();
      return;
    }

    ctx.save();
    ctx.translate(rect.width/2, rect.height/2);
    ctx.translate(view.offX, view.offY);
    ctx.rotate((view.rot * Math.PI) / 180);
    ctx.scale(view.scale * view.flipH, view.scale * view.flipV);
    ctx.drawImage(img, -imgW/2, -imgH/2, imgW, imgH);
    ctx.restore();

    syncCropBoxEl();
    updateMeta();
  }

  function updateMeta(){
    if(!img){
      $("meta").innerHTML = t().meta_idle;
      downloadBtn.disabled = true;
      resetAllBtn.disabled = true;
      cropToggleBtn.disabled = true;
      cropApplyBtn.disabled = true;
      loadImgBtn.disabled = false;
      clearHistory();
      return;
    }
    $("meta").innerHTML = t().meta_info(escapeHtml(imgName), imgW, imgH);
    downloadBtn.disabled = false;
    resetAllBtn.disabled = false;
    cropToggleBtn.disabled = false;
    cropApplyBtn.disabled = false;
    loadImgBtn.disabled = false;

    const mime = outFormatEl.value;
    const disableQ = (mime === "image/png");
    qualityEl.disabled = disableQ;
    qualityEl.style.opacity = disableQ ? ".6" : "1";

    undoBtn.disabled = history.length === 0;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  function zoomBy(factor, cx, cy){
    if(!img) return;
    const rect = stageRect();
    const x = (typeof cx === "number") ? cx : rect.width/2;
    const y = (typeof cy === "number") ? cy : rect.height/2;

    const px = x - rect.width/2;
    const py = y - rect.height/2;

    const beforeX = (px - view.offX) / view.scale;
    const beforeY = (py - view.offY) / view.scale;

    view.scale = clamp(view.scale * factor, 0.05, 20);

    view.offX = px - beforeX * view.scale;
    view.offY = py - beforeY * view.scale;

    redraw();
  }

  // ========= Crop helpers =========
  function ensureCropDefault(force){
    const rect = stageRect();
    if(force || !crop.w || !crop.h){
      const m = Math.max(22, Math.round(Math.min(rect.width, rect.height) * 0.10));
      crop.x = m;
      crop.y = m;
      crop.w = Math.max(CROP_MIN, rect.width - m*2);
      crop.h = Math.max(CROP_MIN, rect.height - m*2);
      clampCropToStage();
    }
  }
  function clampCropToStage(){
    const rect = stageRect();
    crop.w = clamp(crop.w, CROP_MIN, rect.width);
    crop.h = clamp(crop.h, CROP_MIN, rect.height);
    crop.x = clamp(crop.x, 0, rect.width - crop.w);
    crop.y = clamp(crop.y, 0, rect.height - crop.h);
  }

  function syncCropBoxEl(){
    cropOverlay.classList.toggle("show", !!(img && cropOn));
    if(!img) return;
    clampCropToStage();
    cropBoxEl.style.left = crop.x + "px";
    cropBoxEl.style.top = crop.y + "px";
    cropBoxEl.style.width = crop.w + "px";
    cropBoxEl.style.height = crop.h + "px";
  }

  function syncCropBtnText(){
    cropToggleBtn.textContent = cropOn ? t().crop_on : t().crop_off;
    cropApplyBtn.textContent = t().crop_apply;
  }
  function syncCropUI(){
    syncCropBtnText();
    syncCropBoxEl();
  }

  cropToggleBtn.addEventListener("click", ()=>{
    if(!img) return setMsg(t().msg_need, "err");
    pushHistory(snap());
    cropOn = !cropOn;
    syncCropUI();
    if(cropOn) setMsg(t().msg_crop_on, "");
    else setMsg("", "");
  });

  // âœ… í¬ë¡­: "í•¸ë“¤ ë¦¬ì‚¬ì´ì¦ˆë§Œ" í—ˆìš©
  let cropDrag = null;
  function hitHandle(target){
    const h = target && target.dataset && target.dataset.h;
    return h || null;
  }
  function startCropResize(startX, startY, handle){
    cropDrag = { handle, sx: startX, sy: startY, start: { ...crop } };
  }
  function applyCropResize(px, py){
    if(!cropDrag) return;
    const dx = px - cropDrag.sx;
    const dy = py - cropDrag.sy;
    const s = cropDrag.start;

    let x=s.x, y=s.y, w=s.w, h=s.h;

    const hd = cropDrag.handle;
    const left   = hd.includes("w");
    const right  = hd.includes("e");
    const top    = hd.includes("n");
    const bottom = hd.includes("s");

    if(left){ x = s.x + dx; w = s.w - dx; }
    if(right){ w = s.w + dx; }
    if(top){ y = s.y + dy; h = s.h - dy; }
    if(bottom){ h = s.h + dy; }

    if(w < CROP_MIN){
      const diff = CROP_MIN - w;
      w = CROP_MIN;
      if(left) x -= diff;
    }
    if(h < CROP_MIN){
      const diff = CROP_MIN - h;
      h = CROP_MIN;
      if(top) y -= diff;
    }

    crop.x = x; crop.y = y; crop.w = w; crop.h = h;
    clampCropToStage();
    syncCropBoxEl();
  }

  cropBoxEl.addEventListener("pointerdown", (e)=>{
    if(!img || !cropOn) return;
    const handle = hitHandle(e.target);
    if(!handle) return;

    e.preventDefault();
    e.stopPropagation();
    cropBoxEl.setPointerCapture(e.pointerId);

    pushHistory(snap());
    startCropResize(e.clientX, e.clientY, handle);
  });
  cropBoxEl.addEventListener("pointermove", (e)=>{
    if(!cropDrag) return;
    applyCropResize(e.clientX, e.clientY);
  });
  cropBoxEl.addEventListener("pointerup", ()=>{ cropDrag = null; });
  cropBoxEl.addEventListener("pointercancel", ()=>{ cropDrag = null; });

  // âœ… 1px ë¼ì¸ ë°©ì§€: ê°€ì¥ìë¦¬ 1px ë§ˆì§„ì„ ë‘ê³  í´ë¨í”„
  function clampSrcRect(sx, sy, sw, sh, srcW, srcH, margin=0){
    const m = Math.max(0, margin|0);
    sx = Math.max(m, Math.min(sx, srcW - 1 - m));
    sy = Math.max(m, Math.min(sy, srcH - 1 - m));
    sw = Math.max(1, Math.min(sw, (srcW - m) - sx));
    sh = Math.max(1, Math.min(sh, (srcH - m) - sy));
    return { sx, sy, sw, sh };
  }

  function renderStageToCanvas(mult, alpha=true){
    const rect = stageRect();
    const stageW = Math.round(rect.width);
    const stageH = Math.round(rect.height);

    const W = Math.max(1, Math.round(stageW * mult));
    const H = Math.max(1, Math.round(stageH * mult));
    const out = document.createElement("canvas");
    out.width = W;
    out.height = H;

    const octx = out.getContext("2d", { alpha });
    octx.setTransform(mult,0,0,mult,0,0);
    octx.clearRect(0,0,stageW,stageH);

    if(!img) return out;

    octx.save();
    octx.translate(stageW/2, stageH/2);
    octx.translate(view.offX, view.offY);
    octx.rotate((view.rot * Math.PI) / 180);
    octx.scale(view.scale * view.flipH, view.scale * view.flipV);
    octx.drawImage(img, -imgW/2, -imgH/2, imgW, imgH);
    octx.restore();

    return out;
  }

  async function applyCrop(){
    if(!img) throw new Error(t().msg_need);
    if(!cropOn){
      setMsg(t().msg_crop_on, "");
      return;
    }

    const mult = hiResMult();
    const stageCanvas = renderStageToCanvas(mult, true);

    let sx = Math.round(crop.x * mult);
    let sy = Math.round(crop.y * mult);
    let sw = Math.round(crop.w * mult);
    let sh = Math.round(crop.h * mult);

    // âœ… margin=1ë¡œ ê°€ì¥ìë¦¬ ìƒ˜í”Œë§ íšŒí”¼ (ë„ˆë¬´ ì•ˆìª½ìœ¼ë¡œ ì•ˆ ë“¤ì–´ê°€ê²Œ 1pxë§Œ)
    ({ sx, sy, sw, sh } = clampSrcRect(sx, sy, sw, sh, stageCanvas.width, stageCanvas.height, 1));

    const c = document.createElement("canvas");
    c.width = Math.max(1, sw);
    c.height = Math.max(1, sh);
    const cctx = c.getContext("2d", { alpha:true });
    cctx.imageSmoothingEnabled = true;
    cctx.imageSmoothingQuality = "high";
    cctx.clearRect(0,0,sw,sh);
    cctx.drawImage(stageCanvas, sx, sy, sw, sh, 0, 0, sw, sh);

    const dataUrl = c.toDataURL("image/png");
    const im = new Image();
    await new Promise((res, rej)=>{
      im.onload = res;
      im.onerror = ()=>rej(new Error("Crop failed"));
      im.src = dataUrl;
    });

    img = im;
    imgW = im.naturalWidth || 1;
    imgH = im.naturalHeight || 1;
    imgName = (imgName || "image").replace(/\.[^.]+$/, "") + "_crop.png";

    const rect = stageRect();
    const s = Math.min(rect.width / imgW, rect.height / imgH);
    Object.assign(initialView, { scale:s, offX:0, offY:0, rot:0, flipH:1, flipV:1 });
    Object.assign(view, initialView);

    cropOn = true;
    ensureCropDefault(true);

    clearHistory();
    redraw();
    updateMeta();
    setMsg(t().msg_crop_applied, "ok");
  }

  cropApplyBtn.addEventListener("click", async ()=>{
    try{
      if(!img) return setMsg(t().msg_need, "err");
      await applyCrop();
    }catch(e){
      setMsg((e && e.message) ? e.message : "Crop failed", "err");
    }
  });

  // ========= Controls wiring =========
  fitBtn.addEventListener("click", ()=>{
    if(!img) return setMsg(t().msg_need, "err");
    pushHistory(snap());
    fitToStage();
  });
  centerBtn.addEventListener("click", ()=>{
    if(!img) return setMsg(t().msg_need, "err");
    pushHistory(snap());
    centerOnly();
  });
  zoomInBtn.addEventListener("click", ()=>{
    if(!img) return setMsg(t().msg_need, "err");
    pushHistory(snap());
    zoomBy(1.08);
  });
  zoomOutBtn.addEventListener("click", ()=>{
    if(!img) return setMsg(t().msg_need, "err");
    pushHistory(snap());
    zoomBy(1/1.08);
  });

  rotLBtn.addEventListener("click", ()=>{
    if(!img) return setMsg(t().msg_need, "err");
    pushHistory(snap());
    view.rot = (view.rot - 90) % 360;
    redraw();
  });
  rotRBtn.addEventListener("click", ()=>{
    if(!img) return setMsg(t().msg_need, "err");
    pushHistory(snap());
    view.rot = (view.rot + 90) % 360;
    redraw();
  });

  flipHBtn.addEventListener("click", ()=>{
    if(!img) return setMsg(t().msg_need, "err");
    pushHistory(snap());
    view.flipH *= -1;
    redraw();
  });
  flipVBtn.addEventListener("click", ()=>{
    if(!img) return setMsg(t().msg_need, "err");
    pushHistory(snap());
    view.flipV *= -1;
    redraw();
  });

  undoBtn.addEventListener("click", ()=>{
    if(!img) return setMsg(t().msg_need, "err");
    if(history.length === 0){
      const rect = stageRect();
      const s = Math.min(rect.width / imgW, rect.height / imgH);
      Object.assign(initialView, { scale:s, offX:0, offY:0, rot:0, flipH:1, flipV:1 });
      Object.assign(view, initialView);
      ensureCropDefault(true);
      redraw();
      setMsg(t().msg_ready, "ok");
      return;
    }
    const prev = history.pop();
    applySnap(prev);
    undoBtn.disabled = history.length === 0;
  });

  // ========= pointer events (pan + pinch zoom) =========
  const pointers = new Map();
  let lastPan = null;
  let lastPinch = null;
  let gestureStart = null;

  stage.addEventListener("pointerdown", (e)=>{
    stage.setPointerCapture(e.pointerId);
    pointers.set(e.pointerId, { x:e.clientX, y:e.clientY });

    if(!img) return;

    if(pointers.size === 1){
      gestureStart = snap();
      lastPan = { x:e.clientX, y:e.clientY, offX:view.offX, offY:view.offY };
      lastPinch = null;
    } else if(pointers.size === 2){
      gestureStart = snap();
      const pts = Array.from(pointers.values());
      lastPinch = pinchState(pts[0], pts[1]);
      lastPan = null;
    }
  });

  stage.addEventListener("pointermove", (e)=>{
    if(!img) return;
    if(!pointers.has(e.pointerId)) return;

    pointers.set(e.pointerId, { x:e.clientX, y:e.clientY });

    if(pointers.size === 1 && lastPan){
      const dx = e.clientX - lastPan.x;
      const dy = e.clientY - lastPan.y;
      view.offX = lastPan.offX + dx;
      view.offY = lastPan.offY + dy;
      redraw();
      return;
    }

    if(pointers.size === 2 && lastPinch){
      const rect = stageRect();
      const pts = Array.from(pointers.values());
      const now = pinchState(pts[0], pts[1]);

      const factor = now.dist / (lastPinch.dist || now.dist);
      const cx = now.midX - rect.left;
      const cy = now.midY - rect.top;
      zoomBy(factor, cx, cy);

      lastPinch = now;
    }
  });

  stage.addEventListener("pointerup", (e)=>{
    pointers.delete(e.pointerId);

    if(!img) return;

    if(pointers.size === 0){
      if(gestureStart && !sameSnap(gestureStart, snap())){
        pushHistory(gestureStart);
      }
      gestureStart = null;
    }

    if(pointers.size === 1){
      const pts = Array.from(pointers.values());
      lastPan = { x:pts[0].x, y:pts[0].y, offX:view.offX, offY:view.offY };
      lastPinch = null;
    } else {
      lastPan = null;
      lastPinch = null;
    }
  });

  stage.addEventListener("pointercancel", ()=>{
    pointers.clear();
    lastPan = null;
    lastPinch = null;
    gestureStart = null;
  });

  function pinchState(a,b){
    const dx = a.x - b.x;
    const dy = a.y - b.y;
    const dist = Math.sqrt(dx*dx + dy*dy);
    return { dist, midX:(a.x+b.x)/2, midY:(a.y+b.y)/2 };
  }

  stage.addEventListener("wheel", (e)=>{
    if(!img) return;
    e.preventDefault();
    const rect = stageRect();
    const cx = e.clientX - rect.left;
    const cy = e.clientY - rect.top;
    const dir = (e.deltaY > 0) ? -1 : 1;
    const factor = dir > 0 ? 1.08 : 1/1.08;
    pushHistory(snap());
    zoomBy(factor, cx, cy);
  }, { passive:false });

  // ========= load image =========
  loadImgBtn.addEventListener("click", ()=>{
    pickInput.value = "";
    pickInput.click();
  });

  pickInput.addEventListener("change", (e)=>{
    const f = e.target.files && e.target.files[0];
    if(f) loadFile(f);
  });

  function applyLoadedImage(im, name){
    img = im;
    imgW = im.naturalWidth || 1;
    imgH = im.naturalHeight || 1;
    imgName = name || "image";

    const rect = stageRect();
    const s = Math.min(rect.width / imgW, rect.height / imgH);
    Object.assign(initialView, { scale:s, offX:0, offY:0, rot:0, flipH:1, flipV:1 });
    Object.assign(view, initialView);

    cropOn = true;
    ensureCropDefault(true);

    clearHistory();
    redraw();
    updateMeta();
    setMsg(t().msg_ready, "ok");
    resizeCanvas();
  }

  async function loadFile(file){
    const url = URL.createObjectURL(file);
    const im = new Image();
    im.onload = async ()=>{
      URL.revokeObjectURL(url);

      try{
        const key = `cf24_blob_${Date.now()}_${Math.random().toString(16).slice(2)}`;
        await idbPut(key, file);
        sessionStorage.setItem("cf24_edit_source", "idb");
        sessionStorage.setItem("cf24_edit_key", key);
        sessionStorage.setItem("cf24_edit_name", file.name || "image");
        sessionStorage.setItem("cf24_idphoto_source", "idb");
        sessionStorage.setItem("cf24_idphoto_key", key);
        sessionStorage.setItem("cf24_idphoto_name", file.name || "image");
      }catch(_){}

      applyLoadedImage(im, file.name || "image");
    };
    im.onerror = ()=>{
      URL.revokeObjectURL(url);
      setMsg(t().msg_need, "err");
    };
    im.src = url;
  }

  async function loadFromSession(){
    const src = sessionStorage.getItem("cf24_edit_source") || sessionStorage.getItem("cf24_idphoto_source");
    const key = sessionStorage.getItem("cf24_edit_key") || sessionStorage.getItem("cf24_idphoto_key");
    const name = sessionStorage.getItem("cf24_edit_name") || sessionStorage.getItem("cf24_idphoto_name") || "image";

    if(src === "idb" && key){
      try{
        const blob = await idbGet(key);
        if(blob){
          const url = URL.createObjectURL(blob);
          const im = new Image();
          im.onload = ()=>{
            URL.revokeObjectURL(url);
            applyLoadedImage(im, name);
          };
          im.onerror = ()=>{
            URL.revokeObjectURL(url);
            setMsg(t().msg_idb_fail, "err");
            updateMeta();
            resizeCanvas();
          };
          im.src = url;
          return;
        }
      }catch(_){}
    }

    setMsg(t().msg_need, "err");
    img = null;
    updateMeta();
    resizeCanvas();
  }

  // ========= download =========
  function downloadBlob(blob, filename){
    const a = document.createElement("a");
    const url = URL.createObjectURL(blob);
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1500);
  }

  function buildName(){
    const stamp = new Date().toISOString().replace(/[:.]/g,"-");
    const mime = outFormatEl.value;
    const ext = (mime === "image/png") ? "png" : (mime === "image/webp" ? "webp" : "jpg");
    const base = (imgName || "image").replace(/\.[^.]+$/, "");
    return `${base}_edit_${stamp}.${ext}`;
  }

  // âœ… FIX: bboxëŠ” stage ë°”ê¹¥ìœ¼ë¡œ ì ˆëŒ€ ë‚˜ê°€ì§€ ì•Šê²Œ "í´ë¨í”„"
  function computeTransformedBBox(stageW, stageH){
    const cx = stageW/2 + view.offX;
    const cy = stageH/2 + view.offY;

    const hx = imgW/2;
    const hy = imgH/2;

    const sx = view.scale * view.flipH;
    const sy = view.scale * view.flipV;

    const a = (view.rot * Math.PI) / 180;
    const cos = Math.cos(a);
    const sin = Math.sin(a);

    const pts = [
      {x:-hx, y:-hy},
      {x: hx, y:-hy},
      {x: hx, y: hy},
      {x:-hx, y: hy}
    ];

    let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;

    for(const p of pts){
      const x1 = p.x * sx;
      const y1 = p.y * sy;
      const xr = x1 * cos - y1 * sin;
      const yr = x1 * sin + y1 * cos;
      const xs = xr + cx;
      const ys = yr + cy;

      if(xs < minX) minX = xs;
      if(ys < minY) minY = ys;
      if(xs > maxX) maxX = xs;
      if(ys > maxY) maxY = ys;
    }

    // âœ… stage ì•ˆìœ¼ë¡œ ë”± ê³ ì • (ê²€ì€ ì—¬ë°± ë°©ì§€)
    minX = Math.max(0, Math.floor(minX));
    minY = Math.max(0, Math.floor(minY));
    maxX = Math.min(stageW, Math.ceil(maxX));
    maxY = Math.min(stageH, Math.ceil(maxY));

    // âœ… ì˜ˆì™¸ ë°©ì§€
    if(maxX <= minX){ minX = 0; maxX = stageW; }
    if(maxY <= minY){ minY = 0; maxY = stageH; }

    return { minX, minY, maxX, maxY };
  }

  function stageToOutputBlob(){
    if(!img) throw new Error(t().msg_need);

    const rect = stageRect();
    const stageW = Math.round(rect.width);
    const stageH = Math.round(rect.height);

    const bb = computeTransformedBBox(stageW, stageH);
    const bw = Math.max(1, bb.maxX - bb.minX);
    const bh = Math.max(1, bb.maxY - bb.minY);

    const outMime = outFormatEl.value;
    const q = parseFloat(qualityEl.value || "0.9");
    const alpha = (outMime !== "image/jpeg");

    const mult = hiResMult();
    const stageCanvas = renderStageToCanvas(mult, alpha);

    let sx = Math.round(bb.minX * mult);
    let sy = Math.round(bb.minY * mult);
    let sw = Math.round(bw * mult);
    let sh = Math.round(bh * mult);

    // âœ… exportë„ margin=1ë¡œ ê°€ì¥ìë¦¬ 1px íšŒí”¼
    ({ sx, sy, sw, sh } = clampSrcRect(sx, sy, sw, sh, stageCanvas.width, stageCanvas.height, 1));

    const base = document.createElement("canvas");
    base.width = sw;
    base.height = sh;
    const bctx = base.getContext("2d", { alpha });

    bctx.imageSmoothingEnabled = true;
    bctx.imageSmoothingQuality = "high";

    if(!alpha){
      bctx.fillStyle = "#ffffff";
      bctx.fillRect(0,0,sw,sh);
    } else {
      bctx.clearRect(0,0,sw,sh);
    }

    bctx.drawImage(stageCanvas, sx, sy, sw, sh, 0, 0, sw, sh);

    const wIn = parseInt(wEl.value, 10);
    const hIn = parseInt(hEl.value, 10);
    if(!wIn && !hIn){
      return new Promise((resolve, reject)=>{
        if(outMime === "image/png"){
          base.toBlob((b)=> b ? resolve(b) : reject(new Error("toBlob failed")), "image/png");
        } else if(outMime === "image/webp"){
          base.toBlob((b)=> b ? resolve(b) : reject(new Error("toBlob failed")), "image/webp", q);
        } else {
          base.toBlob((b)=> b ? resolve(b) : reject(new Error("toBlob failed")), "image/jpeg", q);
        }
      });
    }

    let targetW = sw;
    let targetH = sh;
    const keep = !!aspectLockEl.checked;
    const mode = (aspectModeEl.value || "contain");

    if(wIn && !hIn){
      targetW = Math.max(1, wIn);
      targetH = keep ? Math.max(1, Math.round(targetW * (sh / sw))) : targetH;
    } else if(!wIn && hIn){
      targetH = Math.max(1, hIn);
      targetW = keep ? Math.max(1, Math.round(targetH * (sw / sh))) : targetW;
    } else {
      targetW = Math.max(1, wIn);
      targetH = Math.max(1, hIn);

      if(keep && mode !== "stretch"){
        const s = (mode === "cover")
          ? Math.max(targetW / sw, targetH / sh)
          : Math.min(targetW / sw, targetH / sh);
        targetW = Math.max(1, Math.round(sw * s));
        targetH = Math.max(1, Math.round(sh * s));
      }
    }

    const out = document.createElement("canvas");
    out.width = targetW;
    out.height = targetH;
    const octx = out.getContext("2d", { alpha });
    octx.imageSmoothingEnabled = true;
    octx.imageSmoothingQuality = "high";

    if(!alpha){
      octx.fillStyle = "#ffffff";
      octx.fillRect(0,0,targetW,targetH);
    } else {
      octx.clearRect(0,0,targetW,targetH);
    }

    octx.drawImage(base, 0, 0, sw, sh, 0, 0, targetW, targetH);

    return new Promise((resolve, reject)=>{
      if(outMime === "image/png"){
        out.toBlob((b)=> b ? resolve(b) : reject(new Error("toBlob failed")), "image/png");
      } else if(outMime === "image/webp"){
        out.toBlob((b)=> b ? resolve(b) : reject(new Error("toBlob failed")), "image/webp", q);
      } else {
        out.toBlob((b)=> b ? resolve(b) : reject(new Error("toBlob failed")), "image/jpeg", q);
      }
    });
  }

  downloadBtn.addEventListener("click", async ()=>{
    try{
      const blob = await stageToOutputBlob();
      downloadBlob(blob, buildName());
      setMsg(t().msg_ok, "ok");
    }catch(e){
      setMsg((e && e.message) ? e.message : "Download failed", "err");
    }
  });

  resetAllBtn.addEventListener("click", ()=>{
    img = null;
    imgName = "image";
    imgW = imgH = 0;

    Object.assign(view, { scale:1, offX:0, offY:0, rot:0, flipH:1, flipV:1 });
    Object.assign(initialView, { scale:1, offX:0, offY:0, rot:0, flipH:1, flipV:1 });

    cropOn = true;
    Object.assign(crop, { x:0, y:0, w:0, h:0 });

    wEl.value = "";
    hEl.value = "";
    aspectLockEl.checked = true;
    aspectModeEl.value = "contain";

    clearHistory();
    try{
      sessionStorage.removeItem("cf24_edit_source");
      sessionStorage.removeItem("cf24_edit_key");
      sessionStorage.removeItem("cf24_edit_name");
    }catch(_){}

    setMsg("", "");
    redraw();
    updateMeta();
    resizeCanvas();
  });

  outFormatEl.addEventListener("change", updateMeta);

  // init
  $("langSelect").value = LANG;
  setLang(LANG);
  syncHiResUI();
  updateMeta();
  resizeCanvas();
  syncCropUI();
  loadFromSession();
})();
</script>
</body>
</html>